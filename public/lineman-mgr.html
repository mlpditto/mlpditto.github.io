<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE MAN Sales Recorder | Medlife</title>

    <!--
        LINE MAN Sales Recorder V7.0 (Redesign)
        - Collapsible Sections UI
        - Optimized Mobile Experience
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155',
                        lineman: '#00B14F' // LINE MAN Green
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vibrant-label {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 4px;
            margin-bottom: 6px;
            display: block;
            color: #475569;
            /* slate-600 */
        }

        .dark .vibrant-label {
            color: #cbd5e1;
            /* slate-300 */
        }

        .premium-input {
            width: 100%;
            padding: 1rem;
            border-radius: 1.25rem;
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            outline: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            color: #1e293b;
        }

        .dark .premium-input {
            background-color: rgba(30, 41, 59, 0.8);
            border-color: rgba(51, 65, 85, 0.8);
            color: #f8fafc;
        }

        .premium-input:focus {
            border-color: #00B14F;
            background-color: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 177, 79, 0.1);
        }

        .dark .premium-input:focus {
            background-color: #0f172a;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Redesign Specifics */
        .collapsible-section {
            border-radius: 1.5rem;
            background: #ffffff;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .dark .collapsible-section {
            background: #1e293b;
            border-color: #334155;
        }

        .section-header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            background: #f8fafc;
            border-bottom: 1px solid transparent;
        }

        .dark .section-header {
            background: #334155;
        }

        .section-header.active {
            border-bottom-color: #f1f5f9;
        }

        .dark .section-header.active {
            border-bottom-color: #475569;
        }

        .section-content {
            padding: 1.5rem;
            display: none;
        }

        .section-content.active {
            display: block;
        }

        .minimal-input {
            width: 100%;
            padding: 0.5rem 0;
            border-bottom: 2px solid #e2e8f0;
            background: transparent;
            outline: none;
            transition: border-color 0.2s;
            font-weight: 600;
        }

        .dark .minimal-input {
            border-bottom-color: #334155;
            color: #f8fafc;
        }

        .minimal-input:focus {
            border-bottom-color: #00B14F;
        }

        .minimal-table th {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .dark .minimal-table th {
            color: #94a3b8;
            border-bottom-color: #334155;
        }

        .badge-paid {
            background: #dcfce7;
            color: #15803d;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .dark .badge-paid {
            background: rgba(21, 128, 61, 0.2);
            color: #4ade80;
        }

        #editModal {
            z-index: 130 !important;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-darkBg text-slate-800 dark:text-slate-200 transition-colors duration-300 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 bg-white/80 dark:bg-black/80 z-[100] flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-lineman border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-lineman animate-pulse">กำลังโหลดระบบบันทึกยอดขาย...</p>
    </div>

    <!-- Login Check UI -->
    <div id="login-container" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center border border-white/20">
            <div class="w-20 h-20 bg-lineman/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-chart-line text-3xl text-lineman"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 tracking-tight">Access Required</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8">กรุณาเข้าสู่ระบบเพื่อบันทึกยอดขาย LINE MAN</p>
            <a href="admin.html"
                class="block w-full py-4 bg-lineman hover:bg-green-600 text-white rounded-2xl font-bold shadow-lg transition-all transform active:scale-95">
                <i class="fas fa-arrow-left mr-2"></i> ไปที่หน้า Admin
            </a>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="app-container" class="hidden p-4 md:p-8">
        <div class="max-w-full mx-auto space-y-6">

            <!-- Header -->
            <nav class="glass sticky top-4 z-50 rounded-3xl shadow-lg border border-white/20 p-4 mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <a href="admin.html"
                            class="w-12 h-12 rounded-2xl bg-white dark:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-lineman transition-all shadow-sm">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </a>
                        <div
                            class="w-12 h-12 rounded-2xl bg-lineman flex items-center justify-center text-white shadow-lg">
                            <i class="fas fa-store text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-black tracking-tight">LINE MAN <span
                                    class="text-lineman">Sales Recorder</span></h1>
                            <div
                                class="flex items-center gap-2 text-[10px] uppercase font-bold tracking-widest text-slate-400">
                                <span class="text-lineman">Platform Manager</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <button onclick="openRecordModal()"
                            class="w-12 h-12 rounded-2xl bg-lineman text-white flex items-center justify-center shadow-lg shadow-green-500/20 hover:scale-110 transition-all transform active:scale-95"
                            title="เพิ่มยอดขายใหม่">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="toggleTheme()"
                            class="w-12 h-12 rounded-2xl bg-white dark:bg-slate-800 text-slate-400 dark:text-yellow-400 flex items-center justify-center shadow-sm hover:scale-105 transition-all">
                            <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i>
                        </button>
                        <button onclick="logout()"
                            class="px-6 py-3 rounded-2xl bg-rose-50 dark:bg-rose-900/20 text-rose-500 font-bold hover:bg-rose-100 transition-all text-sm border border-rose-100 dark:border-rose-900/30">
                            LOGOUT
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Financial Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-lineman flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Gross / GP
                            (Month)</p>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-2xl font-black" id="summary-gross">฿0</span>
                            <span class="text-xs font-bold text-rose-500 mb-1" id="summary-gp">฿0</span>
                        </div>
                    </div>
                    <div
                        class="pt-3 border-t border-slate-100 dark:border-slate-800 flex justify-between text-[9px] font-bold text-slate-400">
                        <span>รายการเดือนนี้</span>
                        <span class="text-lineman" id="summary-gross-label">--</span>
                    </div>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-blue-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3">ยอดรับโอน (Net
                            Paid)</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] font-bold text-slate-400">เดือนนี้ (สุทธิ)</span>
                                <span class="text-xl font-black text-blue-600" id="stat-net-month">฿0</span>
                            </div>
                            <div
                                class="flex justify-between items-baseline border-t border-slate-50 dark:border-slate-800/50 pt-2">
                                <span class="text-[10px] font-black text-emerald-500 uppercase">กำไร (Profit)</span>
                                <span class="text-xl font-black text-emerald-600" id="summary-profit">฿0</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-[9px] text-blue-400 font-bold mt-2 uppercase">เฉพาะรายการโอนสำเร็จ</p>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-purple-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-purple-500 uppercase tracking-widest mb-3">จำนวนออเดอร์
                        </p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">วันนี้</p>
                                <p class="text-lg font-black text-purple-600" id="stat-count-today">0</p>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">เดือนนี้</p>
                                <p class="text-lg font-black text-slate-700 dark:text-slate-200" id="stat-count-month">0
                                </p>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">ปีนี้</p>
                                <p class="text-lg font-black text-slate-400" id="stat-count-year">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-amber-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-3">ระยะเวลาเฉลี่ย
                            (AVG)</p>
                        <div class="flex flex-col items-center justify-center py-1">
                            <span class="text-3xl font-black text-amber-600" id="stat-avg-time">--</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">เวลาเตรียมและจัดส่ง</span>
                        </div>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="stat-avg-progress" class="h-full bg-amber-400 transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Sales List Side -->
                <div class="w-full">
                    <div class="glass rounded-3xl shadow-xl overflow-hidden border border-white/20">
                        <div
                            class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-wrap justify-between items-center gap-4 bg-white/50 dark:bg-slate-800/50">
                            <div>
                                <h2 class="font-black text-lg flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-lineman/10 flex items-center justify-center"><i
                                            class="fas fa-history text-lineman text-sm"></i></div>
                                    ประวัติยอดขาย
                                </h2>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">
                                    Transaction History</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="month" id="monthFilter" onchange="renderUI()"
                                    class="text-xs p-2.5 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-lineman outline-none">
                                <button onclick="openImportModal()"
                                    class="px-4 py-2.5 rounded-xl bg-lineman/10 text-lineman font-bold hover:bg-lineman hover:text-white transition-all text-xs border border-lineman/20">
                                    <i class="fas fa-file-import mr-2"></i> IMPORT
                                </button>
                                <button onclick="openPayoutModal()"
                                    class="px-4 py-2.5 rounded-xl bg-emerald-50 text-emerald-600 font-bold hover:bg-emerald-600 hover:text-white transition-all text-xs border border-emerald-200">
                                    <i class="fas fa-receipt mr-2"></i> สรุปยอดโอน
                                </button>
                                <div
                                    class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-xl p-1 border border-slate-200 dark:border-slate-700">
                                    <button onclick="exportSalesCSV()"
                                        class="px-3 py-2 rounded-lg text-slate-500 hover:text-blue-500 hover:bg-white dark:hover:bg-slate-700 transition-all text-[10px] font-bold"
                                        title="Export CSV">
                                        CSV
                                    </button>
                                    <button onclick="exportBackupJSON()"
                                        class="px-3 py-2 rounded-lg text-slate-500 hover:text-amber-600 hover:bg-white dark:hover:bg-slate-700 transition-all text-[10px] font-bold"
                                        title="Backup JSON">
                                        JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="date-pagination"
                            class="px-6 py-3 bg-slate-50/50 dark:bg-slate-800/30 flex flex-wrap gap-2 border-b border-slate-100 dark:border-slate-700 items-center min-h-[60px]">
                            <!-- Date buttons will be rendered here -->
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse text-sm">
                                <thead
                                    class="bg-slate-100/50 dark:bg-slate-800/50 uppercase text-[10px] font-bold text-slate-500 tracking-widest">
                                    <tr>
                                        <th class="p-4 border-b dark:border-slate-700">วันที่ / Order</th>
                                        <th class="p-4 border-b dark:border-slate-700">ลูกค้า / รายการ</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-right">ยอดรวม (Gross)</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-right">ยอดจริง (Net)</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTable" class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <!-- Rendered Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <div id="importModal"
        class="fixed inset-0 bg-black/60 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass p-6 rounded-3xl shadow-2xl w-full max-w-2xl border border-white/20">
            <h3 class="text-xl font-black mb-2">นำเข้าข้อมูลจาก LINE MAN Report</h3>
            <p class="text-xs text-slate-500 mb-4">ลากไฟล์ CSV มาวาง หรือคัดลอกข้อมูลมาวางในช่องด้านล่างนี้</p>

            <!-- Drag & Drop Zone -->
            <div id="dropZone"
                class="w-full p-8 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-center mb-4 transition-all hover:bg-lineman/5 hover:border-lineman cursor-pointer group"
                onclick="document.getElementById('fileInput').click()" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)" ondrop="handleDropFile(event)">
                <i class="fas fa-file-csv text-4xl text-slate-300 group-hover:text-lineman mb-3 transition-colors"></i>
                <p class="text-sm font-bold text-slate-600 dark:text-slate-300">ลากไฟล์ CSV มาวางที่นี่
                    หรือคลิกเพื่อเลือกไฟล์</p>
                <p class="text-[10px] text-slate-400 mt-1">รองรับเฉพาะไฟล์ .csv จากระบบ LINE MAN</p>
                <input type="file" id="fileInput" class="hidden" accept=".csv" onchange="handleFileSelect(event)">
            </div>

            <div class="relative mb-4">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-200 dark:border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span
                        class="px-2 bg-white dark:bg-slate-900 text-[10px] text-gray-500 uppercase font-black tracking-widest">หรือ
                        วางข้อมูลที่นี่</span>
                </div>
            </div>

            <textarea id="csvInput" rows="5"
                class="w-full p-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 outline-none text-xs font-mono mb-4"
                placeholder="OrderID,OrderTime,SettlementTime,..."></textarea>

            <div class="flex gap-3">
                <button onclick="processCSV()"
                    class="flex-1 py-4 bg-lineman text-white rounded-2xl font-bold shadow-lg">เริ่มนำเข้าข้อมูล</button>
                <button onclick="closeImportModal()"
                    class="px-8 py-4 bg-slate-200 dark:bg-slate-700 rounded-2xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Sales Record Modal -->
    <div id="recordModal"
        class="fixed inset-0 bg-black/60 z-[115] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
        <div
            class="glass p-6 rounded-3xl shadow-2xl w-full max-w-xl border border-white/20 max-h-[95vh] overflow-y-auto no-scrollbar">
            <h2
                class="text-xl font-black mb-6 flex items-center gap-3 sticky top-0 bg-white/10 dark:bg-slate-900/10 backdrop-blur-md py-2 -mx-2 px-2 rounded-xl">
                <div class="w-10 h-10 rounded-xl bg-lineman/10 flex items-center justify-center">
                    <i class="fas fa-plus text-lineman text-lg"></i>
                </div>
                <span>บันทึกยอดขายใหม่</span>
                <span id="autosave-status"
                    class="ml-auto text-[9px] font-bold text-slate-400 opacity-0 transition-opacity uppercase tracking-widest">
                    <i class="fas fa-save mr-1"></i> Draft Saved
                </span>
                <button onclick="closeRecordModal()" class="ml-4 text-slate-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </h2>

            <form id="salesForm" class="space-y-4" novalidate>
                <!-- Section 1: รายละเอียดการสั่งซื้อ -->
                <div class="collapsible-section">
                    <div class="section-header active" onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-info-circle text-lineman"></i>
                            <span class="text-sm font-black uppercase tracking-wider">รายละเอียดการสั่งซื้อ</span>
                        </div>
                        <i
                            class="fas fa-chevron-down text-slate-300 transition-transform duration-300 transform rotate-180"></i>
                    </div>
                    <div class="section-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="vibrant-label">วันที่และเวลาสั่ง</label>
                                <div class="flex gap-2">
                                    <input type="date" id="recordDate" class="minimal-input flex-[1.5]">
                                    <div
                                        class="flex items-center gap-1 minimal-input flex-1 px-3 border-l border-slate-100 dark:border-slate-800">
                                        <input type="number" id="orderHH" min="0" max="23" placeholder="00"
                                            class="w-full bg-transparent text-center font-black outline-none"
                                            oninput="limitValue(this, 23)">
                                        <span class="font-bold">:</span>
                                        <input type="number" id="orderMM" min="0" max="59" placeholder="00"
                                            class="w-full bg-transparent text-center font-black outline-none"
                                            oninput="limitValue(this, 59)">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="vibrant-label">เลขออเดอร์ (เต็ม)</label>
                                <input type="text" id="orderIdFull"
                                    class="minimal-input font-bold text-lineman max-w-[180px]" placeholder="LME-XXXXXX"
                                    oninput="autoFillShortOrderId()">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="vibrant-label">4 หลักท้าย</label>
                                    <input type="text" id="orderId" maxlength="4"
                                        class="minimal-input text-center text-lg font-black tracking-widest"
                                        placeholder="0001">
                                </div>
                                <div>
                                    <label class="vibrant-label">เบอร์โทร</label>
                                    <input type="tel" id="customerPhone" class="minimal-input"
                                        placeholder="0xx-xxx-xxxx">
                                </div>
                            </div>
                            <div>
                                <label class="vibrant-label">ชื่อลูกค้า</label>
                                <input type="text" id="customerName" class="minimal-input" placeholder="ระบุชื่อลูกค้า">
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-slate-50 dark:border-slate-800">
                            <label class="vibrant-label">วันที่และเวลารับสินค้า (Received)</label>
                            <div class="flex gap-2">
                                <input type="date" id="receivedDate" class="minimal-input flex-[1.5]">
                                <div
                                    class="flex items-center gap-1 minimal-input flex-1 px-3 border-l border-slate-100 dark:border-slate-800 bg-blue-50/10 rounded-lg">
                                    <input type="number" id="receivedHH" min="0" max="23" placeholder="00"
                                        class="w-full bg-transparent text-center font-bold outline-none"
                                        oninput="limitValue(this, 23)">
                                    <span class="font-bold">:</span>
                                    <input type="number" id="receivedMM" min="0" max="59" placeholder="00"
                                        class="w-full bg-transparent text-center font-bold outline-none"
                                        oninput="limitValue(this, 59)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: รายการสินค้า -->
                <div class="collapsible-section">
                    <div class="section-header active" onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shopping-basket text-lineman"></i>
                            <span class="text-sm font-black uppercase tracking-wider">รายการสินค้า</span>
                        </div>
                        <i
                            class="fas fa-chevron-down text-slate-300 transition-transform duration-300 transform rotate-180"></i>
                    </div>
                    <div class="section-content active">
                        <div class="flex justify-between items-center mb-4">
                            <button type="button" onclick="smartImport('items-container')"
                                class="text-[10px] font-black text-blue-500 border border-blue-100 dark:border-blue-900/30 px-3 py-1.5 rounded-xl hover:bg-blue-50 transition-all">
                                <i class="fas fa-magic mr-1"></i> SMART PASTE
                            </button>
                            <button type="button" onclick="addItemRow({name:'', qty:1, price:0}, 'items-container')"
                                class="bg-lineman text-white text-[10px] font-black px-4 py-2 rounded-xl shadow-lg shadow-green-500/20 hover:scale-105 active:scale-95 transition-all">
                                <i class="fas fa-plus mr-1"></i> เพิ่มแถว
                            </button>
                        </div>

                        <table class="w-full minimal-table">
                            <thead>
                                <tr>
                                    <th class="text-left">สินค้า</th>
                                    <th class="w-16 text-center">จำนวน</th>
                                    <th class="w-24 text-right">かかく ราคา</th>
                                    <th class="w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="items-container"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 3: การชำระเงิน -->
                <div class="collapsible-section">
                    <div class="section-header active" onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-receipt text-amber-500"></i>
                            <span class="text-sm font-black uppercase tracking-wider">支払い การชำระเงิน</span>
                        </div>
                        <i
                            class="fas fa-chevron-down text-slate-300 transition-transform duration-300 transform rotate-180"></i>
                    </div>
                    <div class="section-content active">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div
                                class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                                <span class="vibrant-label !mb-1">ยอดรวม (Gross)</span>
                                <input type="number" id="grossAmount" readonly
                                    class="w-full bg-transparent text-xl font-black text-slate-500 outline-none">
                            </div>
                            <div class="p-4 bg-lineman/10 dark:bg-lineman/20 rounded-2xl border border-lineman/30">
                                <span class="vibrant-label !mb-1 !text-lineman">ยอดรับสุทธิ (NET)</span>
                                <div id="calc-net" class="text-2xl font-black text-lineman drop-shadow-sm">฿0.00</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="p-4 bg-rose-50 dark:bg-rose-900/10 rounded-2xl border border-rose-200/50">
                                <span class="vibrant-label !mb-1 !text-rose-600">ต้นทุน (COST)</span>
                                <input type="number" id="orderCost" step="0.01" oninput="calculateNet()"
                                    class="w-full bg-transparent text-xl font-black text-rose-600 outline-none"
                                    placeholder="0.00">
                            </div>
                            <div id="profit-box"
                                class="p-4 bg-emerald-50 dark:bg-emerald-900/10 rounded-2xl border border-emerald-200/50">
                                <span class="vibrant-label !mb-1 !text-emerald-600">กำไร (PROFIT)</span>
                                <div id="calc-profit" class="text-xl font-black text-emerald-600 italic">฿0.00 (0%)
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-3 mb-6">
                            <label
                                class="flex items-center gap-3 p-3 px-4 bg-slate-100 dark:bg-slate-800 rounded-2xl cursor-pointer hover:bg-slate-200 transition-all border border-transparent has-[:checked]:border-rose-500/50 has-[:checked]:bg-rose-50/50">
                                <input type="checkbox" id="isNoFee" onchange="calculateNet()"
                                    class="w-5 h-5 rounded-lg border-2 border-slate-300 text-rose-600 focus:ring-rose-500">
                                <span class="text-[11px] font-black uppercase tracking-tighter"><i
                                        class="fas fa-bolt text-rose-500 mr-1"></i> NO FEE</span>
                            </label>

                            <label
                                class="flex items-center gap-3 p-3 px-4 bg-slate-100 dark:bg-slate-800 rounded-2xl cursor-pointer hover:bg-slate-200 transition-all border border-transparent has-[:checked]:border-blue-500/50 has-[:checked]:bg-blue-50/50">
                                <input type="checkbox" id="isManualNet" onchange="toggleManualNet()"
                                    class="w-5 h-5 rounded-lg border-2 border-slate-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-[11px] font-black uppercase tracking-tighter"><i
                                        class="fas fa-pencil text-blue-500 mr-1"></i> MANUAL NET</span>
                            </label>
                        </div>

                        <div id="manual-net-box"
                            class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border-2 border-blue-500/20">
                            <label class="vibrant-label !text-blue-700">ระบุยอดรับสุทธิด้วยตัวเอง</label>
                            <div class="relative">
                                <input type="number" id="manualNet" step="0.01" oninput="calculateNet()"
                                    class="w-full bg-transparent text-3xl font-black text-blue-800 dark:text-blue-300 outline-none pl-8"
                                    placeholder="0.00">
                                <span class="absolute left-0 top-1 text-2xl font-bold text-blue-400">฿</span>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="vibrant-label !mb-0">สถานะการโอนเงิน</label>
                                <label class="cursor-pointer">
                                    <input type="checkbox" id="isPaid" onchange="togglePaidSection('add')"
                                        class="hidden">
                                    <div id="add-paid-status-visual"
                                        class="badge-paid !bg-slate-100 !text-slate-400 !border !border-slate-200 grayscale opacity-50 transition-all">
                                        <i class="fas fa-clock"></i> UNPAID
                                    </div>
                                </label>
                            </div>

                            <div id="paid-details-add"
                                class="hidden space-y-4 animate-in fade-in zoom-in-95 duration-200 bg-emerald-50/20 dark:bg-emerald-900/10 p-4 rounded-2xl border border-emerald-500/10">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="text-[9px] uppercase font-black text-emerald-600 mb-1 block ml-1">วันที่รับโอน</label>
                                        <input type="date" id="paidDate"
                                            class="minimal-input !border-emerald-200 dark:!border-emerald-900/40 text-sm font-bold">
                                    </div>
                                    <div>
                                        <label
                                            class="text-[9px] uppercase font-black text-emerald-600 mb-1 block ml-1">เวลารับโอน</label>
                                        <div
                                            class="flex items-center gap-2 minimal-input !border-emerald-200 dark:!border-emerald-900/40">
                                            <input type="number" id="transferHH" min="0" max="23" placeholder="00"
                                                class="w-full bg-transparent text-center font-black outline-none"
                                                oninput="limitValue(this, 23)">
                                            <span class="font-bold text-emerald-200 text-sm">:</span>
                                            <input type="number" id="transferMM" min="0" max="59" placeholder="00"
                                                class="w-full bg-transparent text-center font-black outline-none"
                                                oninput="limitValue(this, 59)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-slate-50 dark:border-slate-800">
                            <label class="vibrant-label">รายละเอียด / หมายเหตุเพิ่มเติม</label>
                            <textarea id="notes" rows="2" class="minimal-input text-xs font-medium italic"
                                placeholder="ระบุเมนูพิเศษ หรือบันทึกช่วยจำ..."></textarea>
                        </div>
                    </div>
                </div>

                <div
                    class="flex gap-4 pt-4 sticky bottom-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md pb-2 -mx-2 px-2">
                    <button type="submit" id="submitBtn"
                        class="flex-1 py-4 bg-lineman text-white rounded-2xl text-lg font-black shadow-xl shadow-green-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-check-circle text-xl"></i> บันทึกยอดขาย
                    </button>
                    <button type="button" onclick="closeRecordModal()"
                        class="px-8 py-4 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold active:scale-[0.98] transition-all text-slate-500 text-sm">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal (Redesigned with Collapsible Sections) -->
    <div id="editModal"
        class="fixed inset-0 bg-black/70 z-[120] hidden flex items-center justify-center p-4 backdrop-blur-md transition-all duration-300">
        <div
            class="glass rounded-[2.5rem] shadow-2xl w-full max-w-2xl border border-white/20 max-h-[90vh] flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500">
                        <i class="fas fa-edit text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black">แก้ไขยอดขาย</h3>
                        <p class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Transaction ID: <span
                                id="e-uid-label">---</span></p>
                    </div>
                </div>
                <button onclick="closeEditModal()"
                    class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center text-slate-400 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                <form id="editForm" class="space-y-4" novalidate>
                    <!-- Section 1: รายละเอียดการสั่งซื้อ -->
                    <div class="collapsible-section">
                        <div class="section-header active" onclick="toggleSection(this)">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-info-circle text-blue-500"></i>
                                <span class="text-sm font-black uppercase tracking-wider">รายละเอียดการสั่งซื้อ</span>
                            </div>
                            <i
                                class="fas fa-chevron-down text-slate-300 transition-transform duration-300 transform rotate-180"></i>
                        </div>
                        <div class="section-content active">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="vibrant-label">วันที่และเวลาสั่ง</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="e-recordDate" class="minimal-input flex-[1.5]">
                                        <div
                                            class="flex items-center gap-1 minimal-input flex-1 px-3 border-l border-slate-100 dark:border-slate-800">
                                            <input type="number" id="e-orderHH" min="0" max="23" placeholder="00"
                                                class="w-full bg-transparent text-center font-black outline-none"
                                                oninput="limitValue(this, 23)">
                                            <span class="font-bold">:</span>
                                            <input type="number" id="e-orderMM" min="0" max="59" placeholder="00"
                                                class="w-full bg-transparent text-center font-black outline-none"
                                                oninput="limitValue(this, 59)">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="vibrant-label">เลขออเดอร์ (เต็ม)</label>
                                    <input type="text" id="e-orderIdFull"
                                        class="minimal-input font-bold text-blue-600 dark:text-blue-400 max-w-[180px]"
                                        placeholder="LME-XXXXXX" oninput="autoFillShortOrderIdPopup()">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="vibrant-label">4 หลักท้าย</label>
                                        <input type="text" id="e-orderId" maxlength="4"
                                            class="minimal-input text-center text-lg font-black tracking-widest">
                                    </div>
                                    <div>
                                        <label class="vibrant-label">เบอร์โทร</label>
                                        <input type="tel" id="e-customerPhone" class="minimal-input"
                                            placeholder="0xx-xxx-xxxx">
                                    </div>
                                </div>
                                <div>
                                    <label class="vibrant-label">ชื่อลูกค้า</label>
                                    <input type="text" id="e-customerName" class="minimal-input"
                                        placeholder="ระบุชื่อลูกค้า">
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-slate-50 dark:border-slate-800">
                                <label class="vibrant-label">วันที่และเวลารับสินค้า (Received)</label>
                                <div class="flex gap-2">
                                    <input type="date" id="e-receivedDate" class="minimal-input flex-[1.5]">
                                    <div
                                        class="flex items-center gap-1 minimal-input flex-1 px-3 border-l border-slate-100 dark:border-slate-800 bg-blue-50/10 rounded-lg">
                                        <input type="number" id="e-receivedHH" min="0" max="23" placeholder="00"
                                            class="w-full bg-transparent text-center font-bold outline-none"
                                            oninput="limitValue(this, 23)">
                                        <span class="font-bold">:</span>
                                        <input type="number" id="e-receivedMM" min="0" max="59" placeholder="00"
                                            class="w-full bg-transparent text-center font-bold outline-none"
                                            oninput="limitValue(this, 59)">
                                    </div>
                                </div>
                                <p class="text-[9px] text-slate-400 font-bold uppercase mt-2 italic">*
                                    ใช้เพื่อคำนวณเวลาการเตรียมและจัดส่ง</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: รายการสินค้า -->
                    <div class="collapsible-section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-shopping-basket text-lineman"></i>
                                <span class="text-sm font-black uppercase tracking-wider">รายการสินค้า</span>
                                <span id="e-item-count-badge"
                                    class="bg-slate-200 dark:bg-slate-700 text-[10px] px-2 py-0.5 rounded-full font-black">0</span>
                            </div>
                            <i class="fas fa-chevron-down text-slate-300 transition-transform duration-300"></i>
                        </div>
                        <div class="section-content">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex gap-2">
                                    <button type="button" onclick="smartImport('e-items-container')"
                                        class="text-[10px] font-black text-blue-500 border border-blue-100 dark:border-blue-900/30 px-3 py-1.5 rounded-xl hover:bg-blue-50 transition-all">
                                        <i class="fas fa-magic mr-1"></i> SMART PASTE
                                    </button>
                                </div>
                                <button type="button"
                                    onclick="addItemRow({name:'', qty:1, price:0}, 'e-items-container')"
                                    class="bg-lineman text-white text-[10px] font-black px-4 py-2 rounded-xl shadow-lg shadow-green-500/20 hover:scale-105 active:scale-95 transition-all">
                                    <i class="fas fa-plus mr-1"></i> เพิ่มแถว
                                </button>
                            </div>

                            <table class="w-full minimal-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">สินค้า</th>
                                        <th class="w-16 text-center">จำนวน</th>
                                        <th class="w-24 text-right">かかく ราคา</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody id="e-items-container">
                                    <!-- Rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Section 3: การชำระเงิน -->
                    <div class="collapsible-section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-receipt text-amber-500"></i>
                                <span class="text-sm font-black uppercase tracking-wider">支払い การชำระเงิน</span>
                            </div>
                            <i class="fas fa-chevron-down text-slate-300 transition-transform duration-300"></i>
                        </div>
                        <div class="section-content">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div
                                    class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800">
                                    <span class="vibrant-label !mb-1">ยอดรวม (Gross)</span>
                                    <input type="number" id="e-grossAmount" readonly
                                        class="w-full bg-transparent text-xl font-black text-slate-500 outline-none">
                                </div>
                                <div
                                    class="p-4 bg-blue-50/30 dark:bg-blue-900/10 rounded-2xl border border-blue-100 dark:border-blue-900/30">
                                    <span class="vibrant-label !mb-1 !text-blue-600">ยอดรับสุทธิ (NET)</span>
                                    <div id="e-calc-net"
                                        class="text-2xl font-black text-blue-900 dark:text-blue-300 drop-shadow-sm">
                                        ฿0.00</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="p-4 bg-rose-50 dark:bg-rose-900/10 rounded-2xl border border-rose-200/50">
                                    <span class="vibrant-label !mb-1 !text-rose-600">ต้นทุน (COST)</span>
                                    <input type="number" id="e-orderCost" step="0.01" oninput="calculateNetPopup()"
                                        class="w-full bg-transparent text-xl font-black text-rose-600 outline-none"
                                        placeholder="0.00">
                                </div>
                                <div id="e-profit-box"
                                    class="p-4 bg-emerald-50 dark:bg-emerald-900/10 rounded-2xl border border-emerald-200/50">
                                    <span class="vibrant-label !mb-1 !text-emerald-600">กำไร (PROFIT)</span>
                                    <div id="e-calc-profit" class="text-xl font-black text-emerald-600 italic">฿0.00
                                        (0%)</div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3 mb-6">
                                <label
                                    class="flex items-center gap-3 p-3 px-4 bg-slate-100 dark:bg-slate-800 rounded-2xl cursor-pointer hover:bg-slate-200 transition-all border border-transparent has-[:checked]:border-rose-500/50 has-[:checked]:bg-rose-50/50">
                                    <input type="checkbox" id="e-isNoFee" onchange="calculateNetPopup()"
                                        class="w-5 h-5 rounded-lg border-2 border-slate-300 text-rose-600 focus:ring-rose-500">
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[11px] font-black uppercase tracking-tighter flex items-center gap-2 m-0 p-0 transform -translate-y-0.5">
                                            <i class="fas fa-bolt text-rose-500"></i> NO FEE (0%)
                                        </span>
                                    </div>
                                </label>

                                <label
                                    class="flex items-center gap-3 p-3 px-4 bg-slate-100 dark:bg-slate-800 rounded-2xl cursor-pointer hover:bg-slate-200 transition-all border border-transparent has-[:checked]:border-blue-500/50 has-[:checked]:bg-blue-50/50">
                                    <input type="checkbox" id="e-isManualNet" onchange="toggleManualNet('edit')"
                                        class="w-5 h-5 rounded-lg border-2 border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <div class="flex flex-col">
                                        <span
                                            class="text-[11px] font-black uppercase tracking-tighter flex items-center gap-2 m-0 p-0 transform -translate-y-0.5">
                                            <i class="fas fa-pencil text-blue-500"></i> MANUAL NET
                                        </span>
                                    </div>
                                </label>
                            </div>

                            <div id="e-manual-net-box"
                                class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border-2 border-blue-500/20">
                                <label class="vibrant-label !text-blue-700">ระบุยอดรับสุทธิด้วยตัวเอง</label>
                                <div class="relative">
                                    <input type="number" id="e-manualNet" step="0.01" oninput="calculateNetPopup()"
                                        class="w-full bg-transparent text-3xl font-black text-blue-800 dark:text-blue-300 outline-none pl-8"
                                        placeholder="0.00">
                                    <span class="absolute left-0 top-1 text-2xl font-bold text-blue-400">฿</span>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="vibrant-label !mb-0">สถานะการโอนเงิน</label>
                                    <label id="e-paid-badge-container" class="cursor-pointer">
                                        <input type="checkbox" id="e-isPaid" onchange="togglePaidSection('edit')"
                                            class="hidden">
                                        <div id="e-paid-status-visual"
                                            class="badge-paid !bg-slate-100 !text-slate-400 !border !border-slate-200 grayscale opacity-50 transition-all">
                                            <i class="fas fa-clock"></i> UNPAID
                                        </div>
                                    </label>
                                </div>

                                <div id="paid-details-edit"
                                    class="hidden space-y-4 animate-in fade-in zoom-in-95 duration-200 bg-emerald-50/20 dark:bg-emerald-900/10 p-4 rounded-2xl border border-emerald-500/10">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="text-[9px] uppercase font-black text-emerald-600 mb-1 block ml-1">วันที่รับโอน</label>
                                            <input type="date" id="e-paidDate"
                                                class="minimal-input !border-emerald-200 dark:!border-emerald-900/40 text-sm font-bold">
                                        </div>
                                        <div>
                                            <label
                                                class="text-[9px] uppercase font-black text-emerald-600 mb-1 block ml-1">เวลารับโอน</label>
                                            <div
                                                class="flex items-center gap-2 minimal-input !border-emerald-200 dark:!border-emerald-900/40">
                                                <input type="number" id="e-transferHH" min="0" max="23" placeholder="00"
                                                    class="w-full bg-transparent text-center font-black outline-none"
                                                    oninput="limitValue(this, 23)">
                                                <span class="font-bold text-emerald-200 text-sm">:</span>
                                                <input type="number" id="e-transferMM" min="0" max="59" placeholder="00"
                                                    class="w-full bg-transparent text-center font-black outline-none"
                                                    oninput="limitValue(this, 59)">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-slate-50 dark:border-slate-800">
                                <label class="vibrant-label">รายละเอียด / หมายเหตุเพิ่มเติม</label>
                                <textarea id="e-notes" rows="2" class="minimal-input text-xs font-medium italic"
                                    placeholder="ระบุบันทึกเพิ่มเติม..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex gap-4 pt-4 sticky bottom-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md pb-2 -mx-2 px-2">
                        <button type="submit"
                            class="flex-1 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-blue-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                            <i class="fas fa-save text-xl"></i> บันทึกการแก้ไข
                        </button>
                        <button type="button" onclick="closeEditModal()"
                            class="px-8 py-4 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold active:scale-[0.98] transition-all text-slate-500 text-sm">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Master Product Modal -->
        <div id="masterModal"
            class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
            <div
                class="bg-white dark:bg-slate-800 p-6 rounded-2xl w-full max-w-md shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
                <h3 class="text-lg font-black text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-boxes text-blue-500"></i> จัดการสินค้า (Master)
                </h3>
                <input type="hidden" id="m-originalName">
                <div class="space-y-4 overflow-y-auto pr-1">
                    <div>
                        <label class="vibrant-label">ชื่อสินค้า</label>
                        <input type="text" id="m-name" class="minimal-input font-bold" placeholder="ชื่อสินค้า">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label class="vibrant-label !text-rose-500">ราคาทุน (Cost)</label>
                            <input type="number" id="m-cost" class="minimal-input" placeholder="0.00">
                        </div>
                        <div>
                            <label class="vibrant-label !text-blue-500">ราคาขาย (LINE MAN)</label>
                            <input type="number" id="m-price" class="minimal-input" placeholder="0.00">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label class="vibrant-label !text-emerald-600">ราคาปลีก (Retail)</label>
                            <input type="number" id="m-retail" class="minimal-input" placeholder="0.00">
                        </div>
                        <div>
                            <label class="vibrant-label !text-purple-600">ราคาส่ง (Wholesale)</label>
                            <input type="number" id="m-wholesale" class="minimal-input" placeholder="0.00">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="vibrant-label">หน่วยสินค้า</label>
                        <input type="text" id="m-unit" class="minimal-input" placeholder="เช่น กล่อง">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="vibrant-label">Company Code</label>
                            <input type="text" id="m-companyCode" class="minimal-input" placeholder="รหัสบริษัท">
                        </div>
                        <div>
                            <label class="vibrant-label">MLP Code</label>
                            <input type="text" id="m-mlpCode" class="minimal-input" placeholder="รหัสภายใน">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button onclick="saveMasterEdit()"
                        class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all">บันทึก</button>
                    <button onclick="document.getElementById('masterModal').classList.add('hidden')"
                        class="px-6 py-3 bg-gray-100 dark:bg-slate-700 text-gray-500 rounded-xl font-bold hover:bg-gray-200 transition-all">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payout History Modal -->
    <div id="payoutModal"
        class="fixed inset-0 bg-black/60 z-[120] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-gray-50 dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl h-[85vh] flex flex-col overflow-hidden border border-white/20">
            <!-- Header -->
            <div class="bg-white dark:bg-slate-800 p-5 shadow-sm z-10 flex justify-between items-center relative">
                <div>
                    <h3 class="font-black text-lg text-slate-800 dark:text-white flex items-center gap-2">
                        <i class="fas fa-donate text-emerald-500"></i> ประวัติยอดเงินเข้า
                    </h3>
                    <p class="text-[10px] text-slate-400 mt-1">สรุปยอดโอนตามวันที่ได้รับเงินจริง</p>
                </div>
                <button onclick="document.getElementById('payoutModal').classList.add('hidden')"
                    class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 flex items-center justify-center hover:bg-rose-100 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Filter -->
            <div class="p-4 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700">
                <div class="relative">
                    <input type="month" id="payoutMonthFilter" onchange="renderPayoutUI()"
                        class="w-full bg-slate-100 dark:bg-slate-900 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-600 dark:text-slate-300 outline-none">
                </div>
            </div>

            <!-- List Content -->
            <div id="payout-list-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Items here -->
            </div>

            <!-- Footer Summary -->
            <div class="bg-white dark:bg-slate-800 p-4 border-t border-slate-100 dark:border-slate-700 safe-pb">
                <div class="flex justify-between items-end">
                    <span class="text-xs font-bold text-slate-400 uppercase">ยอดรวมเดือนนี้</span>
                    <span id="payout-total-month" class="text-2xl font-black text-emerald-600">฿0.00</span>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let salesData = [];
        let masterProducts = [];
        let currentUser = null;
        let editIndex = null;
        let editingUid = null;
        let currentSelectedDate = null; // null means "All" or "Default to Today"
        const GP_RATE = 0.30; // GP 30% รวม VAT

        function togglePaidSection(mode) {
            const isPaidField = document.getElementById(mode === 'add' ? 'isPaid' : 'e-isPaid');
            const isPaid = isPaidField.checked;
            const container = document.getElementById(mode === 'add' ? 'paid-details-add' : 'paid-details-edit');

            // UI Update for Badge
            const statusVisual = document.getElementById(mode === 'add' ? 'add-paid-status-visual' : 'e-paid-status-visual');
            if (isPaid) {
                statusVisual.classList.remove('grayscale', 'opacity-50', '!bg-slate-100', '!text-slate-400', '!border-slate-200');
                statusVisual.classList.add('badge-paid');
                statusVisual.innerHTML = '<i class="fas fa-check-circle"></i> PAID';
            } else {
                statusVisual.classList.remove('badge-paid');
                statusVisual.classList.add('grayscale', 'opacity-50', '!bg-slate-100', '!text-slate-400', '!border-slate-200');
                statusVisual.innerHTML = '<i class="fas fa-clock"></i> UNPAID';
            }

            if (isPaid) {
                container.classList.remove('hidden');
                // Set default now if empty
                const dateField = document.getElementById(mode === 'add' ? 'paidDate' : 'e-paidDate');
                if (!dateField.value) {
                    const now = new Date();
                    dateField.value = now.toISOString().split('T')[0];
                    document.getElementById(mode === 'add' ? 'transferHH' : 'e-transferHH').value = now.getHours().toString().padStart(2, '0');
                    document.getElementById(mode === 'add' ? 'transferMM' : 'e-transferMM').value = now.getMinutes().toString().padStart(2, '0');
                }
            } else {
                container.classList.add('hidden');
            }
        }

        function toggleSection(header) {
            const section = header.parentElement;
            const content = header.nextElementSibling;
            const icon = header.querySelector('.fa-chevron-down');

            header.classList.toggle('active');
            content.classList.toggle('active');

            if (content.classList.contains('active')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function limitValue(el, max) {
            if (el.value.length > 2) el.value = el.value.slice(0, 2);
            if (parseInt(el.value) > max) el.value = max;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDefaults();
            checkAuth();
            loadDraft();
            setupAutosave();
        });

        async function syncMasterData() {
            try {
                const snapshot = await window.db.collection('master_products').get();
                masterProducts = snapshot.docs.map(doc => ({ name: doc.id, ...doc.data() }));
                updateDatalist();
            } catch (err) { console.error("Master Sync Error", err); }
        }

        function updateDatalist() {
            let dl = document.getElementById('master-list');
            if (!dl) {
                dl = document.createElement('datalist');
                dl.id = 'master-list';
                document.body.appendChild(dl);
            }
            dl.innerHTML = masterProducts.map(p => `<option value="${p.name}">`).join('');
        }

        function autoFillShortOrderId() {
            const full = document.getElementById('orderIdFull').value.trim();
            if (full.length >= 4) {
                document.getElementById('orderId').value = full.slice(-4).toUpperCase();
            }
        }

        function autoFillShortOrderIdPopup() {
            const full = document.getElementById('e-orderIdFull').value.trim();
            if (full.length >= 4) {
                document.getElementById('e-orderId').value = full.slice(-4).toUpperCase();
            }
        }

        function toggleManualNet(mode = 'add') {
            const pref = mode === 'edit' ? 'e-' : '';
            const isManual = document.getElementById(`${pref}isManualNet`).checked;
            const box = document.getElementById(`${pref}manual-net-box`);
            if (box) box.classList.toggle('hidden', !isManual);

            if (mode === 'edit') calculateNetPopup();
            else calculateNet();
        }

        function addItemRow(item = { name: '', qty: 1, price: 0 }, containerId = 'items-container') {
            const container = document.getElementById(containerId);
            const index = container.children.length;
            const row = document.createElement('tr');
            row.className = "group hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors";

            const isEdit = containerId.startsWith('e-');
            const inputClass = isEdit ? "minimal-input !text-xs !py-2" : "premium-input !py-3 !text-sm !rounded-xl";

            row.innerHTML = `
                <td class="p-2 relative">
                    <input type="text" value="${item.name}" placeholder="ชื่อสินค้า" class="${inputClass} pr-8" list="master-list" oninput="handleItemChange(this, '${containerId}')">
                    <button type="button" onclick="openMasterEdit(this.previousElementSibling.value)" tabindex="-1" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-300 hover:text-blue-500 transition-colors">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </td>
                <td class="p-2">
                    <input type="number" value="${item.qty}" min="1" class="${inputClass} text-center" oninput="calculateTotalFromItems('${containerId}', '${isEdit ? 'e-grossAmount' : 'grossAmount'}')">
                </td>
                <td class="p-2">
                    <input type="number" value="${item.price}" step="0.01" class="${inputClass} text-right" oninput="calculateTotalFromItems('${containerId}', '${isEdit ? 'e-grossAmount' : 'grossAmount'}')">
                </td>
                <td class="p-2 text-center">
                    <button type="button" onclick="this.closest('tr').remove(); calculateTotalFromItems('${containerId}', '${isEdit ? 'e-grossAmount' : 'grossAmount'}'); ${isEdit ? 'updateEditItemCount()' : ''}" class="text-rose-400 hover:text-rose-600 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            container.appendChild(row);

            if (isEdit) {
                updateEditItemCount();
            }
        }

        function updateEditItemCount() {
            const count = document.getElementById('e-items-container').children.length;
            document.getElementById('e-item-count-badge').innerText = count;
        }

        function handleItemPriceAutoCalc(input, type, containerId) {
            const row = input.closest('.item-row');
            const qtyInput = row.querySelector('.item-qty');
            const priceInput = row.querySelector('.item-price');
            // item-total removed in new UI, we calculate totalGross instead

            if (containerId === 'items-container') {
                calculateTotalFromItems();
            } else {
                calculateTotalFromItems('e-items-container', 'e-grossAmount');
            }
        }

        function handleItemChange(input, containerId = 'items-container') {
            try {
                const name = input.value.trim();
                const master = masterProducts.find(p => p.name === name);
                if (master) {
                    let price = 0;
                    if (master.prices) {
                        price = master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0;
                    }
                    const row = input.closest('tr'); // Changed from .item-row to tr
                    if (row) {
                        const pInput = row.querySelector('td:nth-child(3) input'); // Select price input in the 3rd td
                        if (pInput) pInput.value = price;

                        // just trigger gross recalc
                        if (containerId === 'items-container') {
                            calculateTotalFromItems();
                        } else {
                            calculateTotalFromItems('e-items-container', 'e-grossAmount');
                        }
                    }
                }
            } catch (err) { console.error("handleItemChange error:", err); }
        }

        function calculateTotalFromItems(containerId = 'items-container', displayId = 'grossAmount') {
            let totalGross = 0;
            let totalCost = 0;
            const container = document.getElementById(containerId);
            if (!container) return;

            container.querySelectorAll('tr').forEach(row => {
                const nameInput = row.querySelector('td:nth-child(1) input');
                const name = nameInput ? nameInput.value.trim() : '';
                const qty = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
                const price = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
                totalGross += (qty * price);

                // Auto-calc cost from master if possible
                const master = masterProducts.find(p => p.name === name);
                if (master && master.cost) {
                    totalCost += (qty * master.cost);
                }
            });
            document.getElementById(displayId).value = totalGross.toFixed(2);

            // Auto-update cost field
            const costId = displayId === 'grossAmount' ? 'orderCost' : 'e-orderCost';
            const costField = document.getElementById(costId);
            if (costField && totalCost > 0) {
                costField.value = totalCost.toFixed(2);
            }

            if (displayId === 'grossAmount') {
                calculateNet();
            } else {
                calculateNetPopup();
            }
        }

        function smartImport(containerId) {
            Swal.fire({
                title: 'Smart Import รายการ',
                input: 'textarea',
                inputPlaceholder: 'วางรายการจาก LINE MAN ที่นี่...\n(เช่น ชื่อสินค้า 1|ชื่อสินค้า 2)',
                showCancelButton: true,
                confirmButtonText: 'นำเข้า',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#00B14F'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const raw = result.value.trim();
                    // Split by | or newline
                    const parts = raw.split(/[|\n]/);

                    parts.forEach(part => {
                        let text = part.trim();
                        if (!text) return;

                        // Clean quotes if present
                        text = text.replace(/^["']|["']$/g, '');

                        // Pattern: [Name] [Quantity]
                        // Use regex to find the last space followed by a number
                        const match = text.match(/(.*)\s+(\d+)$/);
                        let name = text;
                        let qty = 1;

                        if (match) {
                            name = match[1].trim();
                            qty = parseInt(match[2]) || 1;
                        }

                        // Lookup Price
                        const master = masterProducts.find(p => p.name === name);
                        let price = 0;
                        if (master && master.prices) {
                            price = master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0;
                        }

                        addItemRow({ name, qty, price }, containerId);
                    });

                    if (containerId === 'items-container') {
                        calculateTotalFromItems();
                    } else {
                        calculateTotalFromItems('e-items-container', 'e-grossAmount');
                    }
                }
            });
        }

        function calculateNet() {
            const gross = parseFloat(document.getElementById('grossAmount').value) || 0;
            const isManual = document.getElementById('isManualNet').checked;
            const isNoFee = document.getElementById('isNoFee').checked;
            const manual = parseFloat(document.getElementById('manualNet').value) || 0;
            const cost = parseFloat(document.getElementById('orderCost').value) || 0;

            let gp = isNoFee ? 0 : gross * GP_RATE;
            let net = gross - gp;

            if (isManual) {
                net = manual;
                gp = gross - net;
            }

            const profit = net - cost;
            const profitRate = net > 0 ? (profit / net) * 100 : 0;

            document.getElementById('calc-net').innerText = `฿${net.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

            const profitEl = document.getElementById('calc-profit');
            profitEl.innerText = `฿${profit.toLocaleString(undefined, { minimumFractionDigits: 2 })} (${profitRate.toFixed(1)}%)`;

            // Profit color logic
            if (profit < 0) {
                profitEl.className = "text-xl font-black text-rose-500 italic";
            } else {
                profitEl.className = "text-xl font-black text-emerald-600 italic";
            }
        }

        function initDefaults() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('receivedDate').value = today;
            document.getElementById('paidDate').value = today;

            const hours = now.getHours().toString().padStart(2, '0');
            const mins = now.getMinutes().toString().padStart(2, '0');

            document.getElementById('orderHH').value = hours;
            document.getElementById('orderMM').value = mins;

            document.getElementById('receivedHH').value = '';
            document.getElementById('receivedMM').value = '';

            document.getElementById('transferHH').value = hours;
            document.getElementById('transferMM').value = mins;

            // Sync Received/Paid Dates whenever Record Date changes (if they were same)
            document.getElementById('recordDate').onchange = (e) => {
                const rd = document.getElementById('receivedDate');
                const pd = document.getElementById('paidDate');
                if (!rd.dataset.manual) rd.value = e.target.value;
                if (!pd.dataset.manual) pd.value = e.target.value;
            };
            document.getElementById('receivedDate').oninput = (e) => { e.target.dataset.manual = "true"; };
            document.getElementById('paidDate').oninput = (e) => { e.target.dataset.manual = "true"; };

            // Same for Edit Modal
            document.getElementById('e-recordDate').onchange = (e) => {
                const erd = document.getElementById('e-receivedDate');
                const epd = document.getElementById('e-paidDate');
                if (!erd.dataset.manual) erd.value = e.target.value;
                if (!epd.dataset.manual) epd.value = e.target.value;
            };
            document.getElementById('e-receivedDate').oninput = (e) => { e.target.dataset.manual = "true"; };
            document.getElementById('e-paidDate').oninput = (e) => { e.target.dataset.manual = "true"; };

            document.getElementById('monthFilter').value = now.toISOString().slice(0, 7);

            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function checkAuth() {
            const timer = setInterval(() => {
                if (window.auth) {
                    clearInterval(timer);
                    window.auth.onAuthStateChanged(user => {
                        document.getElementById('loading').style.display = 'none';
                        if (user) {
                            currentUser = user;
                            document.getElementById('login-container').style.display = 'none';
                            document.getElementById('app-container').style.display = 'block';
                            syncData();
                            syncMasterData();
                        } else {
                            document.getElementById('app-container').style.display = 'none';
                            document.getElementById('login-container').style.display = 'flex';
                        }
                    });
                }
            }, 100);
        }

        async function syncData() {
            window.db.collection('system').doc('lineman_sales').onSnapshot(doc => {
                if (doc.exists) {
                    salesData = doc.data().records || [];
                    renderUI();
                } else {
                    window.db.collection('system').doc('lineman_sales').set({ records: [] });
                }
            });
        }

        function setDateFilter(date) {
            currentSelectedDate = date;
            renderUI();
        }

        function openRecordModal() {
            document.getElementById('recordModal').classList.remove('hidden');
        }

        function closeRecordModal() {
            document.getElementById('recordModal').classList.add('hidden');
        }

        function openPayoutModal() {
            const currentMonth = document.getElementById('monthFilter').value;
            document.getElementById('payoutMonthFilter').value = currentMonth;
            renderPayoutUI();
            document.getElementById('payoutModal').classList.remove('hidden');
        }

        function renderPayoutUI() {
            const container = document.getElementById('payout-list-container');
            const targetMonth = document.getElementById('payoutMonthFilter').value;
            const groups = {};
            let totalMonth = 0;

            // 1. Group Paid Records by paidDate
            salesData.forEach(r => {
                if (r.isPaid && r.paidDate && (r.paidDate || '').startsWith(targetMonth)) {
                    const dateKey = r.paidDate;
                    if (!groups[dateKey]) {
                        groups[dateKey] = {
                            date: dateKey,
                            total: 0,
                            count: 0,
                            items: []
                        };
                    }
                    groups[dateKey].total += r.net;
                    groups[dateKey].count++;
                    groups[dateKey].items.push(r);
                }
            });

            // 2. Sort by Date Descending
            const sortedDates = Object.keys(groups).sort().reverse();

            // 3. Render
            container.innerHTML = '';
            if (sortedDates.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-300 opacity-60">
                        <i class="fas fa-receipt text-6xl mb-4"></i>
                        <p class="text-sm">ไม่พบยอดโอนในเดือนนี้</p>
                    </div>
                `;
            }

            sortedDates.forEach(date => {
                const g = groups[date];
                totalMonth += g.total;

                // Format Date
                const [y, m, d] = date.split('-');
                const thMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                const displayDate = `${parseInt(d)} ${thMonths[parseInt(m) - 1]} ${parseInt(y) + 543}`;

                // HTML structure similar to bank app
                const html = `
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-all">
                        <div class="p-4 flex justify-between items-start cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"
                             onclick="togglePayoutDetail('${date}')">
                            <div class="flex gap-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800 dark:text-slate-100 text-sm">ยอดเงินเข้า</div>
                                    <div class="text-[11px] text-slate-400 mt-0.5">${displayDate}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-emerald-600 text-base">+${g.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5"><i class="fas fa-chevron-down text-[10px] ml-1 transition-transform" id="icon-${date}"></i></div>
                            </div>
                        </div>
                        
                        <!-- Details List -->
                        <div id="detail-${date}" class="hidden border-t border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/30">
                            ${g.items.map(item => `
                                <div class="p-3 pl-16 pr-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800 last:border-0 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group" onclick="editRecord(${item.recordedAt}); event.stopPropagation();">
                                    <div class="text-xs">
                                        <div class="font-bold text-slate-700 dark:text-slate-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-1">
                                            <i class="fas fa-edit mr-1 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                            ${item.customerName || 'ลูกค้าทั่วไป'} (${item.orderId || '-'})
                                        </div>
                                        <div class="text-[10px] text-slate-400">Order: ${item.date} ${item.orderTime}</div>
                                    </div>
                                    <div class="font-bold text-slate-600 dark:text-slate-400 text-xs">+${item.net.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            document.getElementById('payout-total-month').innerText = `฿${totalMonth.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        }

        function togglePayoutDetail(id) {
            const detail = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            detail.classList.toggle('hidden');
            if (detail.classList.contains('hidden')) {
                icon.style.transform = 'rotate(0deg)';
            } else {
                icon.style.transform = 'rotate(180deg)';
            }
        }


        function calculatePerformance(d1, t1, d2, t2) {
            if (!d1 || !t1 || !d2 || !t2) return null;
            try {
                // Parse components explicitly to ensure local time context
                const [y1, m1, dd1] = String(d1).split('-').map(Number);
                const [h1, mm1] = String(t1).split(':').map(Number);
                const [y2, m2, dd2] = String(d2).split('-').map(Number);
                const [h2, mm2] = String(t2).split(':').map(Number);

                const start = new Date(y1, m1 - 1, dd1, h1, mm1, 0);
                const end = new Date(y2, m2 - 1, dd2, h2, mm2, 0);

                const diffMs = end - start;
                if (diffMs < 0) return null;

                const totalMins = Math.floor(diffMs / 60000);
                const days = Math.floor(totalMins / 1440);
                const hrs = Math.floor((totalMins % 1440) / 60);
                const mins = totalMins % 60;

                let label = '';
                if (days > 0) label += `${days}d `;
                if (hrs > 0 || days > 0) label += `${hrs}h `;
                label += `${mins}m`;

                let colorClass = 'text-emerald-600 bg-white'; // Fast < 30m
                if (totalMins > 1440) colorClass = 'text-rose-600 bg-rose-50'; // > 24h
                else if (totalMins > 120) colorClass = 'text-amber-600 bg-amber-50'; // > 2h
                else if (totalMins > 30) colorClass = 'text-blue-600 bg-blue-50'; // > 30m

                return { label: label.trim(), color: colorClass, totalMins };
            } catch (e) { return null; }
        }

        function renderUI() {
            try {
                const sCount = (salesData || []).length;
                console.log("renderUI trigger - Records:", sCount);

                // Auto-refresh Payout UI if open
                if (!document.getElementById('payoutModal').classList.contains('hidden')) {
                    renderPayoutUI();
                }

                const termMonth = document.getElementById('monthFilter').value;
                const now = new Date();
                const y = now.getFullYear();
                const m = (now.getMonth() + 1).toString().padStart(2, '0');
                const d = now.getDate().toString().padStart(2, '0');
                const todayStr = `${y}-${m}-${d}`;
                const currentYearStr = y.toString();

                // Stats Calculation
                let countToday = 0, countMonth = 0, countYear = 0;
                let netPaidMonth = 0, netPaidYear = 0;
                let totalProfitMonth = 0;
                let totalPerfMins = 0, perfCount = 0;

                salesData.forEach(r => {
                    if (!r) return;
                    const rDate = String(r.date || '');
                    if (rDate === todayStr) countToday++;
                    if (rDate.startsWith(termMonth)) {
                        countMonth++;
                        if (r.isPaid) netPaidMonth += (r.net || 0);
                        totalProfitMonth += ((r.net || 0) - (r.cost || 0));
                    }
                    if (rDate.startsWith(currentYearStr)) {
                        countYear++;
                        if (r.isPaid) netPaidYear += (r.net || 0);
                    }

                    if (r.receivedTime) {
                        const perf = calculatePerformance(r.date, r.orderTime, r.receivedDate || r.date, r.receivedTime);
                        if (perf) {
                            totalPerfMins += perf.totalMins;
                            perfCount++;
                        }
                    }
                });

                // Update Header Stats
                document.getElementById('stat-count-today').innerText = countToday;
                document.getElementById('stat-count-month').innerText = countMonth;
                document.getElementById('stat-count-year').innerText = countYear;
                document.getElementById('stat-net-month').innerText = `฿${netPaidMonth.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-profit').innerText = `฿${totalProfitMonth.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-profit').className = `text-xl font-black ${totalProfitMonth < 0 ? 'text-rose-600' : 'text-emerald-600'}`;
                document.getElementById('stat-net-year').innerText = `฿${netPaidYear.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                if (perfCount > 0) {
                    const avgMins = Math.round(totalPerfMins / perfCount);
                    const h = Math.floor(avgMins / 60);
                    const m = avgMins % 60;
                    document.getElementById('stat-avg-time').innerText = h > 0 ? `${h}h ${m}m` : `${m}m`;
                    const progress = Math.min(100, (avgMins / 90) * 100);
                    const bar = document.getElementById('stat-avg-progress');
                    if (bar) {
                        bar.style.width = `${progress}%`;
                        bar.className = `h-full transition-all duration-1000 ${avgMins > 45 ? (avgMins > 90 ? 'bg-rose-500' : 'bg-amber-400') : 'bg-emerald-500'}`;
                    }
                } else {
                    document.getElementById('stat-avg-time').innerText = '--';
                    const bar = document.getElementById('stat-avg-progress');
                    if (bar) bar.style.width = '0%';
                }

                // Filter for the month for the list view
                let filtered = (salesData || []).filter(r => r && String(r.date || '').startsWith(termMonth));

                // Pagination Rendering
                const uniqueDates = [...new Set(filtered.map(r => String(r.date || '')))].filter(d => d).sort((a, b) => String(b).localeCompare(String(a)));
                const pagin = document.getElementById('date-pagination');

                const formatDate = (ds) => {
                    const s = String(ds || '');
                    if (!s) return '';
                    const parts = s.split('-');
                    if (parts.length < 3) return s;
                    const [y, m, d] = parts;
                    return `${d}/${m}/${y.slice(-2)}`;
                };

                let paginHTML = `<button onclick="setDateFilter(null)" class="px-5 py-2.5 rounded-2xl text-xs font-black transition-all whitespace-nowrap ${!currentSelectedDate ? 'bg-lineman text-white shadow-lg shadow-green-500/20 scale-105' : 'bg-white dark:bg-slate-800 text-slate-400 hover:bg-slate-100 border border-slate-100 dark:border-slate-700'}">ทั้งหมด</button>`;

                uniqueDates.forEach(d => {
                    const isActive = currentSelectedDate === d;
                    try {
                        paginHTML += `<button onclick="setDateFilter('${d}')" class="px-5 py-2.5 rounded-2xl text-xs font-black transition-all whitespace-nowrap ${isActive ? 'bg-lineman text-white shadow-lg shadow-green-500/20 scale-105' : 'bg-white dark:bg-slate-800 text-slate-400 hover:bg-slate-100 border border-slate-100 dark:border-slate-700'}">${formatDate(d)}</button>`;
                    } catch (e) { }
                });
                if (pagin) pagin.innerHTML = paginHTML;

                // Apply Date Filter
                if (currentSelectedDate) {
                    if (!uniqueDates.includes(currentSelectedDate)) {
                        currentSelectedDate = null;
                    } else {
                        filtered = filtered.filter(r => r.date === currentSelectedDate);
                    }
                }

                // Update Summary Labels
                document.querySelectorAll('[id^="summary-"]').forEach(el => {
                    try {
                        const p = el.parentElement ? el.parentElement.querySelector('p') : null;
                        if (p && p.innerText.includes('วันนี้')) {
                            p.innerText = p.innerText.replace('วันนี้', currentSelectedDate ? 'ประจำวัน' : 'ประจำเดือน');
                        }
                    } catch (e) { }
                });

                // Calculate daily totals for PAID ribbons (using the month's filtered data to be consistent)
                const monthFiltered = salesData.filter(r => (r.date || '').startsWith(termMonth));
                const dailyPaidTotals = {};
                monthFiltered.forEach(r => {
                    if (r.isPaid) {
                        const pDate = r.paidDate || r.date;
                        dailyPaidTotals[pDate] = (dailyPaidTotals[pDate] || 0) + r.net;
                    }
                });

                const tbody = document.getElementById('salesTable');
                tbody.innerHTML = '';

                let dailyGross = 0; let dailyGP = 0; let dailyNet = 0; let dailyCount = 0;

                let lastDate = null;
                filtered.forEach((record, index) => {
                    // Insert Date Header if date changes
                    if (record.date && record.date !== lastDate) {
                        // Calculate total for this specific date (Sales Net)
                        const dayTotal = filtered.filter(r => String(r.date || '') === String(record.date || '')).reduce((sum, r) => sum + (r.net || 0), 0);
                        const dateParts = String(record.date || '').split('-');
                        const displayDate = dateParts.length >= 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : record.date; // DD/MM/YYYY

                        tbody.innerHTML += `
                        <tr class="bg-indigo-50/50 dark:bg-slate-800/50 border-b border-indigo-100 dark:border-slate-700">
                            <td colspan="5" class="p-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <div class="px-2 py-1 rounded bg-indigo-100 text-indigo-700 text-xs font-bold dark:bg-slate-700 dark:text-indigo-300">
                                            <i class="fas fa-calendar-day mr-1"></i> ${displayDate}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-500 font-bold uppercase tracking-wider">ยอดรับจริง (Net):</span>
                                        <span class="text-sm font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-md border border-emerald-100 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800">
                                            ฿${dayTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                        </span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                        lastDate = record.date;
                    }
                    // Summary now reflects the filtered list (all month or specific day)
                    dailyGross += (record.gross || 0);
                    dailyGP += (record.gp || 0);
                    dailyNet += (record.net || 0);
                    dailyCount++;

                    const isUpdated = (record.items && record.items.length > 0);
                    let rowStyle = '';
                    if (record.isPaid) {
                        rowStyle = '!bg-emerald-50/70 dark:!bg-emerald-900/30 border-l-[4px] border-emerald-500';
                    } else if (isUpdated) {
                        rowStyle = '!bg-orange-50/80 dark:!bg-orange-900/30 border-l-[4px] border-orange-400';
                    }

                    tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${rowStyle} relative">
                        <td class="p-4 align-top">
                            <div class="text-[10px] font-black text-slate-500 dark:text-slate-400">${record.date}</div>
                            <div class="text-[11px] font-black text-blue-600 dark:text-blue-400 mb-1">${record.orderTime || '--:--'}</div>
                            
                            ${record.receivedTime ? `
                                <div class="flex items-center gap-1 text-[9px] font-bold text-amber-600 mb-1" title="เวลารับสินค้า: ${record.receivedDate} ${record.receivedTime}">
                                    <i class="fas fa-box-open"></i> ${record.receivedTime}
                                </div>
                                ${(() => {
                                const perf = calculatePerformance(record.date, record.orderTime, record.receivedDate || record.date, record.receivedTime);
                                return perf ? `
                                        <div class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-md ${perf.color} text-[8px] font-black shadow-sm mb-1">
                                            <i class="fas fa-bolt"></i> ${perf.label}
                                        </div>
                                    ` : '';
                            })()}
                            ` : ''}

                            <div class="inline-block bg-white dark:bg-slate-800 border-[1.5px] border-slate-200 dark:border-slate-700 px-2 py-0.5 rounded-md font-black text-slate-800 dark:text-slate-100 shadow-sm text-[11px] mb-1 tracking-tight">
                                ${record.orderId}
                            </div>
                            ${record.orderIdFull ? `<div class="text-[8px] text-slate-300 truncate max-w-[80px]">${record.orderIdFull}</div>` : ''}
                        </td>
                        <td class="p-4 align-top max-w-[200px]">
                            <div class="font-bold text-xs text-slate-800 dark:text-slate-100">${record.customerName || 'ลูกค้าทั่วไป'}</div>
                            <div class="text-[10px] text-slate-400 mb-1">${record.customerPhone || ''}</div>
                            
                            <div class="space-y-1">
                                ${(record.items || []).map(i => `
                                    <div class="flex justify-between text-[10px]">
                                        <span class="text-slate-500">${i.name} x${i.qty}</span>
                                        <span class="font-bold text-slate-400">฿${(i.qty * i.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="text-[10px] italic text-slate-400 mt-2 border-t border-slate-50 pt-1" title="${record.notes}">
                                ${record.notes || ''}
                                ${record.isPaid ? `
                                    <div class="mt-1 flex items-center gap-1 text-[9px] text-emerald-600 font-bold bg-emerald-100/50 px-2 py-0.5 rounded-full w-fit">
                                        <i class="fas fa-check-circle"></i> ได้รับเงิน: ${record.paidDate} ${record.paidTime}
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="text-[10px] ${(record.isNoFee) ? 'text-slate-300' : 'text-rose-400'} font-bold">
                                ${record.isNoFee ? '<span class="bg-rose-50 px-1 rounded text-[8px]">NO FEE</span>' : `-฿${(record.gp || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}`}
                            </div>
                            <div class="font-bold text-slate-400">฿${(record.gross || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="font-black text-lineman text-lg">฿${(record.net || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                            ${(() => {
                            const netVal = record.net || 0;
                            const pft = netVal - (record.cost || 0);
                            const rate = netVal > 0 ? (pft / netVal) * 100 : 0;
                            const pColor = pft < 0 ? 'text-rose-500' : 'text-emerald-600';
                            return `<div class="text-[10px] font-black ${pColor}">กำไร: ฿${pft.toLocaleString(undefined, { minimumFractionDigits: 2 })} (${rate.toFixed(1)}%)</div>`;
                        })()}
                        </td>
                        <td class="p-4 text-center relative max-w-[120px]">
                            <div class="flex flex-col items-center gap-2">
                                ${record.isPaid ? `
                                    <div class="bg-emerald-100/80 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-400 text-[9px] font-black px-3 py-1.5 rounded-full shadow-sm flex items-center gap-1.5 border border-emerald-200 dark:border-emerald-700">
                                        <i class="fas fa-check-circle"></i> PAID
                                    </div>
                                    <div class="text-[8px] font-bold text-slate-400">${record.paidDate || record.date}</div>
                                ` : `
                                    <div class="bg-slate-100/50 dark:bg-slate-800/50 text-slate-400 text-[9px] font-black px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-700">
                                        UNPAID
                                    </div>
                                `}
                            </div>
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="editRecord(${record.recordedAt})" class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-400 hover:text-blue-600 transition-all">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteRecord(${record.recordedAt})" class="w-8 h-8 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-rose-400 hover:text-rose-600 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                });

                document.getElementById('summary-gross').innerText = `฿${dailyGross.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-gp').innerText = `฿${dailyGP.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-gross-label').innerText = `${dailyCount} รายการ`;

                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-slate-300 font-bold uppercase tracking-widest">No Sales Found</td></tr>`;
                }
            } catch (err) {
                console.error("Render error:", err);
                if (!window.lastRenderError || (Date.now() - window.lastRenderError > 5000)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Render Error',
                        text: 'เกิดข้อผิดพลาดในการแสดงผลประวัติยอดขาย: ' + err.message,
                        footer: 'กรุณาล้างแคชหรือแจ้งผู้พัฒนา'
                    });
                    window.lastRenderError = Date.now();
                }
            }
        }

        document.getElementById('salesForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const vDate = document.getElementById('recordDate').value;
                const oId = document.getElementById('orderId').value;
                const grossVal = document.getElementById('grossAmount').value;

                if (!vDate || !oId || !grossVal || parseFloat(grossVal) <= 0) {
                    Swal.fire('ข้อมูลไม่ครบ', 'กรุณาระบุวันที่, ออเดอร์ และรายการสินค้าให้ครบถ้วน', 'warning');
                    return;
                }

                const gross = parseFloat(grossVal) || 0;
                const isManual = document.getElementById('isManualNet').checked;
                const manual = parseFloat(document.getElementById('manualNet').value) || 0;

                const isNoFee = document.getElementById('isNoFee').checked;
                let gp = isNoFee ? 0 : gross * GP_RATE;
                let net = gross - gp;

                if (isManual) {
                    net = manual;
                    gp = gross - net;
                }

                // Collect items - Fixed: Scope to items-container
                const items = [];
                const masterUpdates = [];
                const container = document.getElementById('items-container');
                container.querySelectorAll('tr').forEach(row => { // Changed from .item-row to tr
                    const nameInput = row.querySelector('td:nth-child(1) input');
                    const qtyInput = row.querySelector('td:nth-child(2) input');
                    const priceInput = row.querySelector('td:nth-child(3) input');

                    const name = nameInput ? nameInput.value.trim() : '';
                    const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    const price = parseFloat(priceInput ? priceInput.value : 0) || 0;

                    if (name) items.push({ name, qty, price });
                    if (name && price > 0) masterUpdates.push({ name, price });
                });

                const hh = document.getElementById('orderHH')?.value?.toString()?.padStart(2, '0') || '00';
                const mm = document.getElementById('orderMM')?.value?.toString()?.padStart(2, '0') || '00';

                const rDate = document.getElementById('receivedDate')?.value || document.getElementById('recordDate')?.value;
                const rHH = document.getElementById('receivedHH')?.value?.toString()?.padStart(2, '0') || '00';
                const rMM = document.getElementById('receivedMM')?.value?.toString()?.padStart(2, '0') || '00';

                const isPaid = document.getElementById('isPaid').checked;
                const paidDate = document.getElementById('paidDate').value;
                const tHH = document.getElementById('transferHH')?.value?.toString()?.padStart(2, '0') || '00';
                const tMM = document.getElementById('transferMM')?.value?.toString()?.padStart(2, '0') || '00';

                const cost = parseFloat(document.getElementById('orderCost').value) || 0;

                const record = {
                    date: document.getElementById('recordDate').value,
                    orderTime: `${hh}:${mm}`,
                    receivedDate: rDate,
                    receivedTime: (rHH !== '00' || rMM !== '00') ? `${rHH}:${rMM}` : '',
                    orderId: document.getElementById('orderId').value,
                    orderIdFull: document.getElementById('orderIdFull').value,
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    gross: gross,
                    gp: gp,
                    net: net,
                    cost: cost,
                    isManualNet: isManual,
                    isNoFee: isNoFee,
                    isPaid: isPaid,
                    paidDate: paidDate,
                    paidTime: isPaid ? `${tHH}:${tMM}` : '',
                    items: items,
                    notes: document.getElementById('notes').value,
                    recordedAt: new Date().getTime()
                };

                showLoading(true);

                // Master Update Logic
                for (const update of masterUpdates) {
                    const docId = update.name.replace(/\//g, '_'); // Firestore doc ID cannot contain /
                    const master = masterProducts.find(m => m.name === update.name);
                    try {
                        await window.db.collection('master_products').doc(docId).set({
                            prices: { ...(master?.prices || {}), 'LINEMAN': update.price }
                        }, { merge: true });
                    } catch (mErr) { console.warn("Master Update Failed for:", update.name, mErr); }
                }

                salesData.unshift(record);
                Swal.fire({ icon: 'success', title: 'บันทึกยอดขายแล้ว', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });

                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);

                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });

                closeRecordModal();
                document.getElementById('salesForm').reset();
                document.getElementById('items-container').innerHTML = '';
                document.getElementById('isManualNet').checked = false;
                toggleManualNet();
                initDefaults();
                calculateNet();
                clearDraft();
                syncMasterData();
            } catch (error) {
                console.error("Save Record Error:", error);
                Swal.fire('Error', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        // Modal Form Submit (Edit)
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            console.log("Edit Form Submit Triggered - UID:", editingUid);

            if (editingUid === null) {
                Swal.fire('Error', 'Session Expired: กรุณาปิดแล้วเปิดการแก้ไขใหม่อีกครั้ง', 'warning');
                return;
            }

            try {
                showLoading(true);

                // Manual Validation
                const vDate = document.getElementById('e-recordDate')?.value;
                const oId = document.getElementById('e-orderId')?.value;
                const grossVal = document.getElementById('e-grossAmount')?.value;

                if (!vDate || !oId || !grossVal || parseFloat(grossVal) <= 0) {
                    throw new Error("ข้อมูลไม่ครบถ้วน (วันที่, เลขออเดอร์ หรือรายการสินค้า)");
                }

                // Find target index
                const targetIdx = salesData.findIndex(r => r.recordedAt === editingUid);
                if (targetIdx === -1) throw new Error("ไม่พบข้อมูลรายการที่ต้องการแก้ไขในระบบ (Index Error)");

                const gross = parseFloat(grossVal) || 0;
                const isNoFee = document.getElementById('e-isNoFee')?.checked || false;
                const isManual = document.getElementById('e-isManualNet')?.checked || false;
                const manual = parseFloat(document.getElementById('e-manualNet')?.value || 0) || 0;

                let gp = isNoFee ? 0 : gross * GP_RATE;
                let net = gross - gp;
                if (isManual) {
                    net = manual;
                    gp = gross - net;
                }

                // Collect items
                const items = [];
                const masterUpdates = [];
                const eContainer = document.getElementById('e-items-container');
                if (eContainer) {
                    eContainer.querySelectorAll('tr').forEach(row => { // Changed from .item-row to tr
                        const n = row.querySelector('td:nth-child(1) input')?.value?.trim();
                        const q = parseFloat(row.querySelector('td:nth-child(2) input')?.value) || 0;
                        const p = parseFloat(row.querySelector('td:nth-child(3) input')?.value) || 0;
                        if (n) {
                            items.push({ name: n, qty: q, price: p });
                            if (p > 0) masterUpdates.push({ name: n, price: p });
                        }
                    });
                }

                const hh = document.getElementById('e-orderHH')?.value?.toString()?.padStart(2, '0') || '00';
                const mm = document.getElementById('e-orderMM')?.value?.toString()?.padStart(2, '0') || '00';
                const rDate = document.getElementById('e-receivedDate')?.value || document.getElementById('e-recordDate')?.value;
                const rHH = document.getElementById('e-receivedHH')?.value?.toString()?.padStart(2, '0') || '00';
                const rMM = document.getElementById('e-receivedMM')?.value?.toString()?.padStart(2, '0') || '00';

                const isPaid = document.getElementById('e-isPaid')?.checked || false;
                const pDate = document.getElementById('e-paidDate')?.value || '';
                const tHH = document.getElementById('e-transferHH')?.value?.toString()?.padStart(2, '0') || '00';
                const tMM = document.getElementById('e-transferMM')?.value?.toString()?.padStart(2, '0') || '00';

                const cost = parseFloat(document.getElementById('e-orderCost')?.value || 0) || 0;

                const updatedRecord = {
                    ...salesData[targetIdx],
                    date: document.getElementById('e-recordDate')?.value || salesData[targetIdx].date,
                    orderTime: `${hh}:${mm}`,
                    receivedDate: rDate,
                    receivedTime: (rHH !== '00' || rMM !== '00') ? `${rHH}:${rMM}` : '',
                    orderId: document.getElementById('e-orderId')?.value || '',
                    orderIdFull: document.getElementById('e-orderIdFull')?.value || '',
                    customerName: document.getElementById('e-customerName')?.value || '',
                    customerPhone: document.getElementById('e-customerPhone')?.value || '',
                    gross: gross,
                    gp: gp,
                    net: net,
                    cost: cost,
                    isNoFee: isNoFee,
                    isManualNet: isManual,
                    isPaid: isPaid,
                    paidDate: pDate,
                    paidTime: isPaid ? `${tHH}:${tMM}` : '',
                    items: items,
                    notes: document.getElementById('e-notes')?.value || ''
                };

                console.log("Saving Master Product Updates...");
                for (const update of masterUpdates) {
                    const docId = update.name.replace(/\//g, '_');
                    const master = masterProducts.find(m => m.name === update.name);
                    try {
                        await window.db.collection('master_products').doc(docId).set({
                            prices: { ...(master?.prices || {}), 'LINEMAN': update.price }
                        }, { merge: true });
                    } catch (mErr) { console.warn("Master Update Failed for:", update.name, mErr); }
                }

                console.log("Updating Sales Data...");
                const finalIdx = salesData.findIndex(r => r.recordedAt === editingUid);
                if (finalIdx !== -1) {
                    salesData[finalIdx] = updatedRecord;
                } else {
                    salesData.unshift(updatedRecord);
                }

                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);
                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });

                closeEditModal();
                Swal.fire({
                    icon: 'success',
                    title: 'แก้ไขข้อมูลสำเร็จ',
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
                syncMasterData();
            } catch (error) {
                console.error("Save Edit Error Details:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'บันทึกไม่สำเร็จ',
                    text: error.message,
                    footer: 'Debug: ' + (error.stack ? error.stack.split('\n')[0] : 'No stack')
                });
            } finally {
                showLoading(false);
            }
        };

        // --- Autosave System ---
        function setupAutosave() {
            const inputs = ['recordDate', 'orderId', 'customerName', 'customerPhone', 'grossAmount', 'notes'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', saveDraft);
            });
        }

        function saveDraft() {
            if (editIndex !== null) return;

            const draft = {
                date: document.getElementById('recordDate').value,
                orderHH: document.getElementById('orderHH').value,
                orderMM: document.getElementById('orderMM').value,
                orderId: document.getElementById('orderId').value,
                orderIdFull: document.getElementById('orderIdFull').value,
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                cost: document.getElementById('orderCost').value,
                isManualNet: document.getElementById('isManualNet').checked,
                manualNet: document.getElementById('manualNet').value,
                items: Array.from(document.getElementById('items-container').querySelectorAll('tr')).map(row => ({ // Changed from .item-row to tr
                    name: row.querySelector('td:nth-child(1) input').value,
                    qty: row.querySelector('td:nth-child(2) input').value,
                    price: row.querySelector('td:nth-child(3) input').value
                })),
                notes: document.getElementById('notes').value,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('lineman_draft', JSON.stringify(draft));

            // Visual Feedback
            const status = document.getElementById('autosave-status');
            status.classList.remove('opacity-0');
            setTimeout(() => status.classList.add('opacity-0'), 2000);
        }

        function loadDraft() {
            const rawDraft = localStorage.getItem('lineman_draft');
            if (!rawDraft) return;

            const draft = JSON.parse(rawDraft);
            // Only load if draft is less than 24 hours old
            if (new Date().getTime() - draft.timestamp > 86400000) {
                localStorage.removeItem('lineman_draft');
                return;
            }

            if (draft.date) document.getElementById('recordDate').value = draft.date;
            if (draft.orderHH) document.getElementById('orderHH').value = draft.orderHH;
            if (draft.orderMM) document.getElementById('orderMM').value = draft.orderMM;
            if (draft.orderIdFull) document.getElementById('orderIdFull').value = draft.orderIdFull;
            if (draft.orderId) document.getElementById('orderId').value = draft.orderId;
            if (draft.customerName) document.getElementById('customerName').value = draft.customerName;
            if (draft.customerPhone) document.getElementById('customerPhone').value = draft.customerPhone;
            if (draft.cost) document.getElementById('orderCost').value = draft.cost;

            if (draft.items) {
                document.getElementById('items-container').innerHTML = '';
                draft.items.forEach(item => addItemRow(item));
            }

            if (draft.isManualNet) {
                document.getElementById('isManualNet').checked = true;
                document.getElementById('manualNet').value = draft.manualNet || 0;
            }
            toggleManualNet();

            if (draft.notes) document.getElementById('notes').value = draft.notes;
            calculateTotalFromItems();
        }

        function clearDraft() {
            localStorage.removeItem('lineman_draft');
            document.getElementById('autosave-status').classList.add('opacity-0');
        }

        function editRecord(uid) {
            const actualIndex = salesData.findIndex(r => r.recordedAt === uid);
            if (actualIndex === -1) return;

            editIndex = actualIndex;
            editingUid = uid;
            const record = salesData[actualIndex];

            // Fill Modal Form
            document.getElementById('e-uid-label').innerText = String(record.recordedAt).slice(0, 8);
            document.getElementById('e-recordDate').value = record.date;
            document.getElementById('e-orderHH').value = record.orderTime ? record.orderTime.split(':')[0] : '00';
            document.getElementById('e-orderMM').value = record.orderTime ? record.orderTime.split(':')[1] : '00';

            document.getElementById('e-receivedDate').value = record.receivedDate || record.date;
            document.getElementById('e-receivedHH').value = record.receivedTime ? record.receivedTime.split(':')[0] : '00';
            document.getElementById('e-receivedMM').value = record.receivedTime ? record.receivedTime.split(':')[1] : '00';

            document.getElementById('e-orderIdFull').value = record.orderIdFull || '';
            document.getElementById('e-orderId').value = record.orderId;
            document.getElementById('e-customerPhone').value = record.customerPhone || '';
            document.getElementById('e-customerName').value = record.customerName || '';

            const container = document.getElementById('e-items-container');
            container.innerHTML = '';
            if (record.items && record.items.length > 0) {
                record.items.forEach(item => addItemRow(item, 'e-items-container'));
            } else {
                addItemRow({ name: record.notes || 'สินค้าทั่วไป', qty: 1, price: record.gross }, 'e-items-container');
            }
            updateEditItemCount();

            document.getElementById('e-grossAmount').value = record.gross;
            document.getElementById('e-orderCost').value = record.cost || 0;
            document.getElementById('e-isNoFee').checked = record.isNoFee;
            document.getElementById('e-isManualNet').checked = record.isManualNet;
            document.getElementById('e-manualNet').value = record.net || record.gross;
            document.getElementById('e-notes').value = record.notes || '';
            document.getElementById('e-isPaid').checked = record.isPaid || false;

            if (record.isPaid) {
                document.getElementById('e-paidDate').value = record.paidDate || record.date;
                if (record.paidTime && record.paidTime.includes(':')) {
                    const [th, tm] = record.paidTime.split(':');
                    document.getElementById('e-transferHH').value = th;
                    document.getElementById('e-transferMM').value = tm;
                } else {
                    const now = new Date();
                    document.getElementById('e-transferHH').value = now.getHours().toString().padStart(2, '0');
                    document.getElementById('e-transferMM').value = now.getMinutes().toString().padStart(2, '0');
                }
            }

            toggleManualNet('edit');
            togglePaidSection('edit');
            calculateNetPopup();

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            editIndex = null;
            editingUid = null;
            document.getElementById('editModal').classList.add('hidden');
        }

        function calculateNetPopup() {
            const gross = parseFloat(document.getElementById('e-grossAmount').value) || 0;
            const isNoFee = document.getElementById('e-isNoFee').checked;
            const isManual = document.getElementById('e-isManualNet').checked;
            const manual = parseFloat(document.getElementById('e-manualNet').value) || 0;
            const cost = parseFloat(document.getElementById('e-orderCost').value) || 0;

            let net;
            if (isManual) {
                net = manual;
            } else {
                let gp = isNoFee ? 0 : gross * GP_RATE;
                net = gross - gp;
            }

            const profit = net - cost;
            const profitRate = net > 0 ? (profit / net) * 100 : 0;

            document.getElementById('e-calc-net').innerText = `฿${net.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

            const profitEl = document.getElementById('e-calc-profit');
            profitEl.innerText = `฿${profit.toLocaleString(undefined, { minimumFractionDigits: 2 })} (${profitRate.toFixed(1)}%)`;

            if (profit < 0) {
                profitEl.className = "text-xl font-black text-rose-500 italic";
            } else {
                profitEl.className = "text-xl font-black text-emerald-600 italic";
            }
        }

        function cancelEdit() {
            editIndex = null;
            editingUid = null;
            document.getElementById('salesForm').reset();
            initDefaults(); // Restore date to today
            calculateNet();

            // UI Mode Restore
            document.getElementById('form-title').innerText = "บันทึกยอดขายใหม่";
            document.getElementById('form-icon').className = "fas fa-plus text-lineman text-sm";
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check-circle mr-2"></i> บันทึกข้อมูล';
        }

        async function deleteRecord(uid) {
            const res = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ยอดขายรายการนี้จะถูกถอนออกจากระบบ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e11d48',
                confirmButtonText: 'ลบทิ้ง'
            });

            if (res.isConfirmed) {
                const idx = salesData.findIndex(r => r.recordedAt === uid);
                if (idx !== -1) {
                    salesData.splice(idx, 1);
                    showLoading(true);
                    await window.db.collection('system').doc('lineman_sales').set({ records: salesData });
                    showLoading(false);
                }
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function exportSalesCSV() {
            const termMonth = document.getElementById('monthFilter').value;
            const filtered = salesData.filter(r => r.date.startsWith(termMonth));
            if (filtered.length === 0) return Swal.fire('No Data', 'ไม่มีข้อมูลในช่วงเวลาที่เลือก', 'info');

            const csv = [
                ['Date', 'Order ID', 'Gross Amount', 'GP Fee (30%)', 'Net Amount', 'Cost', 'Profit', 'Profit %', 'Notes'],
                ...filtered.map(r => [r.date, r.orderId, r.gross, r.gp, r.net, r.cost || 0, r.net - (r.cost || 0), r.net > 0 ? ((r.net - (r.cost || 0)) / r.net * 100).toFixed(2) : 0, `"${r.notes}"`])
            ].map(e => e.join(",")).join("\n");

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `lineman_sales_${termMonth}.csv`);
            link.click();
        }

        function exportBackupJSON() {
            if (salesData.length === 0) return Swal.fire('No Data', 'ไม่มีข้อมูลให้ Backup', 'info');

            const dataStr = JSON.stringify(salesData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);

            link.href = url;
            link.download = `lineman_backup_${timestamp}.json`;
            link.click();

            Swal.fire({
                icon: 'success',
                title: 'Backup สำเร็จ',
                text: 'ดาวน์โหลดไฟล์ JSON เรียบร้อยแล้ว',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function logout() { window.auth.signOut().then(() => window.location.reload()); }

        // CSV Import Functions
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('csvInput').value = '';
        }

        async function processCSV() {
            const rawData = document.getElementById('csvInput').value.trim();
            if (!rawData) return;

            const lines = rawData.split('\n');
            const recordsToImport = [];

            // ตรวจสอบโครงสร้าง Column (อ้างอิงจากตัวอย่าง csv ที่ให้มา)
            // OrderID[0], SettlementTime[2], ItemName[3], OrderStatus[7], RevenueAmount[11] 

            lines.forEach((line, index) => {
                if (index === 0 && line.includes('OrderID')) return; // ข้าม Header

                const cols = line.split(',');
                if (cols.length < 12) return; // ข้อมูลไม่ครบ

                const orderId = cols[0].trim();
                const settleTime = cols[2].trim(); // "2026/02/03 16:39:51"
                const itemName = cols[3].trim().replace(/['"]/g, '');
                const status = cols[7].trim(); // "FINISH" 
                const gross = parseFloat(cols[11]) || 0; // RevenueAmount

                // นำเข้าเฉพาะที่สำเร็จ และยังไม่มีในระบบ
                if (status === 'FINISH') {
                    const dtParts = settleTime.split(' ');
                    const dateOnly = dtParts[0].replace(/\//g, '-');
                    const timeOnly = dtParts.length > 1 ? dtParts[1].slice(0, 5) : '00:00';
                    const gp = gross * GP_RATE;
                    const net = gross - gp;

                    const orderIdShort = orderId.length >= 4 ? orderId.slice(-4).toUpperCase() : orderId;

                    // Split items from itemName (e.g. "Product A 1|Product B 2")
                    const items = [];
                    const parts = itemName.split('|');
                    const totalCost = parts.map(part => {
                        const text = part.trim();
                        if (!text) return;
                        const match = text.match(/(.*)\s+(\d+)$/);
                        let name = text;
                        let qty = 1;
                        if (match) {
                            name = match[1].trim();
                            qty = parseInt(match[2]) || 1;
                        }

                        const master = masterProducts.find(m => m.name === name);
                        const price = (master && master.prices) ? (master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0) : 0;
                        let rowCost = (master && master.cost) ? (qty * master.cost) : 0;

                        items.push({ name, qty, price, cost: master?.cost || 0 });
                        return rowCost;
                    }).reduce((a, b) => a + (b || 0), 0);

                    recordsToImport.push({
                        date: dateOnly,
                        orderTime: timeOnly,
                        orderId: orderIdShort,
                        orderIdFull: orderId,
                        gross: gross,
                        gp: gp,
                        net: net,
                        cost: totalCost,
                        isPaid: false, // Default for CSV import
                        paidDate: '',
                        paidTime: '',
                        items: items, // Added split items
                        notes: itemName,
                        recordedAt: new Date().getTime() + index
                    });
                }
            });

            if (recordsToImport.length > 0) {
                showLoading(true);

                let addedCount = 0;
                let updatedCount = 0;
                let ignoredCount = 0;

                const getScore = (r) => {
                    let s = 0;
                    if (r.items && r.items.length > 0) s += r.items.length * 10;
                    if (r.notes) s += r.notes.length;
                    if (r.customerName) s += 10;
                    if (r.isPaid) s += 100; // Manual paid status is high value
                    return s;
                };

                recordsToImport.forEach(newRec => {
                    // Find duplicate
                    const existingIdx = salesData.findIndex(r =>
                        (r.orderIdFull && newRec.orderIdFull && r.orderIdFull === newRec.orderIdFull) ||
                        (!r.orderIdFull && !newRec.orderIdFull && r.orderId === newRec.orderId && r.date === newRec.date)
                    );

                    if (existingIdx === -1) {
                        salesData.push(newRec);
                        addedCount++;
                    } else {
                        const existingRec = salesData[existingIdx];
                        const sOld = getScore(existingRec);
                        const sNew = getScore(newRec);

                        if (sNew > sOld) {
                            // Link existing manual info if any
                            const merged = {
                                ...newRec,
                                isPaid: existingRec.isPaid || newRec.isPaid,
                                paidDate: existingRec.paidDate || newRec.paidDate,
                                paidTime: existingRec.paidTime || newRec.paidTime,
                                recordedAt: existingRec.recordedAt // Keep original order
                            };
                            salesData[existingIdx] = merged;
                            updatedCount++;
                        } else {
                            ignoredCount++;
                        }
                    }
                });

                // เรียงลำดับตามวันที่ใหม่
                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);

                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });
                showLoading(false);
                closeImportModal();

                Swal.fire({
                    icon: 'success',
                    title: 'นำเข้าข้อมูลเรียบร้อย',
                    html: `
                        <div class="text-left space-y-1 text-sm bg-slate-50 p-4 rounded-xl">
                            <div class="flex justify-between"><span>เพิ่มใหม่:</span> <span class="font-bold text-emerald-600">${addedCount}</span></div>
                            <div class="flex justify-between"><span>อัปเดตข้อมูล:</span> <span class="font-bold text-blue-600">${updatedCount}</span></div>
                            <div class="flex justify-between"><span>ข้าม (ซ้ำ):</span> <span class="font-bold text-slate-400">${ignoredCount}</span></div>
                        </div>
                    `,
                    confirmButtonColor: '#00B14F'
                });
            } else {
                Swal.fire('ไม่พบข้อมูล', 'ไม่พบรายการที่สำเร็จ (FINISH) ในข้อมูลที่วาง', 'warning');
            }
        }

        // File Selection Handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('bg-lineman/10', 'border-lineman');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('bg-lineman/10', 'border-lineman');
        }

        function handleDropFile(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('bg-lineman/10', 'border-lineman');

            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processFile(files[0]);
        }

        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                return Swal.fire('ไฟล์ไม่ถูกต้อง', 'กรุณาเลือกไฟล์เฉพาะนามสกุล .csv เท่านั้น', 'error');
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('csvInput').value = e.target.result;
                // Optional: Auto process
                Swal.fire({
                    title: 'โหลดไฟล์สำเร็จ',
                    text: `พบข้อมูลในไฟล์ ${file.name} ต้องการเริ่มนำเข้าทันทีหรือไม่?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'เริ่มนำเข้าเลย',
                    cancelButtonText: 'ตรวจสอบก่อน',
                    confirmButtonColor: '#00B14F'
                }).then((result) => {
                    if (result.isConfirmed) processCSV();
                });
            };
            reader.readAsText(file);
        }
    </script>
    <script>
        async function openMasterEdit(name) {
            name = name ? name.trim() : '';
            if (!name) return Swal.fire({ icon: 'info', title: 'ระบุชื่อสินค้า', text: 'กรุณากรอกชื่อสินค้าก่อนระบุข้อมูลหลัก', timer: 1500, showConfirmButton: false });

            document.getElementById('masterModal').classList.remove('hidden');
            document.getElementById('m-name').value = name;
            document.getElementById('m-originalName').value = name;

            const m = masterProducts.find(x => x.name === name);
            if (m) {
                const prices = m.prices || {};
                document.getElementById('m-price').value = prices['LINEMAN'] || 0;
                document.getElementById('m-cost').value = prices['COST'] || '';
                document.getElementById('m-retail').value = prices['RETAIL'] || '';
                document.getElementById('m-wholesale').value = prices['WHOLESALE'] || '';
                document.getElementById('m-unit').value = m.unit || '';
                document.getElementById('m-companyCode').value = m.companyProductId || '';
                document.getElementById('m-mlpCode').value = m.mlpId || '';
            } else {
                document.getElementById('m-price').value = '';
                document.getElementById('m-cost').value = '';
                document.getElementById('m-retail').value = '';
                document.getElementById('m-wholesale').value = '';
                document.getElementById('m-unit').value = '';
                document.getElementById('m-companyCode').value = '';
                document.getElementById('m-mlpCode').value = '';
            }
        }

        async function saveMasterEdit() {
            const name = document.getElementById('m-name').value.trim();
            if (!name) return;

            const price = parseFloat(document.getElementById('m-price').value) || 0;
            const cost = parseFloat(document.getElementById('m-cost').value) || 0;
            const retail = parseFloat(document.getElementById('m-retail').value) || 0;
            const wholesale = parseFloat(document.getElementById('m-wholesale').value) || 0;

            const unit = document.getElementById('m-unit').value.trim();
            const companyCode = document.getElementById('m-companyCode').value.trim();
            const mlpCode = document.getElementById('m-mlpCode').value.trim();

            const docId = name.replace(/\//g, '_');

            showLoading(true);
            try {
                const docRef = window.db.collection('master_products').doc(docId);
                const doc = await docRef.get();

                let prices = doc.exists && doc.data().prices ? doc.data().prices : {};
                if (price > 0) prices['LINEMAN'] = price;
                if (cost > 0) prices['COST'] = cost;
                if (retail > 0) prices['RETAIL'] = retail;
                if (wholesale > 0) prices['WHOLESALE'] = wholesale;

                const updateData = {
                    name, unit, companyProductId: companyCode, mlpId: mlpCode, prices
                };


                await docRef.set(updateData, { merge: true });

                document.getElementById('masterModal').classList.add('hidden');
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                Toast.fire({ icon: 'success', title: 'Saved Master Data' });
                syncMasterData();
            } catch (e) {
                console.error(e);
                Swal.fire('Error', e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>

</html>