<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE MAN Sales Recorder | Medlife</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155',
                        lineman: '#00B14F' // LINE MAN Green
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vibrant-label {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 4px;
            margin-bottom: 6px;
            display: block;
            color: #475569;
            /* slate-600 */
        }

        .dark .vibrant-label {
            color: #cbd5e1;
            /* slate-300 */
        }

        .premium-input {
            width: 100%;
            padding: 1rem;
            border-radius: 1.25rem;
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            outline: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            color: #1e293b;
        }

        .dark .premium-input {
            background-color: rgba(30, 41, 59, 0.8);
            border-color: rgba(51, 65, 85, 0.8);
            color: #f8fafc;
        }

        .premium-input:focus {
            border-color: #00B14F;
            background-color: #ffffff;
            box-shadow: 0 0 0 4px rgba(0, 177, 79, 0.1);
        }

        .dark .premium-input:focus {
            background-color: #0f172a;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-darkBg text-slate-800 dark:text-slate-200 transition-colors duration-300 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 bg-white/80 dark:bg-black/80 z-[100] flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-lineman border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-lineman animate-pulse">กำลังโหลดระบบบันทึกยอดขาย...</p>
    </div>

    <!-- Login Check UI -->
    <div id="login-container" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center border border-white/20">
            <div class="w-20 h-20 bg-lineman/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-chart-line text-3xl text-lineman"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 tracking-tight">Access Required</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8">กรุณาเข้าสู่ระบบเพื่อบันทึกยอดขาย LINE MAN</p>
            <a href="admin.html"
                class="block w-full py-4 bg-lineman hover:bg-green-600 text-white rounded-2xl font-bold shadow-lg transition-all transform active:scale-95">
                <i class="fas fa-arrow-left mr-2"></i> ไปที่หน้า Admin
            </a>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="app-container" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto space-y-6">

            <!-- Header -->
            <nav class="glass sticky top-4 z-50 rounded-3xl shadow-lg border border-white/20 p-4 mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <a href="admin.html"
                            class="w-12 h-12 rounded-2xl bg-white dark:bg-slate-800 flex items-center justify-center text-slate-400 hover:text-lineman transition-all shadow-sm">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </a>
                        <div
                            class="w-12 h-12 rounded-2xl bg-lineman flex items-center justify-center text-white shadow-lg">
                            <i class="fas fa-store text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-black tracking-tight">LINE MAN <span
                                    class="text-lineman">Sales Recorder</span></h1>
                            <div
                                class="flex items-center gap-2 text-[10px] uppercase font-bold tracking-widest text-slate-400">
                                <span class="text-lineman">Platform Manager</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <button onclick="openRecordModal()"
                            class="w-12 h-12 rounded-2xl bg-lineman text-white flex items-center justify-center shadow-lg shadow-green-500/20 hover:scale-110 transition-all transform active:scale-95"
                            title="เพิ่มยอดขายใหม่">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="toggleTheme()"
                            class="w-12 h-12 rounded-2xl bg-white dark:bg-slate-800 text-slate-400 dark:text-yellow-400 flex items-center justify-center shadow-sm hover:scale-105 transition-all">
                            <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i>
                        </button>
                        <button onclick="logout()"
                            class="px-6 py-3 rounded-2xl bg-rose-50 dark:bg-rose-900/20 text-rose-500 font-bold hover:bg-rose-100 transition-all text-sm border border-rose-100 dark:border-rose-900/30">
                            LOGOUT
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Financial Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-lineman flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Gross / GP
                            (Month)</p>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-2xl font-black" id="summary-gross">฿0</span>
                            <span class="text-xs font-bold text-rose-500 mb-1" id="summary-gp">฿0</span>
                        </div>
                    </div>
                    <div
                        class="pt-3 border-t border-slate-100 dark:border-slate-800 flex justify-between text-[9px] font-bold text-slate-400">
                        <span>รายการเดือนนี้</span>
                        <span class="text-lineman" id="summary-gross-label">--</span>
                    </div>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-blue-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3">ยอดรับโอน (Net
                            Paid)</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] font-bold text-slate-400">เดือนนี้</span>
                                <span class="text-xl font-black text-blue-600" id="stat-net-month">฿0</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-[10px] font-bold text-slate-400">ปีนี้</span>
                                <span class="text-sm font-black text-slate-600 dark:text-slate-300"
                                    id="stat-net-year">฿0</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-[9px] text-blue-400 font-bold mt-2 uppercase">เฉพาะรายการโอนสำเร็จ</p>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-purple-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-purple-500 uppercase tracking-widest mb-3">จำนวนออเดอร์
                        </p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">วันนี้</p>
                                <p class="text-lg font-black text-purple-600" id="stat-count-today">0</p>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">เดือนนี้</p>
                                <p class="text-lg font-black text-slate-700 dark:text-slate-200" id="stat-count-month">0
                                </p>
                            </div>
                            <div>
                                <p class="text-[8px] font-bold text-slate-400 uppercase">ปีนี้</p>
                                <p class="text-lg font-black text-slate-400" id="stat-count-year">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="glass card-hover p-5 rounded-3xl border-l-[6px] border-amber-500 flex flex-col justify-between">
                    <div>
                        <p class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-3">ระยะเวลาเฉลี่ย
                            (AVG)</p>
                        <div class="flex flex-col items-center justify-center py-1">
                            <span class="text-3xl font-black text-amber-600" id="stat-avg-time">--</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">เวลาเตรียมและจัดส่ง</span>
                        </div>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="stat-avg-progress" class="h-full bg-amber-400 transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Sales List Side -->
                <div class="w-full">
                    <div class="glass rounded-3xl shadow-xl overflow-hidden border border-white/20">
                        <div
                            class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-wrap justify-between items-center gap-4 bg-white/50 dark:bg-slate-800/50">
                            <div>
                                <h2 class="font-black text-lg flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-lineman/10 flex items-center justify-center"><i
                                            class="fas fa-history text-lineman text-sm"></i></div>
                                    ประวัติยอดขาย
                                </h2>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">
                                    Transaction History</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="month" id="monthFilter" onchange="renderUI()"
                                    class="text-xs p-2.5 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-lineman outline-none">
                                <button onclick="openImportModal()"
                                    class="px-4 py-2.5 rounded-xl bg-lineman/10 text-lineman font-bold hover:bg-lineman hover:text-white transition-all text-xs border border-lineman/20">
                                    <i class="fas fa-file-import mr-2"></i> IMPORT
                                </button>
                                <div
                                    class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-xl p-1 border border-slate-200 dark:border-slate-700">
                                    <button onclick="exportSalesCSV()"
                                        class="px-3 py-2 rounded-lg text-slate-500 hover:text-blue-500 hover:bg-white dark:hover:bg-slate-700 transition-all text-[10px] font-bold"
                                        title="Export CSV">
                                        CSV
                                    </button>
                                    <button onclick="exportBackupJSON()"
                                        class="px-3 py-2 rounded-lg text-slate-500 hover:text-amber-600 hover:bg-white dark:hover:bg-slate-700 transition-all text-[10px] font-bold"
                                        title="Backup JSON">
                                        JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="date-pagination"
                            class="px-6 py-3 bg-slate-50/50 dark:bg-slate-800/30 flex gap-2 overflow-x-auto border-b border-slate-100 dark:border-slate-700 no-scrollbar items-center min-h-[60px]">
                            <!-- Date buttons will be rendered here -->
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse text-sm">
                                <thead
                                    class="bg-slate-100/50 dark:bg-slate-800/50 uppercase text-[10px] font-bold text-slate-500 tracking-widest">
                                    <tr>
                                        <th class="p-4 border-b dark:border-slate-700">วันที่ / Order</th>
                                        <th class="p-4 border-b dark:border-slate-700">ลูกค้า / รายการ</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-right">ยอดรวม (Gross)</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-right">ยอดจริง (Net)</th>
                                        <th class="p-4 border-b dark:border-slate-700 text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTable" class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <!-- Rendered Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <div id="importModal"
        class="fixed inset-0 bg-black/60 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass p-6 rounded-3xl shadow-2xl w-full max-w-2xl border border-white/20">
            <h3 class="text-xl font-black mb-2">นำเข้าข้อมูลจาก LINE MAN Report</h3>
            <p class="text-xs text-slate-500 mb-4">ลากไฟล์ CSV มาวาง หรือคัดลอกข้อมูลมาวางในช่องด้านล่างนี้</p>

            <!-- Drag & Drop Zone -->
            <div id="dropZone"
                class="w-full p-8 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-center mb-4 transition-all hover:bg-lineman/5 hover:border-lineman cursor-pointer group"
                onclick="document.getElementById('fileInput').click()" ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)" ondrop="handleDropFile(event)">
                <i class="fas fa-file-csv text-4xl text-slate-300 group-hover:text-lineman mb-3 transition-colors"></i>
                <p class="text-sm font-bold text-slate-600 dark:text-slate-300">ลากไฟล์ CSV มาวางที่นี่
                    หรือคลิกเพื่อเลือกไฟล์</p>
                <p class="text-[10px] text-slate-400 mt-1">รองรับเฉพาะไฟล์ .csv จากระบบ LINE MAN</p>
                <input type="file" id="fileInput" class="hidden" accept=".csv" onchange="handleFileSelect(event)">
            </div>

            <div class="relative mb-4">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-200 dark:border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span
                        class="px-2 bg-white dark:bg-slate-900 text-[10px] text-gray-500 uppercase font-black tracking-widest">หรือ
                        วางข้อมูลที่นี่</span>
                </div>
            </div>

            <textarea id="csvInput" rows="5"
                class="w-full p-4 rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 outline-none text-xs font-mono mb-4"
                placeholder="OrderID,OrderTime,SettlementTime,..."></textarea>

            <div class="flex gap-3">
                <button onclick="processCSV()"
                    class="flex-1 py-4 bg-lineman text-white rounded-2xl font-bold shadow-lg">เริ่มนำเข้าข้อมูล</button>
                <button onclick="closeImportModal()"
                    class="px-8 py-4 bg-slate-200 dark:bg-slate-700 rounded-2xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Sales Record Modal -->
    <div id="recordModal"
        class="fixed inset-0 bg-black/60 z-[115] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
        <div
            class="glass p-6 rounded-3xl shadow-2xl w-full max-w-xl border border-white/20 max-h-[95vh] overflow-y-auto no-scrollbar">
            <h2
                class="text-xl font-black mb-6 flex items-center gap-3 sticky top-0 bg-white/10 dark:bg-slate-900/10 backdrop-blur-md py-2 -mx-2 px-2 rounded-xl">
                <div class="w-10 h-10 rounded-xl bg-lineman/10 flex items-center justify-center">
                    <i class="fas fa-plus text-lineman text-lg"></i>
                </div>
                <span>บันทึกยอดขายใหม่</span>
                <span id="autosave-status"
                    class="ml-auto text-[9px] font-bold text-slate-400 opacity-0 transition-opacity uppercase tracking-widest">
                    <i class="fas fa-save mr-1"></i> Draft Saved
                </span>
                <button onclick="closeRecordModal()" class="ml-4 text-slate-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </h2>

            <form id="salesForm" class="space-y-4" novalidate>
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="vibrant-label">วันที่ขาย</label>
                        <input type="date" id="recordDate" class="premium-input font-bold">
                    </div>
                    <div class="col-span-1">
                        <label class="vibrant-label text-center block">เวลาสั่ง</label>
                        <div class="flex items-center gap-1 premium-input !py-2.5 px-2">
                            <input type="number" id="orderHH" min="0" max="23" placeholder="00"
                                class="w-full bg-transparent text-center font-black text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                            <span class="font-bold text-slate-300">:</span>
                            <input type="number" id="orderMM" min="0" max="59" placeholder="00"
                                class="w-full bg-transparent text-center font-black text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                        </div>
                    </div>
                    <div class="col-span-1 opacity-60 transition-opacity" id="received-time-container-add">
                        <label class="vibrant-label text-center block text-[10px]">เวลารับสินค้า</label>
                        <div class="flex items-center gap-1 premium-input !py-2.5 px-2 bg-blue-50/30">
                            <input type="number" id="receivedHH" min="0" max="23" placeholder="00"
                                class="w-full bg-transparent text-center font-bold text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                            <span class="font-bold text-slate-300">:</span>
                            <input type="number" id="receivedMM" min="0" max="59" placeholder="00"
                                class="w-full bg-transparent text-center font-bold text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="vibrant-label">วันที่รับสินค้า (ถ้าต่างจากวันสั่ง)</label>
                        <input type="date" id="receivedDate" class="premium-input text-sm font-bold">
                    </div>
                    <div class="col-span-2">
                        <label class="vibrant-label" style="color: #00B14F;">เลขออเดอร์ (เต็ม)</label>
                        <input type="text" id="orderIdFull" placeholder="LME-XXXXXX" oninput="autoFillShortOrderId()"
                            class="premium-input uppercase font-semibold" style="border-color: rgba(0, 177, 79, 0.2);">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label class="vibrant-label">4 หลักท้าย</label>
                        <input type="text" id="orderId" placeholder="0001" maxlength="4"
                            class="premium-input text-center font-black">
                    </div>
                    <div>
                        <label class="vibrant-label">เบอร์โทร (Optional)</label>
                        <input type="tel" id="customerPhone" placeholder="08x-xxx-xxxx" class="premium-input">
                    </div>
                </div>

                <div>
                    <label class="vibrant-label">ชื่อลูกค้า</label>
                    <input type="text" id="customerName" placeholder="ระบุชื่อลูกค้า" class="premium-input">
                </div>

                <div class="border-t-2 border-slate-100 dark:border-slate-800 pt-5">
                    <div class="flex justify-between items-center mb-3">
                        <label class="vibrant-label" style="color: #00B14F; margin-bottom: 0;">รายการสินค้า
                            (Master)</label>
                        <div class="flex gap-2">
                            <button type="button" onclick="smartImport('items-container')"
                                class="text-[10px] font-black text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1.5 rounded-xl transition-all border border-blue-100 dark:border-blue-900/30">
                                <i class="fas fa-magic mr-1"></i> วางรายการ
                            </button>
                            <button type="button" onclick="addItemRow()"
                                class="text-[11px] font-black text-lineman hover:bg-lineman/10 px-3 py-1.5 rounded-xl transition-all border border-lineman/10">+
                                เพิ่มรายการ</button>
                        </div>
                    </div>
                    <div id="items-container" class="space-y-3">
                        <!-- Item rows -->
                    </div>
                </div>

                <div class="pt-5 border-t-2 border-slate-100 dark:border-slate-800">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div
                            class="flex items-center gap-3 p-3 bg-rose-50/50 dark:bg-rose-900/10 rounded-2xl border border-rose-100/50 dark:border-rose-900/30">
                            <input type="checkbox" id="isNoFee" onchange="calculateNet()"
                                class="w-5 h-5 rounded-lg border-rose-300 text-rose-600 focus:ring-rose-500 cursor-pointer">
                            <label for="isNoFee"
                                class="text-[11px] font-black text-rose-600 dark:text-rose-400 uppercase tracking-widest cursor-pointer">รายการนี้ไม่มี
                                FEE</label>
                        </div>
                        <div
                            class="flex items-center gap-3 p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-2xl border border-blue-100/50 dark:border-blue-900/30">
                            <input type="checkbox" id="isManualNet" onchange="toggleManualNet()"
                                class="w-5 h-5 rounded-lg border-blue-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            <label for="isManualNet"
                                class="text-[11px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest cursor-pointer">ระบุยอดสุทธิเอง</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="vibrant-label">ยอดรวม (Gross)</label>
                            <div class="relative">
                                <input type="number" id="grossAmount" step="0.01" readonly
                                    class="premium-input pl-12 !bg-slate-100 dark:!bg-slate-900 border-dashed !text-slate-400 cursor-not-allowed">
                                <span class="absolute left-4 top-4 text-slate-400 font-bold">฿</span>
                            </div>
                        </div>
                        <div id="manual-net-box" class="hidden">
                            <label class="vibrant-label" style="color: #2563eb;">ยอดรับจริง (Net Override)</label>
                            <div class="relative">
                                <input type="number" id="manualNet" step="0.01" oninput="calculateNet()"
                                    class="premium-input"
                                    style="border-color: #3b82f6; font-weight: 900; color: #1e40af;">
                                <span class="absolute left-4 top-4 text-blue-500 font-bold">฿</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-gradient-to-br from-lineman/10 to-transparent dark:from-lineman/20 dark:to-transparent p-6 rounded-[2rem] border-2 border-lineman/20 shadow-inner">
                    <div class="flex justify-between items-end">
                        <div class="flex flex-col">
                            <span class="vibrant-label" style="margin-left: 0;">ยอดรวมทั้งหมด</span>
                            <span class="text-xl font-bold text-slate-600 dark:text-slate-300"
                                id="display-gross">฿0.00</span>
                        </div>
                        <div class="text-right flex flex-col">
                            <span class="vibrant-label font-black"
                                style="color: #00B14F; margin-right: 0;">ยอดรับสุทธิจริง (NET)</span>
                            <span class="text-3xl font-black text-lineman" id="calc-net">฿0.00</span>
                        </div>
                    </div>
                    <div
                        class="mt-4 pt-3 border-t border-dashed border-lineman/30 flex justify-between items-center text-xs font-black text-rose-500">
                        <span>ค่าธรรมเนียม GP (30%)</span>
                        <span id="calc-gp" class="bg-rose-50 dark:bg-rose-900/30 px-2 py-1 rounded-lg">-฿0.00</span>
                    </div>
                </div>

                <div>
                    <label class="vibrant-label">รายละเอียด / หมายเหตุเพิ่มเติม</label>
                    <textarea id="notes" rows="2" class="premium-input text-sm"
                        placeholder="ระบุเมนูพิเศษ หรือบันทึกช่วยจำ..."></textarea>
                </div>

                <div
                    class="mt-4 p-5 rounded-[2rem] bg-emerald-50/50 dark:bg-emerald-900/10 border-2 border-emerald-100 dark:border-emerald-900/30">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="isPaid" onchange="togglePaidSection('add')"
                                class="w-7 h-7 rounded-xl border-2 border-emerald-300 text-emerald-500 focus:ring-emerald-500 cursor-pointer transition-all">
                        </div>
                        <label for="isPaid"
                            class="text-sm font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-widest cursor-pointer">ได้รับเงินแล้ว
                            (PAID)</label>
                    </div>
                    <div id="paid-details-add"
                        class="hidden grid grid-cols-2 gap-4 animate-in slide-in-from-top-2 duration-300">
                        <div>
                            <label
                                class="text-[10px] uppercase font-black text-slate-400 mb-1.5 block ml-2">วันที่รับเงิน</label>
                            <input type="date" id="paidDate" class="premium-input !py-3 text-sm font-bold">
                        </div>
                        <div>
                            <label
                                class="text-[10px] uppercase font-black text-slate-400 mb-1.5 block ml-2">เวลารับโอน</label>
                            <div class="flex items-center gap-2 premium-input !py-3">
                                <input type="number" id="transferHH" min="0" max="23" placeholder="00"
                                    class="w-full bg-transparent text-center font-black outline-none text-base"
                                    oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                                <span class="text-slate-300 font-bold">:</span>
                                <input type="number" id="transferMM" min="0" max="59" placeholder="00"
                                    class="w-full bg-transparent text-center font-black outline-none text-base"
                                    oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submitBtn"
                    class="w-full py-5 bg-gradient-to-r from-lineman to-green-600 text-white rounded-[2rem] text-xl font-black shadow-xl shadow-green-500/30 transition-all transform active:scale-[0.98] flex items-center justify-center gap-3">
                    <i class="fas fa-check-circle text-2xl"></i> บันทึกยอดขาย
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Modal (Premium Refined) -->
    <div id="editModal"
        class="fixed inset-0 bg-black/60 z-[120] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
        <div
            class="glass p-6 rounded-3xl shadow-2xl w-full max-w-xl border border-white/20 max-h-[95vh] overflow-y-auto no-scrollbar">
            <h3
                class="text-xl font-black mb-6 flex items-center gap-3 sticky top-0 bg-white/10 dark:bg-slate-900/10 backdrop-blur-md py-2 -mx-2 px-2 rounded-xl">
                <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center">
                    <i class="fas fa-edit text-blue-500 text-lg"></i>
                </div>
                <span>แก้ไขยอดขาย</span>
                <button onclick="closeEditModal()" class="ml-auto text-slate-400 hover:text-rose-500 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </h3>
            <form id="editForm" class="space-y-4" novalidate>
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="vibrant-label">วันที่ขาย</label>
                        <input type="date" id="e-recordDate" class="premium-input font-bold">
                    </div>
                    <div class="col-span-1">
                        <label class="vibrant-label text-center block">เวลาสั่ง</label>
                        <div class="flex items-center gap-1 premium-input !py-2.5 px-2">
                            <input type="number" id="e-orderHH" min="0" max="23" placeholder="00"
                                class="w-full bg-transparent text-center font-black text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                            <span class="font-bold text-slate-300 text-sm">:</span>
                            <input type="number" id="e-orderMM" min="0" max="59" placeholder="00"
                                class="w-full bg-transparent text-center font-black text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                        </div>
                    </div>
                    <div class="col-span-1 opacity-60 transition-opacity" id="received-time-container-edit">
                        <label class="vibrant-label text-center block text-[10px]">เวลารับสินค้า</label>
                        <div class="flex items-center gap-1 premium-input !py-2.5 px-2 bg-blue-50/30">
                            <input type="number" id="e-receivedHH" min="0" max="23" placeholder="00"
                                class="w-full bg-transparent text-center font-bold text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                            <span class="font-bold text-slate-300 text-sm">:</span>
                            <input type="number" id="e-receivedMM" min="0" max="59" placeholder="00"
                                class="w-full bg-transparent text-center font-bold text-lg outline-none"
                                oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label class="vibrant-label">วันที่รับสินค้า</label>
                        <input type="date" id="e-receivedDate" class="premium-input text-sm font-bold">
                    </div>
                    <div class="col-span-2">
                        <label class="vibrant-label" style="color: #3b82f6;">เลขออเดอร์ (เต็ม)</label>
                        <input type="text" id="e-orderIdFull" oninput="autoFillShortOrderIdPopup()"
                            class="premium-input text-sm font-semibold" style="border-color: rgba(59, 130, 246, 0.2);">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="vibrant-label">4 หลักท้าย</label>
                        <input type="text" id="e-orderId" maxlength="4"
                            class="premium-input text-center font-black text-sm">
                    </div>
                    <div>
                        <label class="vibrant-label">เบอร์โทร</label>
                        <input type="tel" id="e-customerPhone" class="premium-input">
                    </div>
                </div>

                <div>
                    <label class="vibrant-label">ชื่อลูกค้า</label>
                    <input type="text" id="e-customerName" class="premium-input">
                </div>

                <div class="border-t-2 border-slate-100 dark:border-slate-800 pt-5">
                    <div class="flex justify-between items-center mb-3">
                        <label class="vibrant-label" style="color: #3b82f6; margin-bottom: 0;">รายการสินค้า
                            (Edit)</label>
                        <div class="flex gap-2">
                            <button type="button" onclick="smartImport('e-items-container')"
                                class="text-[10px] font-black text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1.5 rounded-xl transition-all border border-blue-100 dark:border-blue-900/30">
                                <i class="fas fa-magic mr-1"></i> วางรายการ
                            </button>
                            <button type="button" onclick="addItemRow({name:'', qty:1, price:0}, 'e-items-container')"
                                class="text-[11px] font-black text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 px-3 py-1.5 rounded-xl transition-all border border-blue-100/50">+
                                เพิ่มรายการ</button>
                        </div>
                    </div>
                    <div id="e-items-container" class="space-y-3 mb-4">
                        <!-- Item rows for edit -->
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="vibrant-label">ยอดขายเต็ม (Gross)</label>
                        <div class="relative">
                            <input type="number" id="e-grossAmount" step="0.01" oninput="calculateNetPopup()"
                                class="premium-input pl-12 font-black text-lg" readonly
                                style="background-color: #f1f5f9; border-style: dashed; color: #94a3b8; cursor: not-allowed;">
                            <span class="absolute left-4 top-4 text-slate-400 font-bold">฿</span>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-gradient-to-br from-blue-50 to-white dark:from-blue-900/20 dark:to-slate-900/50 p-5 rounded-[2rem] border-2 border-blue-100 dark:border-blue-900/30 flex flex-col gap-3 shadow-inner">
                    <div class="grid grid-cols-2 gap-3 pb-2 border-b border-blue-100 dark:border-blue-900/30">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="e-isNoFee" onchange="calculateNetPopup()"
                                class="w-5 h-5 rounded-lg border-rose-300 text-rose-600 focus:ring-rose-500 cursor-pointer">
                            <label for="e-isNoFee"
                                class="text-[11px] font-black text-rose-600 dark:text-rose-400 uppercase tracking-widest cursor-pointer">ไม่มี
                                FEE</label>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="e-isManualNet" onchange="toggleManualNet('edit')"
                                class="w-5 h-5 rounded-lg border-blue-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            <label for="e-isManualNet"
                                class="text-[11px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest cursor-pointer">ระบุสุทธิเอง</label>
                        </div>
                    </div>

                    <div id="e-manual-net-box" class="hidden mb-2">
                        <label class="vibrant-label" style="color: #2563eb;">ยอดรับจริง (Net Override)</label>
                        <div class="relative">
                            <input type="number" id="e-manualNet" step="0.01" oninput="calculateNetPopup()"
                                class="premium-input !py-2.5"
                                style="border-color: #3b82f6; font-weight: 900; color: #1e40af;">
                            <span class="absolute left-4 top-3 text-blue-500 font-bold">฿</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="vibrant-label !mb-0" style="color: #2563eb;">ยอดรับสุทธิ (NET)</span>
                        <span class="text-3xl font-black text-blue-600 drop-shadow-sm" id="e-calc-net">฿0.00</span>
                    </div>
                </div>

                <div>
                    <label class="vibrant-label">รายละเอียดเพิ่มเติม</label>
                    <textarea id="e-notes" rows="1" class="premium-input text-xs"></textarea>
                </div>

                <div
                    class="mt-2 p-4 rounded-2xl bg-slate-50 border border-slate-100 dark:bg-slate-800/50 dark:border-slate-700/50">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="e-isPaid" onchange="togglePaidSection('edit')"
                                class="w-6 h-6 rounded-lg border-2 border-emerald-300 text-emerald-500 focus:ring-emerald-500 cursor-pointer transition-all">
                        </div>
                        <label for="e-isPaid"
                            class="text-sm font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-wider cursor-pointer">ได้รับเงินแล้ว
                            (PAID)</label>
                    </div>
                    <div id="paid-details-edit" class="hidden animate-in fade-in duration-300 mt-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">วันที่รับเงิน</label>
                                <input type="date" id="e-paidDate" class="premium-input font-bold">
                            </div>
                            <div>
                                <label
                                    class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">เวลารับโอน</label>
                                <div class="flex items-center gap-2 premium-input !py-2.5">
                                    <input type="number" id="e-transferHH" min="0" max="23" placeholder="00"
                                        class="w-full bg-transparent text-center font-black outline-none text-base"
                                        oninput="if(value.length>2)value=value.slice(0,2); if(value>23)value=23;">
                                    <span class="text-slate-300 font-bold">:</span>
                                    <input type="number" id="e-transferMM" min="0" max="59" placeholder="00"
                                        class="w-full bg-transparent text-center font-black outline-none text-base"
                                        oninput="if(value.length>2)value=value.slice(0,2); if(value>59)value=59;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 pt-5">
                    <button type="submit"
                        class="flex-1 py-5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-[2rem] font-black shadow-xl shadow-blue-500/30 active:scale-[0.98] transition-all">บันทึกการแก้ไข</button>
                    <button type="button" onclick="closeEditModal()"
                        class="px-10 py-5 bg-slate-100 dark:bg-slate-800 rounded-[2rem] font-bold active:scale-[0.98] transition-all text-slate-500">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let salesData = [];
        let masterProducts = [];
        let currentUser = null;
        let editIndex = null;
        let editingUid = null;
        let currentSelectedDate = null; // null means "All" or "Default to Today"
        const GP_RATE = 0.30; // GP 30% รวม VAT

        function togglePaidSection(mode) {
            const isPaid = document.getElementById(mode === 'add' ? 'isPaid' : 'e-isPaid').checked;
            const container = document.getElementById(mode === 'add' ? 'paid-details-add' : 'paid-details-edit');
            // Update: We don't really use separate timeContainer for paid anymore in the same way, 
            // but let's keep it safe. Actually, the transfer fields are inside 'container'.

            if (isPaid) {
                container.classList.remove('hidden');
                // Set default now if empty
                const dateField = document.getElementById(mode === 'add' ? 'paidDate' : 'e-paidDate');
                if (!dateField.value) {
                    const now = new Date();
                    dateField.value = now.toISOString().split('T')[0];
                    document.getElementById(mode === 'add' ? 'transferHH' : 'e-transferHH').value = now.getHours().toString().padStart(2, '0');
                    document.getElementById(mode === 'add' ? 'transferMM' : 'e-transferMM').value = now.getMinutes().toString().padStart(2, '0');
                }
            } else {
                container.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDefaults();
            checkAuth();
            loadDraft();
            setupAutosave();
        });

        async function syncMasterData() {
            try {
                const snapshot = await window.db.collection('master_products').get();
                masterProducts = snapshot.docs.map(doc => ({ name: doc.id, ...doc.data() }));
                updateDatalist();
            } catch (err) { console.error("Master Sync Error", err); }
        }

        function updateDatalist() {
            let dl = document.getElementById('master-list');
            if (!dl) {
                dl = document.createElement('datalist');
                dl.id = 'master-list';
                document.body.appendChild(dl);
            }
            dl.innerHTML = masterProducts.map(p => `<option value="${p.name}">`).join('');
        }

        function autoFillShortOrderId() {
            const full = document.getElementById('orderIdFull').value.trim();
            if (full.length >= 4) {
                document.getElementById('orderId').value = full.slice(-4).toUpperCase();
            }
        }

        function autoFillShortOrderIdPopup() {
            const full = document.getElementById('e-orderIdFull').value.trim();
            if (full.length >= 4) {
                document.getElementById('e-orderId').value = full.slice(-4).toUpperCase();
            }
        }

        function toggleManualNet(mode = 'add') {
            const pref = mode === 'edit' ? 'e-' : '';
            const isManual = document.getElementById(`${pref}isManualNet`).checked;
            const box = document.getElementById(`${pref}manual-net-box`);
            if (box) box.classList.toggle('hidden', !isManual);

            if (mode === 'edit') calculateNetPopup();
            else calculateNet();
        }

        function addItemRow(data = { name: '', qty: 1, price: 0 }, containerId = 'items-container') {
            const container = document.getElementById(containerId);
            const id = Date.now() + Math.random();
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 bg-white dark:bg-slate-800 p-2 rounded-xl border border-slate-100 dark:border-slate-700 item-row";
            div.dataset.id = id;

            const calcFunc = containerId === 'items-container' ? 'calculateTotalFromItems()' : 'calculateTotalFromItems(\'e-items-container\', \'e-grossAmount\')';

            div.innerHTML = `
                <input type="text" placeholder="ชื่อสินค้า..." class="item-name w-1/2 bg-white dark:bg-slate-900 border-none outline-none text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-lineman/20 rounded-lg py-1 px-2" list="master-list" onchange="handleItemChange(this, '${containerId}')">
                <div class="flex items-center bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-100 dark:border-slate-800 ml-auto">
                    <input type="number" placeholder="ชิ้น" class="item-qty w-12 bg-transparent border-none text-center text-xs font-black outline-none py-1" oninput="${calcFunc}">
                    <span class="text-[8px] text-slate-300 font-bold px-1">x</span>
                    <input type="number" step="0.01" placeholder="ราคา" class="item-price w-16 bg-transparent border-none text-center text-xs font-black outline-none py-1" oninput="${calcFunc}">
                </div>
                <button type="button" onclick="this.closest('.item-row').remove(); ${calcFunc};" class="w-6 h-6 flex items-center justify-center text-rose-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-md transition-all">
                    <i class="fas fa-times-circle text-[10px]"></i>
                </button>
            `;

            // Set values safely
            div.querySelector('.item-name').value = data.name || '';
            div.querySelector('.item-qty').value = data.qty || 1;
            div.querySelector('.item-price').value = data.price || 0;

            container.appendChild(div);
        }

        function handleItemPriceAutoCalc(input, type, containerId) {
            const row = input.closest('.item-row');
            const qtyInput = row.querySelector('.item-qty');
            const priceInput = row.querySelector('.item-price');
            // item-total removed in new UI, we calculate totalGross instead

            if (containerId === 'items-container') {
                calculateTotalFromItems();
            } else {
                calculateTotalFromItems('e-items-container', 'e-grossAmount');
            }
        }

        function handleItemChange(input, containerId = 'items-container') {
            try {
                const name = input.value.trim();
                const master = masterProducts.find(p => p.name === name);
                if (master) {
                    let price = 0;
                    if (master.prices) {
                        price = master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0;
                    }
                    const row = input.closest('.item-row');
                    if (row) {
                        const pInput = row.querySelector('.item-price');
                        if (pInput) pInput.value = price;

                        // just trigger gross recalc
                        if (containerId === 'items-container') {
                            calculateTotalFromItems();
                        } else {
                            calculateTotalFromItems('e-items-container', 'e-grossAmount');
                        }
                    }
                }
            } catch (err) { console.error("handleItemChange error:", err); }
        }

        function calculateTotalFromItems(containerId = 'items-container', displayId = 'grossAmount') {
            let totalGross = 0;
            const container = document.getElementById(containerId);
            if (!container) return;

            container.querySelectorAll('.item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                totalGross += (qty * price);
            });
            document.getElementById(displayId).value = totalGross.toFixed(2);

            if (displayId === 'grossAmount') {
                calculateNet();
            } else {
                calculateNetPopup();
            }
        }

        function smartImport(containerId) {
            Swal.fire({
                title: 'Smart Import รายการ',
                input: 'textarea',
                inputPlaceholder: 'วางรายการจาก LINE MAN ที่นี่...\n(เช่น ชื่อสินค้า 1|ชื่อสินค้า 2)',
                showCancelButton: true,
                confirmButtonText: 'นำเข้า',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#00B14F'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const raw = result.value.trim();
                    // Split by | or newline
                    const parts = raw.split(/[|\n]/);

                    parts.forEach(part => {
                        let text = part.trim();
                        if (!text) return;

                        // Clean quotes if present
                        text = text.replace(/^["']|["']$/g, '');

                        // Pattern: [Name] [Quantity]
                        // Use regex to find the last space followed by a number
                        const match = text.match(/(.*)\s+(\d+)$/);
                        let name = text;
                        let qty = 1;

                        if (match) {
                            name = match[1].trim();
                            qty = parseInt(match[2]) || 1;
                        }

                        // Lookup Price
                        const master = masterProducts.find(p => p.name === name);
                        let price = 0;
                        if (master && master.prices) {
                            price = master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0;
                        }

                        addItemRow({ name, qty, price }, containerId);
                    });

                    if (containerId === 'items-container') {
                        calculateTotalFromItems();
                    } else {
                        calculateTotalFromItems('e-items-container', 'e-grossAmount');
                    }
                }
            });
        }

        function calculateNet() {
            const gross = parseFloat(document.getElementById('grossAmount').value) || 0;
            const isManual = document.getElementById('isManualNet').checked;
            const isNoFee = document.getElementById('isNoFee').checked;
            const manual = parseFloat(document.getElementById('manualNet').value) || 0;

            let gp = isNoFee ? 0 : gross * GP_RATE;
            let net = gross - gp;

            if (isManual) {
                net = manual;
                gp = gross - net;
            }

            const displayGross = document.getElementById('display-gross');
            if (displayGross) displayGross.innerText = `฿${gross.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

            document.getElementById('calc-gp').innerText = `-฿${gp.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
            document.getElementById('calc-net').innerText = `฿${net.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

            // Visual fee indicator
            const feeRow = document.getElementById('calc-gp').parentElement;
            if (feeRow) feeRow.classList.toggle('opacity-30', isNoFee);
        }

        function initDefaults() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            document.getElementById('receivedDate').value = today;
            document.getElementById('paidDate').value = today;

            const hours = now.getHours().toString().padStart(2, '0');
            const mins = now.getMinutes().toString().padStart(2, '0');

            document.getElementById('orderHH').value = hours;
            document.getElementById('orderMM').value = mins;

            document.getElementById('receivedHH').value = '';
            document.getElementById('receivedMM').value = '';

            document.getElementById('transferHH').value = hours;
            document.getElementById('transferMM').value = mins;

            // Sync Received/Paid Dates whenever Record Date changes (if they were same)
            document.getElementById('recordDate').onchange = (e) => {
                const rd = document.getElementById('receivedDate');
                const pd = document.getElementById('paidDate');
                if (!rd.dataset.manual) rd.value = e.target.value;
                if (!pd.dataset.manual) pd.value = e.target.value;
            };
            document.getElementById('receivedDate').oninput = (e) => { e.target.dataset.manual = "true"; };
            document.getElementById('paidDate').oninput = (e) => { e.target.dataset.manual = "true"; };

            // Same for Edit Modal
            document.getElementById('e-recordDate').onchange = (e) => {
                const erd = document.getElementById('e-receivedDate');
                const epd = document.getElementById('e-paidDate');
                if (!erd.dataset.manual) erd.value = e.target.value;
                if (!epd.dataset.manual) epd.value = e.target.value;
            };
            document.getElementById('e-receivedDate').oninput = (e) => { e.target.dataset.manual = "true"; };
            document.getElementById('e-paidDate').oninput = (e) => { e.target.dataset.manual = "true"; };

            document.getElementById('monthFilter').value = now.toISOString().slice(0, 7);

            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function checkAuth() {
            const timer = setInterval(() => {
                if (window.auth) {
                    clearInterval(timer);
                    window.auth.onAuthStateChanged(user => {
                        document.getElementById('loading').style.display = 'none';
                        if (user) {
                            currentUser = user;
                            document.getElementById('login-container').style.display = 'none';
                            document.getElementById('app-container').style.display = 'block';
                            syncData();
                            syncMasterData();
                        } else {
                            document.getElementById('app-container').style.display = 'none';
                            document.getElementById('login-container').style.display = 'flex';
                        }
                    });
                }
            }, 100);
        }

        async function syncData() {
            window.db.collection('system').doc('lineman_sales').onSnapshot(doc => {
                if (doc.exists) {
                    salesData = doc.data().records || [];
                    renderUI();
                } else {
                    window.db.collection('system').doc('lineman_sales').set({ records: [] });
                }
            });
        }

        function setDateFilter(date) {
            currentSelectedDate = date;
            renderUI();
        }

        function openRecordModal() {
            document.getElementById('recordModal').classList.remove('hidden');
        }

        function closeRecordModal() {
            document.getElementById('recordModal').classList.add('hidden');
        }


        function calculatePerformance(d1, t1, d2, t2) {
            if (!d1 || !t1 || !d2 || !t2) return null;
            try {
                // Parse components explicitly to ensure local time context
                const [y1, m1, dd1] = d1.split('-').map(Number);
                const [h1, mm1] = t1.split(':').map(Number);
                const [y2, m2, dd2] = d2.split('-').map(Number);
                const [h2, mm2] = t2.split(':').map(Number);

                const start = new Date(y1, m1 - 1, dd1, h1, mm1, 0);
                const end = new Date(y2, m2 - 1, dd2, h2, mm2, 0);

                const diffMs = end - start;
                if (diffMs < 0) return null;

                const totalMins = Math.floor(diffMs / 60000);
                const days = Math.floor(totalMins / 1440);
                const hrs = Math.floor((totalMins % 1440) / 60);
                const mins = totalMins % 60;

                let label = '';
                if (days > 0) label += `${days}d `;
                if (hrs > 0 || days > 0) label += `${hrs}h `;
                label += `${mins}m`;

                let colorClass = 'text-emerald-600 bg-white'; // Fast < 30m
                if (totalMins > 1440) colorClass = 'text-rose-600 bg-rose-50'; // > 24h
                else if (totalMins > 120) colorClass = 'text-amber-600 bg-amber-50'; // > 2h
                else if (totalMins > 30) colorClass = 'text-blue-600 bg-blue-50'; // > 30m

                return { label: label.trim(), color: colorClass, totalMins };
            } catch (e) { return null; }
        }

        function renderUI() {
            const termMonth = document.getElementById('monthFilter').value;
            const now = new Date();
            const y = now.getFullYear();
            const m = (now.getMonth() + 1).toString().padStart(2, '0');
            const d = now.getDate().toString().padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;
            const currentYearStr = y.toString();

            // Stats Calculation
            let countToday = 0, countMonth = 0, countYear = 0;
            let netPaidMonth = 0, netPaidYear = 0;
            let totalPerfMins = 0, perfCount = 0;

            salesData.forEach(r => {
                const rDate = r.date || '';
                if (rDate === todayStr) countToday++;
                if (rDate.startsWith(termMonth)) {
                    countMonth++;
                    if (r.isPaid) netPaidMonth += (r.net || 0);
                }
                if (rDate.startsWith(currentYearStr)) {
                    countYear++;
                    if (r.isPaid) netPaidYear += (r.net || 0);
                }

                if (r.receivedTime) {
                    const perf = calculatePerformance(r.date, r.orderTime, r.receivedDate || r.date, r.receivedTime);
                    if (perf) {
                        totalPerfMins += perf.totalMins;
                        perfCount++;
                    }
                }
            });

            // Update Header Stats
            document.getElementById('stat-count-today').innerText = countToday;
            document.getElementById('stat-count-month').innerText = countMonth;
            document.getElementById('stat-count-year').innerText = countYear;
            document.getElementById('stat-net-month').innerText = `฿${netPaidMonth.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('stat-net-year').innerText = `฿${netPaidYear.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            if (perfCount > 0) {
                const avgMins = Math.round(totalPerfMins / perfCount);
                const h = Math.floor(avgMins / 60);
                const m = avgMins % 60;
                document.getElementById('stat-avg-time').innerText = h > 0 ? `${h}h ${m}m` : `${m}m`;
                const progress = Math.min(100, (avgMins / 90) * 100);
                const bar = document.getElementById('stat-avg-progress');
                if (bar) {
                    bar.style.width = `${progress}%`;
                    bar.className = `h-full transition-all duration-1000 ${avgMins > 45 ? (avgMins > 90 ? 'bg-rose-500' : 'bg-amber-400') : 'bg-emerald-500'}`;
                }
            } else {
                document.getElementById('stat-avg-time').innerText = '--';
                const bar = document.getElementById('stat-avg-progress');
                if (bar) bar.style.width = '0%';
            }

            // Filter for the month for the list view
            let filtered = salesData.filter(r => r.date.startsWith(termMonth));

            // Pagination Rendering
            const uniqueDates = [...new Set(filtered.map(r => r.date))].sort((a, b) => b.localeCompare(a));
            const pagin = document.getElementById('date-pagination');

            const formatDate = (ds) => {
                if (!ds) return '';
                const parts = ds.split('-');
                if (parts.length < 3) return ds;
                const [y, m, d] = parts;
                return `${d}/${m}/${y.slice(2)}`;
            };

            let paginHTML = `<button onclick="setDateFilter(null)" class="px-5 py-2.5 rounded-2xl text-xs font-black transition-all whitespace-nowrap ${!currentSelectedDate ? 'bg-lineman text-white shadow-lg shadow-green-500/20 scale-105' : 'bg-white dark:bg-slate-800 text-slate-400 hover:bg-slate-100 border border-slate-100 dark:border-slate-700'}">ทั้งหมด</button>`;

            uniqueDates.forEach(d => {
                const isActive = currentSelectedDate === d;
                paginHTML += `<button onclick="setDateFilter('${d}')" class="px-5 py-2.5 rounded-2xl text-xs font-black transition-all whitespace-nowrap ${isActive ? 'bg-lineman text-white shadow-lg shadow-green-500/20 scale-105' : 'bg-white dark:bg-slate-800 text-slate-400 hover:bg-slate-100 border border-slate-100 dark:border-slate-700'}">${formatDate(d)}</button>`;
            });
            if (pagin) pagin.innerHTML = paginHTML;

            // Apply Date Filter
            if (currentSelectedDate) {
                if (!uniqueDates.includes(currentSelectedDate)) {
                    currentSelectedDate = null;
                } else {
                    filtered = filtered.filter(r => r.date === currentSelectedDate);
                }
            }

            // Update Summary Labels
            const summaryLabel = currentSelectedDate ? `ประจำวันที่ ${formatDate(currentSelectedDate)}` : `ประจำเดือน ${termMonth}`;
            document.querySelectorAll('[id^="summary-"]').forEach(el => {
                const p = el.parentElement.querySelector('p');
                if (p && p.innerText.includes('วันนี้')) {
                    p.innerText = p.innerText.replace('วันนี้', currentSelectedDate ? 'ประจำวัน' : 'ประจำเดือน');
                }
            });

            // Calculate daily totals for PAID ribbons (using the month's filtered data to be consistent)
            const monthFiltered = salesData.filter(r => r.date.startsWith(termMonth));
            const dailyPaidTotals = {};
            monthFiltered.forEach(r => {
                if (r.isPaid) {
                    const pDate = r.paidDate || r.date;
                    dailyPaidTotals[pDate] = (dailyPaidTotals[pDate] || 0) + r.net;
                }
            });

            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = '';

            let dailyGross = 0; let dailyGP = 0; let dailyNet = 0; let dailyCount = 0;

            filtered.forEach((record, index) => {
                // Summary now reflects the filtered list (all month or specific day)
                dailyGross += record.gross;
                dailyGP += record.gp;
                dailyNet += record.net;
                dailyCount++;

                const isUpdated = (record.items && record.items.length > 0);
                let rowStyle = '';
                if (record.isPaid) {
                    rowStyle = '!bg-emerald-50/70 dark:!bg-emerald-900/30 border-l-[4px] border-emerald-500';
                } else if (isUpdated) {
                    rowStyle = '!bg-orange-50/80 dark:!bg-orange-900/30 border-l-[4px] border-orange-400';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${rowStyle} relative">
                        <td class="p-4 align-top">
                            <div class="text-[10px] font-black text-slate-500 dark:text-slate-400">${record.date}</div>
                            <div class="text-[11px] font-black text-blue-600 dark:text-blue-400 mb-1">${record.orderTime || '--:--'}</div>
                            
                            ${record.receivedTime ? `
                                <div class="flex items-center gap-1 text-[9px] font-bold text-amber-600 mb-1" title="เวลารับสินค้า: ${record.receivedDate} ${record.receivedTime}">
                                    <i class="fas fa-box-open"></i> ${record.receivedTime}
                                </div>
                                ${(() => {
                            const perf = calculatePerformance(record.date, record.orderTime, record.receivedDate || record.date, record.receivedTime);
                            return perf ? `
                                        <div class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-md ${perf.color} text-[8px] font-black shadow-sm mb-1">
                                            <i class="fas fa-bolt"></i> ${perf.label}
                                        </div>
                                    ` : '';
                        })()}
                            ` : ''}

                            <div class="inline-block bg-white dark:bg-slate-800 border-[1.5px] border-slate-200 dark:border-slate-700 px-2 py-0.5 rounded-md font-black text-slate-800 dark:text-slate-100 shadow-sm text-[11px] mb-1 tracking-tight">
                                ${record.orderId}
                            </div>
                            ${record.orderIdFull ? `<div class="text-[8px] text-slate-300 truncate max-w-[80px]">${record.orderIdFull}</div>` : ''}
                        </td>
                        <td class="p-4 align-top max-w-[200px]">
                            <div class="font-bold text-xs text-slate-800 dark:text-slate-100">${record.customerName || 'ลูกค้าทั่วไป'}</div>
                            <div class="text-[10px] text-slate-400 mb-1">${record.customerPhone || ''}</div>
                            
                            <div class="space-y-1">
                                ${(record.items || []).map(i => `
                                    <div class="flex justify-between text-[10px]">
                                        <span class="text-slate-500">${i.name} x${i.qty}</span>
                                        <span class="font-bold text-slate-400">฿${(i.qty * i.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="text-[10px] italic text-slate-400 mt-2 border-t border-slate-50 pt-1" title="${record.notes}">
                                ${record.notes || ''}
                                ${record.isPaid ? `
                                    <div class="mt-1 flex items-center gap-1 text-[9px] text-emerald-600 font-bold bg-emerald-100/50 px-2 py-0.5 rounded-full w-fit">
                                        <i class="fas fa-check-circle"></i> ได้รับเงิน: ${record.paidDate} ${record.paidTime}
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="text-[10px] ${record.isNoFee ? 'text-slate-300' : 'text-rose-400'} font-bold">
                                ${record.isNoFee ? '<span class="bg-rose-50 px-1 rounded text-[8px]">NO FEE</span>' : `-฿${record.gp.toLocaleString(undefined, { minimumFractionDigits: 2 })}`}
                            </div>
                            <div class="font-bold text-slate-400">฿${record.gross.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="font-black text-lineman text-lg">฿${record.net.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                        </td>
                        <td class="p-4 text-center relative max-w-[120px]">
                            ${record.isPaid ? `
                                <div class="mb-2 bg-emerald-500 text-white text-[9px] font-black px-4 py-2 rounded-lg shadow-sm uppercase tracking-tighter whitespace-nowrap flex flex-col items-center justify-center gap-1">
                                    <div class="flex items-center gap-1.5">
                                        <span>PAID ${record.paidDate || record.date} <span class="opacity-40 font-bold">///</span></span>
                                        <span class="text-[12px]">฿ ${dailyPaidTotals[record.paidDate || record.date].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="editRecord(${record.recordedAt})" class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-400 hover:text-blue-600 transition-all">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteRecord(${record.recordedAt})" class="w-8 h-8 rounded-lg bg-rose-50 dark:bg-rose-900/20 text-rose-400 hover:text-rose-600 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('summary-gross').innerText = `฿${dailyGross.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('summary-gp').innerText = `฿${dailyGP.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('summary-gross-label').innerText = `${dailyCount} รายการ`;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center text-slate-300 font-bold uppercase tracking-widest">No Sales Found</td></tr>`;
            }
        }

        document.getElementById('salesForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const vDate = document.getElementById('recordDate').value;
                const oId = document.getElementById('orderId').value;
                const grossVal = document.getElementById('grossAmount').value;

                if (!vDate || !oId || !grossVal || parseFloat(grossVal) <= 0) {
                    Swal.fire('ข้อมูลไม่ครบ', 'กรุณาระบุวันที่, ออเดอร์ และรายการสินค้าให้ครบถ้วน', 'warning');
                    return;
                }

                const gross = parseFloat(grossVal) || 0;
                const isManual = document.getElementById('isManualNet').checked;
                const manual = parseFloat(document.getElementById('manualNet').value) || 0;

                const isNoFee = document.getElementById('isNoFee').checked;
                let gp = isNoFee ? 0 : gross * GP_RATE;
                let net = gross - gp;

                if (isManual) {
                    net = manual;
                    gp = gross - net;
                }

                // Collect items - Fixed: Scope to items-container
                const items = [];
                const masterUpdates = [];
                const container = document.getElementById('items-container');
                container.querySelectorAll('.item-row').forEach(row => {
                    const nameInput = row.querySelector('.item-name');
                    const qtyInput = row.querySelector('.item-qty');
                    const priceInput = row.querySelector('.item-price');

                    const name = nameInput ? nameInput.value.trim() : '';
                    const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    const price = parseFloat(priceInput ? priceInput.value : 0) || 0;

                    if (name) items.push({ name, qty, price });
                    if (name && price > 0) masterUpdates.push({ name, price });
                });

                const hh = document.getElementById('orderHH')?.value?.toString()?.padStart(2, '0') || '00';
                const mm = document.getElementById('orderMM')?.value?.toString()?.padStart(2, '0') || '00';

                const rDate = document.getElementById('receivedDate')?.value || document.getElementById('recordDate')?.value;
                const rHH = document.getElementById('receivedHH')?.value?.toString()?.padStart(2, '0') || '00';
                const rMM = document.getElementById('receivedMM')?.value?.toString()?.padStart(2, '0') || '00';

                const isPaid = document.getElementById('isPaid').checked;
                const paidDate = document.getElementById('paidDate').value;
                const tHH = document.getElementById('transferHH')?.value?.toString()?.padStart(2, '0') || '00';
                const tMM = document.getElementById('transferMM')?.value?.toString()?.padStart(2, '0') || '00';

                const record = {
                    date: document.getElementById('recordDate').value,
                    orderTime: `${hh}:${mm}`,
                    receivedDate: rDate,
                    receivedTime: (rHH !== '00' || rMM !== '00') ? `${rHH}:${rMM}` : '',
                    orderId: document.getElementById('orderId').value,
                    orderIdFull: document.getElementById('orderIdFull').value,
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    gross: gross,
                    gp: gp,
                    net: net,
                    isManualNet: isManual,
                    isNoFee: isNoFee,
                    isPaid: isPaid,
                    paidDate: paidDate,
                    paidTime: isPaid ? `${tHH}:${tMM}` : '',
                    items: items,
                    notes: document.getElementById('notes').value,
                    recordedAt: new Date().getTime()
                };

                showLoading(true);

                // Master Update Logic
                for (const update of masterUpdates) {
                    const docId = update.name.replace(/\//g, '_'); // Firestore doc ID cannot contain /
                    const master = masterProducts.find(m => m.name === update.name);
                    try {
                        await window.db.collection('master_products').doc(docId).set({
                            prices: { ...(master?.prices || {}), 'LINEMAN': update.price }
                        }, { merge: true });
                    } catch (mErr) { console.warn("Master Update Failed for:", update.name, mErr); }
                }

                salesData.unshift(record);
                Swal.fire({ icon: 'success', title: 'บันทึกยอดขายแล้ว', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });

                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);

                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });

                closeRecordModal();
                document.getElementById('salesForm').reset();
                document.getElementById('items-container').innerHTML = '';
                document.getElementById('isManualNet').checked = false;
                toggleManualNet();
                initDefaults();
                calculateNet();
                clearDraft();
                syncMasterData();
            } catch (error) {
                console.error("Save Record Error:", error);
                Swal.fire('Error', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        // Modal Form Submit (Edit)
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            console.log("Edit Form Submit Triggered - UID:", editingUid);

            if (editingUid === null) {
                Swal.fire('Error', 'Session Expired: กรุณาปิดแล้วเปิดการแก้ไขใหม่อีกครั้ง', 'warning');
                return;
            }

            try {
                showLoading(true);

                // Manual Validation
                const vDate = document.getElementById('e-recordDate')?.value;
                const oId = document.getElementById('e-orderId')?.value;
                const grossVal = document.getElementById('e-grossAmount')?.value;

                if (!vDate || !oId || !grossVal || parseFloat(grossVal) <= 0) {
                    throw new Error("ข้อมูลไม่ครบถ้วน (วันที่, เลขออเดอร์ หรือรายการสินค้า)");
                }

                // Find target index
                const targetIdx = salesData.findIndex(r => r.recordedAt === editingUid);
                if (targetIdx === -1) throw new Error("ไม่พบข้อมูลรายการที่ต้องการแก้ไขในระบบ (Index Error)");

                const gross = parseFloat(grossVal) || 0;
                const isNoFee = document.getElementById('e-isNoFee')?.checked || false;
                const isManual = document.getElementById('e-isManualNet')?.checked || false;
                const manual = parseFloat(document.getElementById('e-manualNet')?.value || 0) || 0;

                let gp = isNoFee ? 0 : gross * GP_RATE;
                let net = gross - gp;
                if (isManual) {
                    net = manual;
                    gp = gross - net;
                }

                // Collect items
                const items = [];
                const masterUpdates = [];
                const eContainer = document.getElementById('e-items-container');
                if (eContainer) {
                    eContainer.querySelectorAll('.item-row').forEach(row => {
                        const n = row.querySelector('.item-name')?.value?.trim();
                        const q = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                        const p = parseFloat(row.querySelector('.item-price')?.value) || 0;
                        if (n) {
                            items.push({ name: n, qty: q, price: p });
                            if (p > 0) masterUpdates.push({ name: n, price: p });
                        }
                    });
                }

                const hh = document.getElementById('e-orderHH')?.value?.toString()?.padStart(2, '0') || '00';
                const mm = document.getElementById('e-orderMM')?.value?.toString()?.padStart(2, '0') || '00';
                const rDate = document.getElementById('e-receivedDate')?.value || document.getElementById('e-recordDate')?.value;
                const rHH = document.getElementById('e-receivedHH')?.value?.toString()?.padStart(2, '0') || '00';
                const rMM = document.getElementById('e-receivedMM')?.value?.toString()?.padStart(2, '0') || '00';

                const isPaid = document.getElementById('e-isPaid')?.checked || false;
                const pDate = document.getElementById('e-paidDate')?.value || '';
                const tHH = document.getElementById('e-transferHH')?.value?.toString()?.padStart(2, '0') || '00';
                const tMM = document.getElementById('e-transferMM')?.value?.toString()?.padStart(2, '0') || '00';

                const updatedRecord = {
                    ...salesData[targetIdx],
                    date: document.getElementById('e-recordDate')?.value || salesData[targetIdx].date,
                    orderTime: `${hh}:${mm}`,
                    receivedDate: rDate,
                    receivedTime: (rHH !== '00' || rMM !== '00') ? `${rHH}:${rMM}` : '',
                    orderId: document.getElementById('e-orderId')?.value || '',
                    orderIdFull: document.getElementById('e-orderIdFull')?.value || '',
                    customerName: document.getElementById('e-customerName')?.value || '',
                    customerPhone: document.getElementById('e-customerPhone')?.value || '',
                    gross: gross,
                    gp: gp,
                    net: net,
                    isNoFee: isNoFee,
                    isManualNet: isManual,
                    isPaid: isPaid,
                    paidDate: pDate,
                    paidTime: isPaid ? `${tHH}:${tMM}` : '',
                    items: items,
                    notes: document.getElementById('e-notes')?.value || ''
                };

                console.log("Saving Master Product Updates...");
                for (const update of masterUpdates) {
                    const docId = update.name.replace(/\//g, '_');
                    const master = masterProducts.find(m => m.name === update.name);
                    try {
                        await window.db.collection('master_products').doc(docId).set({
                            prices: { ...(master?.prices || {}), 'LINEMAN': update.price }
                        }, { merge: true });
                    } catch (mErr) { console.warn("Master Update Failed for:", update.name, mErr); }
                }

                console.log("Updating Sales Data...");
                const finalIdx = salesData.findIndex(r => r.recordedAt === editingUid);
                if (finalIdx !== -1) {
                    salesData[finalIdx] = updatedRecord;
                } else {
                    salesData.unshift(updatedRecord);
                }

                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);
                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });

                closeEditModal();
                Swal.fire({
                    icon: 'success',
                    title: 'แก้ไขข้อมูลสำเร็จ',
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
                syncMasterData();
            } catch (error) {
                console.error("Save Edit Error Details:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'บันทึกไม่สำเร็จ',
                    text: error.message,
                    footer: 'Debug: ' + (error.stack ? error.stack.split('\n')[0] : 'No stack')
                });
            } finally {
                showLoading(false);
            }
        };

        // --- Autosave System ---
        function setupAutosave() {
            const inputs = ['recordDate', 'orderId', 'customerName', 'customerPhone', 'grossAmount', 'notes'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', saveDraft);
            });
        }

        function saveDraft() {
            if (editIndex !== null) return;

            const draft = {
                date: document.getElementById('recordDate').value,
                orderHH: document.getElementById('orderHH').value,
                orderMM: document.getElementById('orderMM').value,
                orderId: document.getElementById('orderId').value,
                orderIdFull: document.getElementById('orderIdFull').value,
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                isManualNet: document.getElementById('isManualNet').checked,
                manualNet: document.getElementById('manualNet').value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    name: row.querySelector('.item-name').value,
                    qty: row.querySelector('.item-qty').value,
                    price: row.querySelector('.item-price').value
                })),
                notes: document.getElementById('notes').value,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('lineman_draft', JSON.stringify(draft));

            // Visual Feedback
            const status = document.getElementById('autosave-status');
            status.classList.remove('opacity-0');
            setTimeout(() => status.classList.add('opacity-0'), 2000);
        }

        function loadDraft() {
            const rawDraft = localStorage.getItem('lineman_draft');
            if (!rawDraft) return;

            const draft = JSON.parse(rawDraft);
            // Only load if draft is less than 24 hours old
            if (new Date().getTime() - draft.timestamp > 86400000) {
                localStorage.removeItem('lineman_draft');
                return;
            }

            if (draft.date) document.getElementById('recordDate').value = draft.date;
            if (draft.orderHH) document.getElementById('orderHH').value = draft.orderHH;
            if (draft.orderMM) document.getElementById('orderMM').value = draft.orderMM;
            if (draft.orderIdFull) document.getElementById('orderIdFull').value = draft.orderIdFull;
            if (draft.orderId) document.getElementById('orderId').value = draft.orderId;
            if (draft.customerName) document.getElementById('customerName').value = draft.customerName;
            if (draft.customerPhone) document.getElementById('customerPhone').value = draft.customerPhone;

            if (draft.items) {
                document.getElementById('items-container').innerHTML = '';
                draft.items.forEach(item => addItemRow(item));
            }

            if (draft.isManualNet) {
                document.getElementById('isManualNet').checked = true;
                document.getElementById('manualNet').value = draft.manualNet || 0;
            }
            toggleManualNet();

            if (draft.notes) document.getElementById('notes').value = draft.notes;
            calculateTotalFromItems();
        }

        function clearDraft() {
            localStorage.removeItem('lineman_draft');
            document.getElementById('autosave-status').classList.add('opacity-0');
        }

        function editRecord(uid) {
            const actualIndex = salesData.findIndex(r => r.recordedAt === uid);
            if (actualIndex === -1) return;

            editIndex = actualIndex;
            editingUid = uid;
            const record = salesData[actualIndex];

            // Fill Modal Form
            document.getElementById('e-recordDate').value = record.date;

            const [h, m] = (record.orderTime || '00:00').split(':');
            document.getElementById('e-orderHH').value = h;
            document.getElementById('e-orderMM').value = m;

            document.getElementById('e-isNoFee').checked = record.isNoFee || false;

            // Intelligence: Handle old records where orderId might contain the full ID
            let displayOrderId = record.orderId || '';
            let displayOrderIdFull = record.orderIdFull || '';

            if (!displayOrderIdFull && displayOrderId.length > 8) {
                displayOrderIdFull = displayOrderId;
                displayOrderId = displayOrderId.slice(-4).toUpperCase();
            }

            document.getElementById('e-orderId').value = displayOrderId;
            document.getElementById('e-orderIdFull').value = displayOrderIdFull;

            document.getElementById('e-customerName').value = record.customerName || '';
            document.getElementById('e-customerPhone').value = record.customerPhone || '';
            document.getElementById('e-grossAmount').value = record.gross;

            document.getElementById('e-isManualNet').checked = record.isManualNet || false;
            document.getElementById('e-manualNet').value = record.net || record.gross;
            toggleManualNet('edit');

            document.getElementById('e-notes').value = record.notes || '';

            // Load Items into container
            const eContainer = document.getElementById('e-items-container');
            eContainer.innerHTML = '';
            if (record.items && record.items.length > 0) {
                record.items.forEach(item => addItemRow(item, 'e-items-container'));
            }

            // Received Status
            document.getElementById('e-receivedDate').value = record.receivedDate || record.date;
            if (record.receivedTime && record.receivedTime.includes(':')) {
                const [rh, rm] = record.receivedTime.split(':');
                document.getElementById('e-receivedHH').value = rh;
                document.getElementById('e-receivedMM').value = rm;
            } else {
                document.getElementById('e-receivedHH').value = '';
                document.getElementById('e-receivedMM').value = '';
            }

            // Payment Status (PAID)
            const isPaid = record.isPaid || false;
            document.getElementById('e-isPaid').checked = isPaid;
            document.getElementById('e-paidDate').value = record.paidDate || record.date;
            document.getElementById('e-paidDate').dataset.manual = record.paidDate && record.paidDate !== record.date ? "true" : "";

            if (record.paidTime && record.paidTime.includes(':')) {
                const [th, tm] = record.paidTime.split(':');
                document.getElementById('e-transferHH').value = th;
                document.getElementById('e-transferMM').value = tm;
            } else {
                const now = new Date();
                document.getElementById('e-transferHH').value = now.getHours().toString().padStart(2, '0');
                document.getElementById('e-transferMM').value = now.getMinutes().toString().padStart(2, '0');
            }
            togglePaidSection('edit');

            calculateNetPopup();

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            editIndex = null;
            editingUid = null;
            document.getElementById('editModal').classList.add('hidden');
        }

        function calculateNetPopup() {
            const gross = parseFloat(document.getElementById('e-grossAmount').value) || 0;
            const isNoFee = document.getElementById('e-isNoFee').checked;
            const isManual = document.getElementById('e-isManualNet').checked;
            const manual = parseFloat(document.getElementById('e-manualNet').value) || 0;

            let net;
            if (isManual) {
                net = manual;
            } else {
                let gp = isNoFee ? 0 : gross * GP_RATE;
                net = gross - gp;
            }

            document.getElementById('e-calc-net').innerText = `฿${net.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        }

        function cancelEdit() {
            editIndex = null;
            editingUid = null;
            document.getElementById('salesForm').reset();
            initDefaults(); // Restore date to today
            calculateNet();

            // UI Mode Restore
            document.getElementById('form-title').innerText = "บันทึกยอดขายใหม่";
            document.getElementById('form-icon').className = "fas fa-plus text-lineman text-sm";
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check-circle mr-2"></i> บันทึกข้อมูล';
        }

        async function deleteRecord(uid) {
            const res = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ยอดขายรายการนี้จะถูกถอนออกจากระบบ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e11d48',
                confirmButtonText: 'ลบทิ้ง'
            });

            if (res.isConfirmed) {
                const idx = salesData.findIndex(r => r.recordedAt === uid);
                if (idx !== -1) {
                    salesData.splice(idx, 1);
                    showLoading(true);
                    await window.db.collection('system').doc('lineman_sales').set({ records: salesData });
                    showLoading(false);
                }
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function exportSalesCSV() {
            const termMonth = document.getElementById('monthFilter').value;
            const filtered = salesData.filter(r => r.date.startsWith(termMonth));
            if (filtered.length === 0) return Swal.fire('No Data', 'ไม่มีข้อมูลในช่วงเวลาที่เลือก', 'info');

            const csv = [
                ['Date', 'Order ID', 'Gross Amount', 'GP Fee (30%)', 'Net Amount', 'Notes'],
                ...filtered.map(r => [r.date, r.orderId, r.gross, r.gp, r.net, `"${r.notes}"`])
            ].map(e => e.join(",")).join("\n");

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `lineman_sales_${termMonth}.csv`);
            link.click();
        }

        function exportBackupJSON() {
            if (salesData.length === 0) return Swal.fire('No Data', 'ไม่มีข้อมูลให้ Backup', 'info');

            const dataStr = JSON.stringify(salesData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);

            link.href = url;
            link.download = `lineman_backup_${timestamp}.json`;
            link.click();

            Swal.fire({
                icon: 'success',
                title: 'Backup สำเร็จ',
                text: 'ดาวน์โหลดไฟล์ JSON เรียบร้อยแล้ว',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function logout() { window.auth.signOut().then(() => window.location.reload()); }

        // CSV Import Functions
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('csvInput').value = '';
        }

        async function processCSV() {
            const rawData = document.getElementById('csvInput').value.trim();
            if (!rawData) return;

            const lines = rawData.split('\n');
            const recordsToImport = [];

            // ตรวจสอบโครงสร้าง Column (อ้างอิงจากตัวอย่าง csv ที่ให้มา)
            // OrderID[0], SettlementTime[2], ItemName[3], OrderStatus[7], RevenueAmount[11] 

            lines.forEach((line, index) => {
                if (index === 0 && line.includes('OrderID')) return; // ข้าม Header

                const cols = line.split(',');
                if (cols.length < 12) return; // ข้อมูลไม่ครบ

                const orderId = cols[0].trim();
                const settleTime = cols[2].trim(); // "2026/02/03 16:39:51"
                const itemName = cols[3].trim().replace(/['"]/g, '');
                const status = cols[7].trim(); // "FINISH" 
                const gross = parseFloat(cols[11]) || 0; // RevenueAmount

                // นำเข้าเฉพาะที่สำเร็จ และยังไม่มีในระบบ
                if (status === 'FINISH') {
                    const dtParts = settleTime.split(' ');
                    const dateOnly = dtParts[0].replace(/\//g, '-');
                    const timeOnly = dtParts.length > 1 ? dtParts[1].slice(0, 5) : '00:00';
                    const gp = gross * GP_RATE;
                    const net = gross - gp;

                    const orderIdShort = orderId.length >= 4 ? orderId.slice(-4).toUpperCase() : orderId;

                    // Split items from itemName (e.g. "Product A 1|Product B 2")
                    const items = [];
                    const parts = itemName.split('|');
                    parts.forEach(part => {
                        const text = part.trim();
                        if (!text) return;
                        const match = text.match(/(.*)\s+(\d+)$/);
                        let name = text;
                        let qty = 1;
                        if (match) {
                            name = match[1].trim();
                            qty = parseInt(match[2]) || 1;
                        }

                        // Lookup Price (for display in UI history)
                        const master = masterProducts.find(m => m.name === name);
                        const price = (master && master.prices) ? (master.prices['LINEMAN'] || master.prices[Object.keys(master.prices)[0]] || 0) : 0;

                        items.push({ name, qty, price });
                    });

                    recordsToImport.push({
                        date: dateOnly,
                        orderTime: timeOnly,
                        orderId: orderIdShort,
                        orderIdFull: orderId,
                        gross: gross,
                        gp: gp,
                        net: net,
                        isPaid: false, // Default for CSV import
                        paidDate: '',
                        paidTime: '',
                        items: items, // Added split items
                        notes: itemName,
                        recordedAt: new Date().getTime() + index
                    });
                }
            });

            if (recordsToImport.length > 0) {
                showLoading(true);

                let addedCount = 0;
                let updatedCount = 0;
                let ignoredCount = 0;

                const getScore = (r) => {
                    let s = 0;
                    if (r.items && r.items.length > 0) s += r.items.length * 10;
                    if (r.notes) s += r.notes.length;
                    if (r.customerName) s += 10;
                    if (r.isPaid) s += 100; // Manual paid status is high value
                    return s;
                };

                recordsToImport.forEach(newRec => {
                    // Find duplicate
                    const existingIdx = salesData.findIndex(r =>
                        (r.orderIdFull && newRec.orderIdFull && r.orderIdFull === newRec.orderIdFull) ||
                        (!r.orderIdFull && !newRec.orderIdFull && r.orderId === newRec.orderId && r.date === newRec.date)
                    );

                    if (existingIdx === -1) {
                        salesData.push(newRec);
                        addedCount++;
                    } else {
                        const existingRec = salesData[existingIdx];
                        const sOld = getScore(existingRec);
                        const sNew = getScore(newRec);

                        if (sNew > sOld) {
                            // Link existing manual info if any
                            const merged = {
                                ...newRec,
                                isPaid: existingRec.isPaid || newRec.isPaid,
                                paidDate: existingRec.paidDate || newRec.paidDate,
                                paidTime: existingRec.paidTime || newRec.paidTime,
                                recordedAt: existingRec.recordedAt // Keep original order
                            };
                            salesData[existingIdx] = merged;
                            updatedCount++;
                        } else {
                            ignoredCount++;
                        }
                    }
                });

                // เรียงลำดับตามวันที่ใหม่
                salesData.sort((a, b) => b.date.localeCompare(a.date) || b.recordedAt - a.recordedAt);

                await window.db.collection('system').doc('lineman_sales').set({ records: salesData });
                showLoading(false);
                closeImportModal();

                Swal.fire({
                    icon: 'success',
                    title: 'นำเข้าข้อมูลเรียบร้อย',
                    html: `
                        <div class="text-left space-y-1 text-sm bg-slate-50 p-4 rounded-xl">
                            <div class="flex justify-between"><span>เพิ่มใหม่:</span> <span class="font-bold text-emerald-600">${addedCount}</span></div>
                            <div class="flex justify-between"><span>อัปเดตข้อมูล:</span> <span class="font-bold text-blue-600">${updatedCount}</span></div>
                            <div class="flex justify-between"><span>ข้าม (ซ้ำ):</span> <span class="font-bold text-slate-400">${ignoredCount}</span></div>
                        </div>
                    `,
                    confirmButtonColor: '#00B14F'
                });
            } else {
                Swal.fire('ไม่พบข้อมูล', 'ไม่พบรายการที่สำเร็จ (FINISH) ในข้อมูลที่วาง', 'warning');
            }
        }

        // File Selection Handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('bg-lineman/10', 'border-lineman');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('bg-lineman/10', 'border-lineman');
        }

        function handleDropFile(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('bg-lineman/10', 'border-lineman');

            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processFile(files[0]);
        }

        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                return Swal.fire('ไฟล์ไม่ถูกต้อง', 'กรุณาเลือกไฟล์เฉพาะนามสกุล .csv เท่านั้น', 'error');
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('csvInput').value = e.target.result;
                // Optional: Auto process
                Swal.fire({
                    title: 'โหลดไฟล์สำเร็จ',
                    text: `พบข้อมูลในไฟล์ ${file.name} ต้องการเริ่มนำเข้าทันทีหรือไม่?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'เริ่มนำเข้าเลย',
                    cancelButtonText: 'ตรวจสอบก่อน',
                    confirmButtonColor: '#00B14F'
                }).then((result) => {
                    if (result.isConfirmed) processCSV();
                });
            };
            reader.readAsText(file);
        }
    </script>
</body>

</html>