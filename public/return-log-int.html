<!DOCTYPE html>
<html lang="th" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Manager (Secured)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155'
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        #app-container {
            display: none;
        }

        #login-container {
            display: none;
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        th.sortable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-darkBg text-gray-800 dark:text-gray-200 transition-colors duration-300 min-h-screen">

    <div id="loading" class="loading-screen text-indigo-600">
        <i class="fas fa-circle-notch fa-spin text-4xl"></i>
    </div>

    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-darkCard p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-darkBorder text-center">
            <div class="text-center mb-6">
                <div
                    class="bg-indigo-100 dark:bg-indigo-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-2xl text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Access Required</h2>
                <p class="text-gray-500 text-sm mt-1">Stock Management System</p>
            </div>

            <p class="mb-6 text-gray-600 dark:text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>

            <a href="admin.html" target="_blank"
                class="block w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-lg transition transform active:scale-95">
                <i class="fas fa-arrow-left mr-2"></i> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Admin
            </a>
        </div>
    </div>

    <div id="app-container" class="p-3 md:p-6">
        <div class="max-w-7xl mx-auto">
            <!-- TMTP-Style Navbar -->
            <nav
                class="bg-white/90 dark:bg-darkCard/90 backdrop-blur-md border-b border-gray-200 dark:border-darkBorder sticky top-0 z-50 mb-6 rounded-xl shadow-sm">
                <div class="px-4 py-3">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <a href="admin.html" target="_blank"
                                class="w-10 h-10 rounded-xl bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:border-indigo-300 dark:hover:border-indigo-500 flex items-center justify-center transition-all shadow-sm group"
                                title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin">
                                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                            </a>
                            <div
                                class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                <i class="fas fa-boxes-packing text-lg"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold leading-tight text-gray-900 dark:text-white">Stock <span
                                        class="text-indigo-600 dark:text-indigo-400">Manager</span></h1>
                                <p
                                    class="text-[10px] text-gray-400 font-medium uppercase tracking-wider flex items-center gap-2">
                                    <span>Cloud System</span>
                                    <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                                    <span id="userDisplay" class="text-indigo-500">...</span>
                                    <span id="saveStatus" class="ml-2 text-emerald-500 italic font-normal"></span>
                                </p>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="toggleTheme()"
                                class="w-10 h-10 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-yellow-400 hover:bg-gray-200 transition-colors flex items-center justify-center">
                                <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i>
                            </button>

                            <div class="h-8 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>

                            <input type="file" id="fileInput" accept=".json" class="hidden"
                                onchange="app.loadJSON(this)">
                            <button onclick="document.getElementById('fileInput').click()"
                                class="hidden md:flex items-center gap-2 px-4 py-2 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm">
                                <i class="fas fa-folder-open text-yellow-500"></i> Open
                            </button>

                            <button onclick="app.saveJSON()"
                                class="hidden md:flex items-center gap-2 px-4 py-2 rounded-xl border-2 border-emerald-100 dark:border-emerald-900/30 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 font-bold hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-colors text-sm">
                                <i class="fas fa-save"></i> Save JSON
                            </button>

                            <button onclick="logout()"
                                class="w-10 h-10 md:w-auto md:px-4 md:py-2 rounded-xl bg-red-50 dark:bg-red-900/10 text-red-500 dark:text-red-400 border border-red-100 dark:border-red-900/30 font-bold hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-power-off"></i> <span class="hidden md:inline">Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto flex-grow max-w-2xl">
                    <div class="relative w-full sm:w-64">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-darkBorder bg-white dark:bg-darkCard focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white"
                            onkeyup="app.handleSearch(this.value)">
                    </div>
                    <select id="filterSelect" onchange="app.handleFilter(this.value)"
                        class="py-2 px-3 rounded-lg border border-gray-300 dark:border-darkBorder bg-white dark:bg-darkCard dark:text-white cursor-pointer">
                        <option value="all">üìù ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="pending">‚è≥ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</option>
                        <option value="risk_buy">‚ö†Ô∏è ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Short Date</option>
                        <option value="expired">‚õî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="completed">‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                    </select>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span id="showingStart" class="font-bold">0</span>-<span id="showingEnd"
                        class="font-bold">0</span> ‡∏à‡∏≤‡∏Å <span id="totalItems" class="font-bold">0</span>
                </div>
            </div>

            <section
                class="bg-white dark:bg-darkCard p-6 rounded-xl shadow-sm mb-6 border border-gray-100 dark:border-darkBorder">
                <div
                    class="flex justify-between items-center mb-4 border-b border-gray-100 dark:border-darkBorder pb-3">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2"><i
                            class="fas fa-pen-to-square text-indigo-500"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    <button onclick="app.resetForm()"
                        class="text-sm text-gray-500 hover:text-indigo-600 dark:text-gray-400 transition"><i
                            class="fas fa-undo mr-1"></i>Reset</button>
                </div>
                <form id="returnForm" onsubmit="event.preventDefault(); app.saveItem();">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-12 lg:col-span-4 space-y-4">
                            <div><label
                                    class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input
                                    type="text" id="productName" required
                                    class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                    oninput="app.handleProductInput(this)">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label
                                        class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                        (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</label><input type="text" id="companyProductId"
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                </div>
                                <div><label
                                        class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                        (MLP)</label><input type="text" id="mlpId"
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label
                                        class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input
                                        type="number" id="qty" required
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                </div>
                                <div><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Lot
                                        No.</label><input type="text" id="lotNo" required
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                </div>
                            </div>
                            <div><label
                                    class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Supplier</label><input
                                    type="text" id="companyName" required
                                    class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>
                        <fieldset
                            class="md:col-span-6 lg:col-span-4 border border-orange-200 rounded-lg p-4 bg-orange-50/50 dark:bg-orange-900/10">
                            <legend class="text-sm font-bold text-orange-700 dark:text-orange-400 px-2">Shelf Life
                                Analysis</legend>
                            <div class="space-y-3">
                                <div><label class="text-sm text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label><input
                                        type="date" id="purchaseDate" required
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                        onchange="app.validateDates()"></div>
                                <div><label class="text-sm text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><input
                                        type="date" id="expDate" required
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                        onchange="app.validateDates()"></div>
                            </div>
                        </fieldset>
                        <fieldset
                            class="md:col-span-6 lg:col-span-4 border border-blue-200 rounded-lg p-4 bg-blue-50/50 dark:bg-blue-900/10">
                            <legend class="text-sm font-bold text-blue-700 dark:text-blue-400 px-2">Return Status
                            </legend>
                            <div class="space-y-3">
                                <div><label class="text-sm text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô</label><input
                                        type="date" id="notifyDate" required
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                        onchange="app.validateDates()"></div>
                                <div><label class="text-sm text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</label><input
                                        type="date" id="returnDate"
                                        class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                        onchange="app.validateDates()"></div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t dark:border-gray-700">
                        <button type="button" onclick="app.cancelEdit()" id="cancelBtn"
                            class="hidden px-4 py-2 border rounded text-gray-600 bg-gray-100 hover:bg-gray-200">Cancel</button>
                        <button type="submit" id="submitBtn"
                            class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium">Save
                            Data</button>
                    </div>
                </form>
            </section>

            <div
                class="bg-white dark:bg-darkCard rounded-xl shadow border border-gray-200 dark:border-darkBorder overflow-hidden">
                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-left border-collapse text-sm">
                        <thead
                            class="bg-gray-100 dark:bg-gray-800 uppercase font-bold text-gray-600 dark:text-gray-300">
                            <tr>
                                <th class="p-4 border-b dark:border-gray-700 sortable" onclick="app.sortBy('product')">
                                    Product</th>
                                <th class="p-4 border-b dark:border-gray-700 text-center">Qty</th>
                                <th class="p-4 border-b dark:border-gray-700 w-64 sortable"
                                    onclick="app.sortBy('remainingDays')">Analysis</th>
                                <th class="p-4 border-b dark:border-gray-700 text-center sortable"
                                    onclick="app.sortBy('returnDays')">Status</th>
                                <th class="p-4 border-b dark:border-gray-700 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <div
                    class="bg-gray-50 dark:bg-gray-800 p-3 border-t border-gray-200 dark:border-darkBorder flex justify-center gap-2 items-center">
                    <button onclick="app.prevPage()" id="btnPrev"
                        class="px-3 py-1 rounded bg-white dark:bg-darkCard border dark:border-darkBorder hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"><i
                            class="fas fa-chevron-left"></i></button>
                    <div id="pageNumbers" class="flex gap-1 text-sm text-gray-600 dark:text-gray-400"></div>
                    <button onclick="app.nextPage()" id="btnNext"
                        class="px-3 py-1 rounded bg-white dark:bg-darkCard border dark:border-darkBorder hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // 1. CONFIG moved to firebase-config.js
        // Global variables from firebase-config.js: window.db, window.auth

        let currentUser = null;

        // 2. AUTH & CLOUD
        // 2. AUTH & CLOUD
        // Wait for auth to be ready
        const checkAuth = setInterval(() => {
            if (window.auth) {
                clearInterval(checkAuth);
                window.auth.onAuthStateChanged((user) => {
                    document.getElementById('loading').style.display = 'none';
                    if (user) {
                        currentUser = user;
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('app-container').style.display = 'block';
                        document.getElementById('userDisplay').innerText = user.email || user.displayName;
                        document.getElementById('userDisplay').innerText = user.email || user.displayName;
                        loadDataFromCloud();
                        app.loadMasterData();
                    } else {
                        currentUser = null;
                        document.getElementById('app-container').style.display = 'none';
                        document.getElementById('login-container').style.display = 'flex';
                    }
                });
            }
        }, 500);

        // Global unsubscribe function to stop listener when needed
        let unsubscribe = null;

        function loadDataFromCloud() {
            // Changed to Shared Document: system/stock_return
            // Using onSnapshot for Real-time updates
            if (unsubscribe) unsubscribe();

            const docRef = window.db.collection('system').doc('stock_return');

            // Show loading initially
            document.getElementById('loading').style.display = 'flex';

            unsubscribe = docRef.onSnapshot((doc) => {
                document.getElementById('loading').style.display = 'none';
                if (doc.exists && doc.data().stockData) {
                    app.data = doc.data().stockData;
                    console.log("Real-time update received:", app.data.length, "items");
                } else {
                    app.data = [];
                    // Create the document if it doesn't exist
                    if (!doc.exists) {
                        docRef.set({ stockData: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                }
                app.renderTable();
                updateSaveStatus('Cloud Synced (Real-time)');
            }, (error) => {
                console.error("Error getting document:", error);
                document.getElementById('loading').style.display = 'none';
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            });
        }

        function saveDataToCloud() {
            // Save to Shared Document
            updateSaveStatus('Saving...');
            window.db.collection('system').doc('stock_return').set({
                stockData: app.data,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email || currentUser.displayName
            }, { merge: true }).then(() => {
                updateSaveStatus('All saved to cloud');
            }).catch((error) => {
                console.error("Error writing document:", error);
                updateSaveStatus('Save Failed!', true);
            });
        }

        function updateSaveStatus(msg, isError = false) {
            const el = document.getElementById('saveStatus');
            el.innerText = msg;
            el.className = isError ? 'ml-2 text-red-500 font-bold' : 'ml-2 text-emerald-500 italic font-normal';
        }



        function logout() { window.auth.signOut().then(() => window.location.reload()); }

        // 3. APP LOGIC
        const app = {
            data: [],
            masterProducts: {},
            config: { itemsPerPage: 10, currentPage: 1, filterType: 'all', sortCol: 'id', sortDir: 'desc', searchTerm: '' },

            loadMasterData() {
                window.db.collection('master_products').onSnapshot(snapshot => {
                    this.masterProducts = {};
                    snapshot.forEach(doc => {
                        this.masterProducts[doc.data().name] = doc.data(); // Index by Name for easy lookup
                    });
                });
            },

            handleProductInput(el) {
                const name = el.value.trim();
                if (this.masterProducts[name]) {
                    const m = this.masterProducts[name];
                    document.getElementById('companyProductId').value = m.companyProductId || '';
                    document.getElementById('mlpId').value = m.mlpId || '';
                    // Try to guess company if empty?
                    if (!document.getElementById('companyName').value && m.prices) {
                        const comps = Object.keys(m.prices).map(k => k.split('_')[0]);
                        if (comps.length > 0) document.getElementById('companyName').value = comps[0];
                    }
                }
            },

            init() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('notifyDate').value = today;
                document.getElementById('purchaseDate').value = today;
                if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.cancelEdit();
                    if (e.altKey && e.key === 'n') { e.preventDefault(); document.getElementById('productName').focus(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
                });
            },

            // --- Open JSON Function (RESTORED & IMPROVED) ---
            loadJSON(input) {
                const file = input.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = e => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (Array.isArray(loadedData)) {
                            // Merge or Replace? -> Let's Replace for simplicity as per previous behavior
                            this.data = loadedData;
                            // üî• Important: Sync loaded data to Cloud immediately
                            saveDataToCloud();
                            this.renderTable();
                            Swal.fire({ icon: 'success', title: 'Import ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', toast: true, position: 'top-end', timer: 2000 });
                        }
                    } catch (err) {
                        Swal.fire('Error', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    }
                };
                r.readAsText(file);
                input.value = ''; // Reset input
            },

            saveJSON() {
                if (this.data.length === 0) return;
                const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: "application/json" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `inventory_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            },

            saveItem() {
                if (!this.validateDates()) return Swal.fire({ icon: 'error', title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', toast: true, position: 'top-end', timer: 2000 });
                const editId = document.getElementById('editId').value;
                const form = {
                    product: document.getElementById('productName').value,
                    qty: document.getElementById('qty').value,
                    lot: document.getElementById('lotNo').value,
                    company: document.getElementById('companyName').value,
                    purchaseDate: document.getElementById('purchaseDate').value,
                    expDate: document.getElementById('expDate').value,
                    notifyDate: document.getElementById('notifyDate').value,
                    returnDate: document.getElementById('returnDate').value,
                    companyProductId: document.getElementById('companyProductId').value,
                    mlpId: document.getElementById('mlpId').value
                };

                // Sync to Master
                if (form.product) {
                    const masterRef = window.db.collection('master_products').doc(form.product);
                    // We only update if we have new info, to avoid overwriting existing good data with empty?
                    // But requirement says "update together", so we should trust the user input here.
                    const updateData = {
                        name: form.product,
                        companyProductId: form.companyProductId,
                        mlpId: form.mlpId
                    };
                    masterRef.set(updateData, { merge: true }).catch(e => console.error("Master Sync Error", e));
                }

                let returnDays = 0;
                if (form.notifyDate && form.returnDate) returnDays = Math.ceil((new Date(form.returnDate) - new Date(form.notifyDate)) / 86400000);

                let shelfLifeDays = 0, remainingDays = 0;
                if (form.purchaseDate && form.expDate) {
                    const purchase = new Date(form.purchaseDate);
                    const exp = new Date(form.expDate);
                    const now = new Date();
                    shelfLifeDays = Math.ceil((exp - purchase) / 86400000);
                    remainingDays = Math.ceil((exp - now) / 86400000);
                }

                const newItem = { ...form, returnDays, shelfLifeDays, remainingDays, id: editId ? Number(editId) : Date.now() };

                if (editId) {
                    const idx = this.data.findIndex(i => i.id == editId);
                    if (idx !== -1) this.data[idx] = newItem;
                    this.cancelEdit();
                } else {
                    this.data.push(newItem);
                    this.resetForm(true);
                }
                saveDataToCloud(); // üî• Cloud Sync
                this.renderTable();
            },

            deleteItem(id) {
                Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢' })
                    .then((r) => {
                        if (r.isConfirmed) {
                            this.data = this.data.filter(i => i.id !== id);
                            saveDataToCloud(); // üî• Cloud Sync
                            this.renderTable();
                        }
                    });
            },

            // ... Helper Functions ...
            validateDates() {
                const purchase = document.getElementById('purchaseDate').value;
                const exp = document.getElementById('expDate').value;
                const notify = document.getElementById('notifyDate').value;
                const ret = document.getElementById('returnDate').value;
                if (purchase && exp && exp <= purchase) return false;
                if (notify && ret && ret < notify) return false;
                return true;
            },

            cancelEdit() {
                this.resetForm(true);
                const btn = document.getElementById('submitBtn');
                btn.innerHTML = 'Save Data';
                btn.classList.replace('bg-orange-600', 'bg-indigo-600');
                document.getElementById('cancelBtn').classList.add('hidden');
            },

            resetForm(keepDate = false) {
                document.getElementById('returnForm').reset();
                document.getElementById('editId').value = '';
                document.getElementById('companyProductId').value = '';
                document.getElementById('mlpId').value = '';
                if (keepDate) {
                    const today = new Date().toISOString().slice(0, 10);
                    document.getElementById('notifyDate').value = today;
                    document.getElementById('purchaseDate').value = today;
                }
            },

            editItem(id) {
                const item = this.data.find(i => i.id === id);
                if (!item) return;
                document.getElementById('editId').value = item.id;
                document.getElementById('productName').value = item.product;
                document.getElementById('qty').value = item.qty;
                document.getElementById('lotNo').value = item.lot;
                document.getElementById('companyName').value = item.company;
                document.getElementById('purchaseDate').value = item.purchaseDate;
                document.getElementById('expDate').value = item.expDate;
                document.getElementById('notifyDate').value = item.notifyDate;
                document.getElementById('notifyDate').value = item.notifyDate;
                document.getElementById('returnDate').value = item.returnDate || '';
                document.getElementById('companyProductId').value = item.companyProductId || '';
                document.getElementById('mlpId').value = item.mlpId || '';

                // If local item doesn't have codes, try fetching from master
                if (!item.companyProductId && !item.mlpId && this.masterProducts[item.product]) {
                    const m = this.masterProducts[item.product];
                    document.getElementById('companyProductId').value = m.companyProductId || '';
                    document.getElementById('mlpId').value = m.mlpId || '';
                }

                const btn = document.getElementById('submitBtn');
                btn.innerHTML = 'Update';
                btn.classList.replace('bg-indigo-600', 'bg-orange-600');
                document.getElementById('cancelBtn').classList.remove('hidden');
                document.getElementById('productName').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            // ... Table Logic ...
            getProcessedData() {
                let result = [...this.data];
                if (this.config.searchTerm) {
                    const term = this.config.searchTerm.toLowerCase();
                    result = result.filter(item => item.product.toLowerCase().includes(term) || item.company.toLowerCase().includes(term) || item.lot.toLowerCase().includes(term));
                }
                result = result.filter(item => {
                    const remaining = item.remainingDays;
                    const initial = item.shelfLifeDays;
                    switch (this.config.filterType) {
                        case 'pending': return !item.returnDate;
                        case 'completed': return !!item.returnDate;
                        case 'risk_buy': return initial < 180;
                        case 'expired': return remaining < 0;
                        default: return true;
                    }
                });
                result.sort((a, b) => {
                    let valA = a[this.config.sortCol], valB = b[this.config.sortCol];
                    if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    return this.config.sortDir === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
                });
                return result;
            },

            renderTable() {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                const processed = this.getProcessedData();
                const total = processed.length;
                const start = (this.config.currentPage - 1) * this.config.itemsPerPage;
                const end = start + this.config.itemsPerPage;
                const visibleItems = processed.slice(start, end);

                document.getElementById('totalItems').innerText = total;
                document.getElementById('showingStart').innerText = total > 0 ? start + 1 : 0;
                document.getElementById('showingEnd').innerText = Math.min(end, total);

                const totalPages = Math.ceil(total / this.config.itemsPerPage);
                document.getElementById('btnPrev').disabled = this.config.currentPage === 1;
                document.getElementById('btnNext').disabled = this.config.currentPage >= totalPages || totalPages === 0;
                document.getElementById('pageNumbers').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${this.config.currentPage} / ${totalPages || 1}`;

                if (visibleItems.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                    return;
                }

                visibleItems.forEach(item => {
                    // Fix undefined values from old JSON
                    if (item.remainingDays === undefined && item.expDate) item.remainingDays = Math.ceil((new Date(item.expDate) - new Date()) / 86400000);
                    if (item.shelfLifeDays === undefined && item.expDate && item.purchaseDate) item.shelfLifeDays = Math.ceil((new Date(item.expDate) - new Date(item.purchaseDate)) / 86400000);

                    const maxRef = item.shelfLifeDays > 365 ? 365 : (item.shelfLifeDays || 365);
                    let percent = Math.max(0, Math.min(100, (item.remainingDays / maxRef) * 100));
                    let color = 'bg-emerald-500'; let status = '‡∏õ‡∏Å‡∏ï‡∏¥';
                    if (item.remainingDays < 0) { color = 'bg-gray-800 dark:bg-gray-500'; status = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'; percent = 100; }
                    else if (item.remainingDays < 30) { color = 'bg-rose-500'; status = '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï'; }
                    else if (item.remainingDays < 180) { color = 'bg-amber-500'; status = '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢'; }

                    let initialHtml = '';
                    if (item.shelfLifeDays < 30) initialHtml = `<div class="mt-1 text-[11px] font-bold text-red-600 dark:text-red-400"><i class="fas fa-skull mr-1"></i>‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (${item.shelfLifeDays} ‡∏ß‡∏±‡∏ô)</div>`;
                    else if (item.shelfLifeDays < 180) initialHtml = `<div class="mt-1 text-[11px] font-bold text-orange-600 dark:text-orange-400"><i class="fas fa-exclamation-triangle mr-1"></i>‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Short Date (${item.shelfLifeDays} ‡∏ß‡∏±‡∏ô)</div>`;
                    else initialHtml = `<div class="mt-1 text-[10px] text-gray-400 dark:text-gray-500">‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ ${item.shelfLifeDays} ‡∏ß‡∏±‡∏ô</div>`;

                    let returnHtml = item.returnDate
                        ? `<span class="inline-flex items-center gap-1 text-emerald-600 dark:text-emerald-400 text-xs font-bold bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded-full"><i class="fas fa-check"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à (${item.returnDays} ‡∏ß‡∏±‡∏ô)</span>`
                        : `<span class="inline-flex items-center gap-1 text-amber-600 dark:text-amber-400 text-xs font-bold bg-amber-50 dark:bg-amber-900/20 px-2 py-1 rounded-full animate-pulse"><i class="fas fa-clock"></i> ‡∏£‡∏≠ ${Math.ceil((new Date() - new Date(item.notifyDate)) / 86400000)} ‡∏ß‡∏±‡∏ô</span>`;

                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition border-b dark:border-darkBorder last:border-0">
                            <td class="p-4 align-top">
                                <div class="font-bold text-gray-800 dark:text-gray-100">${item.product}</div>
                                <div class="text-xs text-gray-500 mt-1 flex gap-2">
                                    <span><i class="fas fa-building mr-1"></i>${item.company}</span>
                                    <span class="font-mono text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-1 rounded">${item.lot}</span>
                                </div>
                            </td>
                            <td class="p-4 text-center font-bold hidden md:table-cell dark:text-gray-300">${item.qty}</td>
                            <td class="p-4 align-middle">
                                <div class="flex justify-between text-xs mb-1 font-medium">
                                    <span class="${item.remainingDays < 0 ? 'text-red-600' : 'text-gray-600 dark:text-gray-400'}">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.remainingDays} ‡∏ß‡∏±‡∏ô</span>
                                    <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-1.5 rounded text-gray-500 dark:text-gray-300">${status}</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                    <div class="${color} h-1.5 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                ${initialHtml}
                            </td>
                            <td class="p-4 align-middle text-center">${returnHtml}</td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="app.editItem(${item.id})" class="p-2 text-indigo-500 hover:bg-indigo-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button onclick="app.deleteItem(${item.id})" class="p-2 text-rose-500 hover:bg-rose-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            },
            handleSearch(term) { this.config.searchTerm = term; this.config.currentPage = 1; this.renderTable(); },
            handleFilter(type) { this.config.filterType = type; this.config.currentPage = 1; this.renderTable(); },
            sortBy(col) { this.config.sortCol = col; this.config.sortDir = (this.config.sortCol === col && this.config.sortDir === 'desc') ? 'asc' : 'desc'; this.renderTable(); },
            prevPage() { if (this.config.currentPage > 1) { this.config.currentPage--; this.renderTable(); } },
            nextPage() { if (this.config.currentPage < Math.ceil(this.getProcessedData().length / this.config.itemsPerPage)) { this.config.currentPage++; this.renderTable(); } },
        };
        app.init();
    </script>
</body>

</html>