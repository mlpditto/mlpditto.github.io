<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics V136.24 (Customer Tab Fixed) - Privacy % vs Normal ฿</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai+Looped:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['IBM Plex Sans Thai Looped', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#6366f1', 600: '#4f46e5' },
                        card: { bg: '#1E1E2E', border: '#4A4A4A' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
        }

        .dark .glass-header {
            background: rgba(30, 41, 59, 0.98);
        }

        mark {
            background-color: #fef08a;
            color: #854d0e;
            padding: 0 2px;
            border-radius: 2px;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Pocket Mode Styling */
        .row-excluded {
            background-color: #fff7ed !important;
            color: #c2410c !important;
        }

        .dark .row-excluded {
            background-color: #431407 !important;
            color: #fdba74 !important;
        }

        .row-excluded td {
            text-decoration: line-through;
            text-decoration-color: #fdba74;
        }

        .row-excluded .no-strike,
        .row-excluded .no-strike * {
            text-decoration: none !important;
            opacity: 1 !important;
        }

        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid #cbd5e1;
            border-radius: 0.25em;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .dark .custom-checkbox {
            background-color: #1e293b;
            border-color: #475569;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            background-color: white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Card Style */
        .stat-card-new {
            width: 100%;
            height: 160px;
            background-color: #1E1E2E;
            border: 1px solid #4A4A4A;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            color: #E0E0E0;
            position: relative;
            overflow: hidden;
        }

        .stat-card-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            border-color: #606060;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            margin-bottom: 3px;
            color: #9ca3af;
        }

        .card-row-val {
            font-weight: 600;
            color: #e2e8f0;
            font-family: 'IBM Plex Sans Thai Looped', monospace;
        }

        .stacked-bar-container {
            height: 8px;
            width: 100%;
            background-color: #333;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            margin-top: auto;
            margin-bottom: 8px;
        }

        .seg-bar {
            height: 100%;
            transition: width 0.5s ease;
        }

        .seg-cash {
            background-color: #f97316;
        }

        .seg-credit {
            background-color: #a855f7;
        }

        .seg-trans {
            background-color: #3b82f6;
        }

        .seg-ar {
            background-color: #14b8a6;
        }

        .legend-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #9ca3af;
        }

        @media (min-width: 768px) {
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }

        @media (min-width: 1280px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 767px) {
            .cards-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
        }

        /* Filter Tab Styles */
        .tab-btn {
            @apply flex flex-col items-center justify-center min-w-[90px] px-4 py-2 text-sm font-semibold rounded-t-lg border-t border-l border-r border-b-0 transition-all cursor-pointer whitespace-nowrap;
        }

        .tab-active {
            @apply border-brand-500 bg-brand-500 text-white shadow-md;
        }

        .tab-inactive {
            @apply border-transparent bg-white text-slate-500 hover:bg-slate-50 dark:bg-dark-800 dark:text-slate-400 dark:hover:bg-slate-700;
        }

        .main-tab-btn {
            @apply px-6 py-3 font-bold text-base text-slate-400 dark:text-slate-500 border-b-2 border-transparent transition-all duration-200 hover:text-slate-600 dark:hover:text-slate-300 flex items-center justify-center gap-2 rounded-t-lg;
        }

        .main-tab-active {
            @apply text-brand-600 dark:text-brand-400 bg-white dark:bg-dark-800 border-t-4 border-l border-r border-b-0 border-brand-500 rounded-t-xl shadow-sm z-10 -mb-px;
            border-top-color: #4f46e5;
        }

        .action-btn {
            @apply sm:flex-none bg-white hover:bg-slate-50 dark:bg-slate-800 dark:hover:bg-slate-700 border rounded-xl font-medium py-2.5 px-4 transition-all flex items-center justify-center gap-2 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300;
        }

        .modal-input {
            @apply w-full px-2 py-1.5 border border-slate-200 dark:border-slate-600 rounded text-right text-sm outline-none focus:ring-1 focus:ring-brand-500 bg-white dark:bg-slate-800 dark:text-white;
        }

        .modal-input-return {
            @apply w-full px-2 py-1.5 border border-red-200 dark:border-red-900 rounded text-right text-sm outline-none focus:ring-1 focus:ring-red-500 bg-red-50 dark:bg-red-900/10 dark:text-white text-red-600 font-medium;
        }

        .diff-val {
            @apply text-[10px] w-8 text-right text-slate-300 dark:text-slate-500;
        }

        .cust-filter-chk {
            @apply w-4 h-4 text-brand-600 bg-gray-100 border-gray-300 rounded focus:ring-brand-500 dark:focus:ring-brand-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 cursor-pointer;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-sans antialiased pb-24 relative transition-colors duration-300">

    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/80 dark:bg-black/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-center fade-in">
        <div class="w-10 h-10 border-4 border-brand-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-brand-600 dark:text-brand-400 font-semibold animate-pulse">กำลังประมวลผล...</p>
    </div>

    <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
    <input type="file" id="jsonFileInput" accept=".json" class="hidden" onchange="handleJsonSelect(event)">

    <nav class="bg-gradient-to-r from-brand-600 to-indigo-600 shadow-lg sticky top-0 z-40">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3 text-white">
                    <a href="admin.html"
                        class="bg-white/10 hover:bg-white/20 p-2 rounded-lg transition-colors text-white/90 hover:text-white"
                        title="กลับสู่ Dashboard">
                        <i class="ph-bold ph-arrow-left text-xl"></i>
                    </a>
                    <div class="bg-white/20 p-2 rounded-lg backdrop-blur-md"><i
                            class="ph-bold ph-chart-polar text-2xl"></i></div>
                    <div><span class="font-bold text-xl tracking-tight block leading-none">Sales Analytics</span><span
                            class="text-xs text-indigo-100 font-light opacity-90">V136.24 Fixed 2</span></div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleTheme()"
                        class="text-white/80 hover:text-white transition-colors p-2 rounded-lg hover:bg-white/10"
                        title="โหมดมืด/สว่าง"><i id="themeIcon" class="ph-bold ph-moon text-xl"></i></button>
                    <button onclick="window.location.reload()"
                        class="text-white/80 hover:text-white transition-colors p-2 rounded-lg hover:bg-white/10"
                        title="รีเฟรช"><i class="ph-bold ph-arrow-clockwise text-xl"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <section
            class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-all duration-300">
            <div
                class="bg-slate-50/50 dark:bg-slate-800/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2"><i
                        class="ph-fill ph-clipboard-text text-brand-600 dark:text-brand-400"></i> นำเข้าข้อมูล</h3>
                <div class="flex items-center gap-2">
                    <button onclick="document.getElementById('csvFileInput').click()"
                        class="text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 px-2.5 py-1 rounded-lg border border-indigo-200 dark:border-indigo-800 transition-all flex items-center gap-1"><i
                            class="ph-bold ph-upload-simple"></i> CSV</button>
                    <button onclick="document.getElementById('jsonFileInput').click()"
                        class="text-xs font-bold text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 px-2.5 py-1 rounded-lg border border-blue-200 dark:border-blue-800 transition-all flex items-center gap-1"
                        title="โหลดไฟล์งานเดิม"><i class="ph-bold ph-folder-open"></i> Open</button>
                    <button onclick="saveProject()"
                        class="text-xs font-bold text-emerald-600 dark:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 px-2.5 py-1 rounded-lg border border-emerald-200 dark:border-emerald-800 transition-all flex items-center gap-1"
                        title="บันทึกงานเพื่อทำต่อภายหลัง"><i class="ph-bold ph-floppy-disk"></i> Save</button>
                    <div class="h-4 w-px bg-slate-200 dark:bg-slate-600 mx-1"></div>
                    <div
                        class="flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500 bg-white dark:bg-slate-700 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-600 shadow-sm">
                        <i class="ph-bold ph-keyboard"></i> <span>Ctrl + Enter</span>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="relative group">
                    <textarea id="inputData"
                        class="w-full h-40 p-4 text-sm font-mono border border-slate-300 dark:border-slate-600 rounded-xl focus:ring-4 focus:ring-brand-500/20 focus:border-brand-500 bg-slate-50 dark:bg-slate-900 focus:bg-white dark:focus:bg-black placeholder-slate-400 dark:placeholder-slate-500 transition-all resize-y text-slate-700 dark:text-slate-300"
                        placeholder="วางข้อมูลดิบที่นี่... หรือลากไฟล์มาวางเพื่อเริ่มใช้งาน"
                        onkeydown="checkShortcut(event)"></textarea>
                </div>
                <div class="flex flex-wrap items-center gap-3 mt-5">
                    <button onclick="startProcessing()"
                        class="sm:flex-none bg-gradient-to-r from-brand-600 to-indigo-600 hover:from-brand-700 hover:to-indigo-700 text-white font-medium py-2.5 px-6 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"><i
                            class="ph-bold ph-magic-wand text-lg"></i> ประมวลผลข้อมูล</button>
                    <div class="w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden sm:block h-8"></div>
                    <button onclick="removeNoTaxItems()"
                        class="action-btn border-orange-200 hover:border-orange-400 text-orange-600 hover:bg-orange-50 dark:border-orange-900 dark:text-orange-400 dark:hover:bg-orange-900/20"><i
                            class="ph-bold ph-prohibit text-lg"></i> TKO</button>
                    <div class="w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden sm:block h-8"></div>
                    <button onclick="clearAllData()"
                        class="action-btn border-slate-200 hover:border-red-200 hover:bg-red-50 text-slate-600 hover:text-red-600 dark:border-slate-600 dark:text-slate-400 dark:hover:text-red-400 dark:hover:bg-red-900/20"><i
                            class="ph-bold ph-trash text-lg"></i> ล้างค่า</button>
                </div>
            </div>
        </section>

        <div id="emptyState" class="flex flex-col items-center justify-center py-16 text-center animate-fade-in">
            <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6"><i
                    class="ph-duotone ph-chart-bar text-4xl text-slate-300 dark:text-slate-600"></i></div>
            <h3 class="text-lg font-bold text-slate-700 dark:text-slate-300">รอรับข้อมูล</h3>
            <p class="text-slate-500 dark:text-slate-500 text-sm mt-1">วางข้อมูล หรือ นำเข้าไฟล์ CSV/Project
                เพื่อเริ่มใช้งาน</p>
        </div>

        <div id="resultSection" class="hidden space-y-8">

            <div
                class="flex items-center justify-between border-b-2 border-slate-200 dark:border-slate-700 mb-6 bg-transparent relative">
                <div class="flex gap-6">
                    <button onclick="switchMainTab('overview')" id="btn-tab-overview"
                        class="main-tab-btn main-tab-active"><i class="ph-bold ph-table"></i> Overview</button>
                    <button onclick="switchMainTab('analytics')" id="btn-tab-analytics"
                        class="main-tab-btn main-tab-inactive"><i class="ph-bold ph-chart-bar"></i> Analytics</button>
                    <button onclick="switchMainTab('customer')" id="btn-tab-customer"
                        class="main-tab-btn main-tab-inactive"><i class="ph-bold ph-users"></i> Customer</button>
                </div>
                <button onclick="copySummary()"
                    class="p-2 text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 transition-colors rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 mb-1"
                    title="คัดลอกสรุป"><i class="ph-bold ph-copy text-xl"></i></button>
            </div>

            <div id="view-overview" class="space-y-8 animate-fade-in">

                <div class="cards-grid animate-slide-up">
                    <article class="stat-card-new">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-full">
                                <p class="text-xs text-gray-400 mb-1 flex items-center justify-between">
                                    <span class="flex items-center gap-1"><i
                                            class="ph-fill ph-chart-line-up text-orange-500"></i> ยอดขายรวม</span>
                                    <button onclick="togglePrivacyMode()" id="btnPrivacy"
                                        class="text-gray-500 hover:text-white transition-colors"><i id="iconPrivacy"
                                            class="ph-bold ph-eye"></i></button>
                                </p>
                                <h3 class="text-2xl font-bold text-white tracking-tight" id="cardTotalRevenue">0.00</h3>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="space-y-0.5 mb-2">
                                <div class="card-row"><span>เงินสด</span><span class="card-row-val text-orange-400"
                                        id="det-t-cash">0.00</span></div>
                                <div class="card-row"><span>บัตรเครดิต</span><span class="card-row-val text-purple-400"
                                        id="det-t-credit">0.00</span></div>
                                <div class="card-row"><span>บัญชีธนาคาร</span><span class="card-row-val text-blue-400"
                                        id="det-t-trans">0.00</span></div>
                                <div class="card-row"><span>ลูกหนี้</span><span class="card-row-val text-teal-400"
                                        id="det-t-ar">0.00</span></div>
                            </div>
                            <div class="stacked-bar-container">
                                <div id="bar-t-cash" class="seg-bar seg-cash" style="width: 0%"></div>
                                <div id="bar-t-credit" class="seg-bar seg-credit" style="width: 0%"></div>
                                <div id="bar-t-trans" class="seg-bar seg-trans" style="width: 0%"></div>
                                <div id="bar-t-ar" class="seg-bar seg-ar" style="width: 0%"></div>
                            </div>
                        </div>
                    </article>

                    <article class="stat-card-new">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-full">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="text-xs text-gray-400 flex items-center gap-1"><i
                                            class="ph-fill ph-truck text-indigo-400"></i> ขายส่ง</p>
                                    <span class="text-[10px] text-indigo-400 font-bold"
                                        id="pct-wholesale-total">0%</span>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2" id="cardTotalWholesale">0.00</h3>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="space-y-0.5 mb-2">
                                <div class="card-row"><span>เงินสด</span><span class="card-row-val"
                                        id="det-w-cash">0.00</span></div>
                                <div class="card-row"><span>โอน</span><span class="card-row-val"
                                        id="det-w-trans">0.00</span></div>
                                <div class="card-row"><span>เครดิต</span><span class="card-row-val"
                                        id="det-w-credit">0.00</span></div>
                            </div>
                            <div class="stacked-bar-container">
                                <div id="bar-w-cash" class="seg-bar seg-cash" style="width: 0%"></div>
                                <div id="bar-w-credit" class="seg-bar seg-credit" style="width: 0%"></div>
                                <div id="bar-w-trans" class="seg-bar seg-trans" style="width: 0%"></div>
                                <div id="bar-w-ar" class="seg-bar seg-ar" style="width: 0%"></div>
                            </div>
                            <div class="legend-row justify-end">
                                <span class="text-[10px] text-gray-500" id="cardCountWholesale">0 บิล</span>
                            </div>
                        </div>
                    </article>

                    <article class="stat-card-new">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-full">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="text-xs text-gray-400 flex items-center gap-1"><i
                                            class="ph-fill ph-storefront text-emerald-400"></i> ขายปลีก</p>
                                    <span class="text-[10px] text-emerald-400 font-bold" id="pct-retail-total">0%</span>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2" id="cardTotalRetail">0.00</h3>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="space-y-0.5 mb-2">
                                <div class="card-row"><span>เงินสด</span><span class="card-row-val"
                                        id="det-r-cash">0.00</span></div>
                                <div class="card-row"><span>โอน</span><span class="card-row-val"
                                        id="det-r-trans">0.00</span></div>
                                <div class="card-row"><span>เครดิต</span><span class="card-row-val"
                                        id="det-r-credit">0.00</span></div>
                            </div>
                            <div class="stacked-bar-container">
                                <div id="bar-r-cash" class="seg-bar seg-cash" style="width: 0%"></div>
                                <div id="bar-r-credit" class="seg-bar seg-credit" style="width: 0%"></div>
                                <div id="bar-r-trans" class="seg-bar seg-trans" style="width: 0%"></div>
                                <div id="bar-r-ar" class="seg-bar seg-ar" style="width: 0%"></div>
                            </div>
                            <div class="legend-row justify-end">
                                <span class="text-[10px] text-gray-500" id="cardCountRetail">0 บิล</span>
                            </div>
                        </div>
                    </article>

                    <article class="stat-card-new">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-full">
                                <p class="text-xs text-gray-400 mb-1 flex items-center gap-1"><i
                                        class="ph-fill ph-bank text-blue-400"></i> เงินโอนรวม</p>
                                <h3 class="text-xl font-bold text-white mb-2" id="miniTotalTransfer">0.00</h3>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="space-y-0.5 mt-2">
                                <div class="card-row"><span>LPM</span><span class="card-row-val text-cyan-300"
                                        id="det-t-lpm">0.00</span></div>
                                <div class="card-row"><span>Fiscal</span><span class="card-row-val text-blue-300"
                                        id="det-t-fiscal">0.00</span></div>
                                <div class="card-row"><span>SCB</span><span class="card-row-val text-indigo-300"
                                        id="det-t-scb">0.00</span></div>
                            </div>
                            <div class="stacked-bar-container" style="background: #1e3a8a;">
                                <div id="prog-transfer" class="seg-bar seg-trans" style="width: 0%"></div>
                            </div>
                        </div>
                    </article>
                </div>

                <div class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden animate-slide-up"
                    style="animation-delay: 0.1s;">
                    <div
                        class="px-6 pt-5 pb-0 flex flex-col gap-4 bg-white dark:bg-dark-800 border-b border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div
                                    class="text-xs text-slate-500 font-medium bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-lg flex items-center gap-2">
                                    <i class="ph-bold ph-calendar-blank"></i> <span id="summaryDateRange">-</span>
                                    <span id="cardTotalCount" class="hidden">0 บิล</span>
                                </div>
                                <div id="flagCounterContainer"
                                    class="hidden items-center gap-2 cursor-pointer bg-yellow-400 hover:bg-yellow-500 text-slate-900 px-3 py-1.5 rounded-full shadow-sm transition-all"
                                    onclick="clearAllFlags()" title="ล้าง Highlight ทั้งหมด">
                                    <i class="ph-fill ph-flag"></i>
                                    <span id="flagCountValue" class="font-bold text-xs">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="relative">
                            <i
                                class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="searchInput" oninput="handleSearch(event)"
                                class="w-full pl-11 pr-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-xl shadow-sm focus:ring-4 focus:ring-brand-500/20 focus:border-brand-500 transition-all text-sm text-slate-800 dark:text-slate-200"
                                placeholder="ค้นหา (ชื่อลูกค้า, เลขที่บิล, ยอดเงิน, พนักงาน)...">
                        </div>

                        <div id="pocketActionBar"
                            class="hidden bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800 rounded-lg p-3 flex justify-between items-center animate-fade-in mb-2">
                            <div class="flex items-center gap-2 text-orange-800 dark:text-orange-200 font-bold text-sm">
                                <i class="ph-fill ph-archive-box"></i> รายการใน Pocket (ชั่วคราว)
                            </div>
                            <button onclick="restoreAllPocket()"
                                class="bg-white dark:bg-slate-800 border border-orange-200 dark:border-orange-700 hover:bg-orange-100 dark:hover:bg-orange-900 text-orange-700 dark:text-orange-300 text-xs font-bold px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-all">
                                <i class="ph-bold ph-arrow-u-up-left"></i> Restore All (คืนทั้งหมด)
                            </button>
                        </div>

                        <div id="bulkActionBar"
                            class="hidden bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-lg p-3 flex justify-between items-center animate-fade-in mb-2">
                            <div class="flex items-center gap-2 text-indigo-700 dark:text-indigo-300 font-bold text-sm">
                                <div class="w-6 h-6 bg-indigo-200 dark:bg-indigo-800 rounded-full flex items-center justify-center text-xs"
                                    id="selectedCountBadge">0</div> รายการที่เลือก
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openChangeStaffModal()"
                                    class="bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-700 hover:bg-indigo-50 dark:hover:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-xs font-bold px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-all"><i
                                        class="ph-bold ph-user-switch"></i> เปลี่ยนพนักงาน</button>
                                <button onclick="openTransferModal(null, true)"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-all"><i
                                        class="ph-bold ph-lightning"></i> ย้ายประเภทการชำระเงิน</button>
                            </div>
                        </div>

                        <div class="flex overflow-x-auto no-scrollbar gap-3 flex-1 max-w-full pb-2">
                            <button onclick="switchTab('all')" id="tab-all" class="tab-btn tab-active">
                                <div>ทั้งหมด <span id="count-all"></span></div>
                                <div id="amt-all" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('wholesale')" id="tab-wholesale" class="tab-btn tab-inactive">
                                <div>ขายส่ง <span id="count-wholesale"></span></div>
                                <div id="amt-wholesale" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('retail')" id="tab-retail" class="tab-btn tab-inactive">
                                <div>ขายปลีก <span id="count-retail"></span></div>
                                <div id="amt-retail" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <div class="w-px bg-slate-300 dark:bg-slate-600 mx-2 h-6 self-center flex-shrink-0"></div>
                            <button onclick="switchTab('cash')" id="tab-cash"
                                class="tab-btn tab-inactive text-orange-600 dark:text-orange-400">
                                <div><i class="ph-fill ph-money text-orange-500"></i> เงินสด <span
                                        id="count-cash"></span></div>
                                <div id="amt-cash" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('lpm')" id="tab-lpm"
                                class="tab-btn tab-inactive text-cyan-600 dark:text-cyan-400">
                                <div><i class="ph-fill ph-bank text-cyan-500"></i> LPM <span id="count-lpm"></span>
                                </div>
                                <div id="amt-lpm" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('fiscal')" id="tab-fiscal"
                                class="tab-btn tab-inactive text-blue-600 dark:text-blue-400">
                                <div><i class="ph-fill ph-bank text-blue-500"></i> FISCAL <span
                                        id="count-fiscal"></span></div>
                                <div id="amt-fiscal" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('scb')" id="tab-scb"
                                class="tab-btn tab-inactive text-indigo-600 dark:text-indigo-400">
                                <div><i class="ph-fill ph-bank text-indigo-500"></i> SCB <span id="count-scb"></span>
                                </div>
                                <div id="amt-scb" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('credit')" id="tab-credit"
                                class="tab-btn tab-inactive text-purple-600 dark:text-purple-400">
                                <div><i class="ph-fill ph-credit-card text-purple-500"></i> บัตรเครดิต <span
                                        id="count-credit"></span></div>
                                <div id="amt-credit" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                            <button onclick="switchTab('ar')" id="tab-ar"
                                class="tab-btn tab-inactive text-teal-600 dark:text-teal-400">
                                <div><i class="ph-fill ph-user-list text-teal-500"></i> ลูกหนี้ <span
                                        id="count-ar"></span></div>
                                <div id="amt-ar" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>

                            <button onclick="switchTab('pocket')" id="tab-pocket"
                                class="tab-btn tab-inactive hidden text-slate-500 bg-slate-100 dark:bg-slate-900 border-l border-r border-t-0 ml-auto flex-none w-[100px]">
                                <div><i class="ph-fill ph-archive-box text-slate-400"></i> Pocket <span
                                        id="count-pocket"></span></div>
                                <div id="amt-pocket" class="text-[10px] font-normal opacity-90 mt-0.5">0.00</div>
                            </button>
                        </div>
                    </div>

                    <div id="tableContainer" class="overflow-x-auto max-h-[600px] custom-scrollbar relative">
                        <table class="w-full text-sm text-left whitespace-nowrap text-slate-600 dark:text-slate-300"
                            id="salesTable">
                            <thead
                                class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 sticky top-0 z-10 glass-header shadow-sm">
                                <tr>
                                    <th
                                        class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700 w-[50px]">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"
                                            class="custom-checkbox">
                                    </th>
                                    <th
                                        class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700 w-[50px]">
                                        #</th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[150px]"
                                        onclick="toggleSort()">เลขที่ / ประเภท <i id="sortIcon"
                                            class="ph-bold ph-arrows-down-up ml-1 text-slate-400"></i></th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[100px]">
                                        วันที่ขาย</th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700">เลขที่ภาษี</th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700">ชื่อลูกค้า</th>
                                    <th class="px-4 py-3 font-semibold text-right border-b dark:border-slate-700">
                                        ยอดเงิน</th>
                                    <th class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700">
                                        จ่ายโดย</th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[350px]">Memo
                                    </th>
                                    <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[130px]">
                                        พนักงานขาย</th>
                                    <th class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody"
                                class="divide-y divide-slate-50 dark:divide-slate-700 bg-white dark:bg-dark-800">
                            </tbody>
                        </table>
                        <div id="noSearchResults" class="hidden py-10 text-center text-slate-400 dark:text-slate-500">
                            <p>ไม่พบข้อมูลในหมวดนี้</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="hidden space-y-6 animate-fade-in">
                <div
                    class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm"><i
                                class="ph-fill ph-chart-bar text-brand-500 mr-1"></i> ยอดขายรายพนักงาน (รวม)</h4>
                        <button onclick="togglePrivacyMode()" id="btnPrivacyAnalytics"
                            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
                            title="ปิด/เปิด ยอดเงิน"><i class="ph-bold ph-eye text-lg"></i></button>
                    </div>
                    <div class="relative h-[320px] w-full"><canvas id="salesChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div
                        class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 h-[400px]">
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm mb-4"><i
                                class="ph-fill ph-storefront text-emerald-500 mr-1"></i> แนวโน้มขายปลีก (Retail Trend)
                        </h4>
                        <div class="relative h-[320px] w-full"><canvas id="retailChart"></canvas></div>
                    </div>
                    <div
                        class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 h-[400px]">
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm mb-4"><i
                                class="ph-fill ph-truck text-indigo-500 mr-1"></i> แนวโน้มขายส่ง (Wholesale Trend)</h4>
                        <div class="relative h-[320px] w-full"><canvas id="wholesaleChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div
                        class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col h-[500px]">
                        <div
                            class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                            <h4 id="staffRankingHeader"
                                class="font-bold text-slate-800 dark:text-slate-200 text-sm flex items-center gap-2"><i
                                    class="ph-fill ph-trophy text-yellow-500"></i> อันดับพนักงานขาย</h4>
                        </div>
                        <div class="overflow-y-auto custom-scrollbar flex-1">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <tbody id="staffTableBody" class="divide-y divide-slate-50 dark:divide-slate-700">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col h-[500px]">
                        <div
                            class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                            <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm flex items-center gap-2"><i
                                    class="ph-fill ph-gauge text-blue-500"></i> ประสิทธิภาพการขาย (Performance)</h4>
                        </div>
                        <div class="overflow-y-auto custom-scrollbar flex-1">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <thead
                                    class="text-xs text-slate-400 uppercase bg-slate-50 dark:bg-slate-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2">พนักงาน</th>
                                        <th class="px-4 py-2 text-right text-emerald-600">บิลปลีก</th>
                                        <th class="px-4 py-2 text-right text-emerald-600">เฉลี่ย/บิล</th>
                                        <th class="px-4 py-2 text-right text-indigo-600">บิลส่ง</th>
                                        <th class="px-4 py-2 text-right text-indigo-600">เฉลี่ย/บิล</th>
                                    </tr>
                                </thead>
                                <tbody id="staffStatsBody" class="divide-y divide-slate-50 dark:divide-slate-700">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-customer" class="hidden space-y-6 animate-fade-in">
                <div
                    class="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 animate-slide-up">
                    <h4 class="font-bold text-slate-800 dark:text-slate-200 mb-4 flex items-center gap-2"><i
                            class="ph-fill ph-funnel text-brand-600"></i> ตัวกรองข้อมูลลูกค้า (Customer Filters)</h4>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="space-y-3">
                            <label
                                class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">ประเภทบิล</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="cust-filter-retail" class="cust-filter-chk" checked> <label
                                    for="cust-filter-retail" class="text-sm cursor-pointer dark:text-slate-300">ขายปลีก
                                    (Retail)</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="cust-filter-wholesale" class="cust-filter-chk" checked>
                                <label for="cust-filter-wholesale"
                                    class="text-sm cursor-pointer dark:text-slate-300">ขายส่ง (Wholesale)</label>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <label
                                class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">การชำระเงิน</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex items-center gap-2"><input type="checkbox" id="cust-filter-cash"
                                        class="cust-filter-chk" checked> <label
                                        class="text-sm dark:text-slate-300">เงินสด</label></div>
                                <div class="flex items-center gap-2"><input type="checkbox" id="cust-filter-credit"
                                        class="cust-filter-chk" checked> <label
                                        class="text-sm dark:text-slate-300">เครดิต</label></div>
                                <div class="flex items-center gap-2"><input type="checkbox" id="cust-filter-transfer"
                                        class="cust-filter-chk" checked> <label class="text-sm dark:text-slate-300">โอน
                                        (All)</label></div>
                                <div class="flex items-center gap-2"><input type="checkbox" id="cust-filter-ar"
                                        class="cust-filter-chk" checked> <label
                                        class="text-sm dark:text-slate-300">ลูกหนี้</label></div>
                            </div>
                        </div>

                        <div class="space-y-3 md:col-span-2">
                            <label
                                class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">เงื่อนไขยอดเงิน</label>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-600 dark:text-slate-400">ยอดขายตั้งแต่</span>
                                <input type="number" id="cust-filter-min-amount"
                                    class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg w-40 text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white dark:bg-slate-900 dark:text-white"
                                    placeholder="0.00">
                                <span class="text-sm text-slate-600 dark:text-slate-400">บาท ขึ้นไป</span>
                            </div>
                            <button onclick="filterCustomers()"
                                class="mt-2 bg-brand-600 hover:bg-brand-700 text-white font-medium py-2 px-6 rounded-lg text-sm transition-all flex items-center gap-2 shadow-sm"><i
                                    class="ph-bold ph-magnifying-glass"></i> ค้นหาข้อมูล</button>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 dark:border-slate-700 pt-6">
                        <div class="flex justify-between items-end mb-3">
                            <h5 class="text-sm font-bold text-slate-700 dark:text-slate-300">ผลการค้นหา: <span
                                    id="cust-result-count" class="text-brand-600">0</span> รายการ</h5>
                        </div>
                        <div
                            class="overflow-x-auto max-h-[500px] custom-scrollbar border border-slate-200 dark:border-slate-700 rounded-xl">
                            <table
                                class="w-full text-sm text-left whitespace-nowrap text-slate-600 dark:text-slate-300">
                                <thead
                                    class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800 sticky top-0 z-10 glass-header shadow-sm">
                                    <tr>
                                        <th
                                            class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700 w-[50px]">
                                            <input type="checkbox" class="custom-checkbox" disabled>
                                        </th>
                                        <th
                                            class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700 w-[50px]">
                                            #</th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[150px]">
                                            เลขที่ / ประเภท</th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[100px]">
                                            วันที่ขาย</th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700">เลขที่ภาษี
                                        </th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700">ชื่อลูกค้า
                                        </th>
                                        <th class="px-4 py-3 font-semibold text-right border-b dark:border-slate-700">
                                            ยอดเงิน</th>
                                        <th class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700">
                                            จ่ายโดย</th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[350px]">
                                            Memo</th>
                                        <th class="px-4 py-3 font-semibold border-b dark:border-slate-700 w-[130px]">
                                            พนักงานขาย</th>
                                        <th class="px-4 py-3 font-semibold text-center border-b dark:border-slate-700">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="customerTableBody"
                                    class="divide-y divide-slate-50 dark:divide-slate-700 bg-white dark:bg-dark-800">
                                    <tr>
                                        <td colspan="11" class="text-center py-8 text-slate-400">กรุณากดค้นหา...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="editModal" class="fixed inset-0 z-50 hidden fade-in">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="flex items-center justify-center min-h-screen px-4 pointer-events-none">
            <div
                class="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl z-10 w-full max-w-xl transform transition-all scale-100 p-0 pointer-events-auto overflow-hidden animate-slide-up">
                <div
                    class="bg-gradient-to-r from-brand-600 to-indigo-600 px-6 py-4 flex justify-between items-center text-white">
                    <h3 class="text-base font-bold flex items-center gap-2"><i
                            class="ph-bold ph-pencil-simple-line"></i> แก้ไขข้อมูล (Edit)</h3>
                    <button onclick="closeModal()" class="text-white/80 hover:text-white"><i
                            class="ph-bold ph-x text-xl"></i></button>
                </div>
                <div class="p-6">
                    <input type="hidden" id="modalRowId">
                    <div class="mb-4"><label
                            class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">📝 บันทึกช่วยจำ
                            (Memo)</label><textarea id="inputMemo" rows="2"
                            class="w-full px-3 py-2 border border-slate-200 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm bg-slate-50 dark:bg-slate-900 dark:text-white resize-none"></textarea>
                    </div>
                    <div class="border-t border-slate-100 dark:border-slate-700 my-4"></div>
                    <div
                        class="flex justify-between items-center mb-3 bg-indigo-50 dark:bg-indigo-900/30 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800">
                        <label class="block text-sm font-bold text-indigo-800 dark:text-indigo-300">💰 ยอดเงินรวมสุทธิ
                            (Net Total)</label><input type="number" id="inputTotalAmount"
                            class="w-1/2 px-3 py-2 border border-indigo-200 dark:border-indigo-700 rounded-lg text-right text-lg font-bold text-indigo-700 dark:text-indigo-300 focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-slate-900"
                            step="0.01" readonly>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <h4
                                class="text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase border-b border-slate-200 dark:border-slate-700 pb-1">
                                รายการรับ (Received)</h4>
                            <div class="space-y-2">
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">💸 เงินสด</label><input
                                        type="number" id="inputCash"
                                        class="modal-input bg-orange-50/50 dark:bg-orange-900/10" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">💳 บัตรเครดิต</label><input
                                        type="number" id="inputCredit"
                                        class="modal-input bg-purple-50/50 dark:bg-purple-900/10" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">🧾 ลูกหนี้</label><input
                                        type="number" id="inputCreditAR"
                                        class="modal-input bg-teal-50/50 dark:bg-teal-900/10" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">LPM</label><input
                                        type="number" id="inputTransferLPM" class="modal-input" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">Fiscal</label><input
                                        type="number" id="inputTransferFiscal" class="modal-input" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-slate-400 block mb-0.5">SCB415</label><input
                                        type="number" id="inputTransferSCB" class="modal-input" step="0.01"
                                        oninput="calculateNetTotal()"></div>
                            </div>
                        </div>
                        <div
                            class="bg-red-50/50 dark:bg-red-900/5 p-2 rounded-lg border border-red-100 dark:border-red-900/20">
                            <h4
                                class="text-xs font-bold text-red-500 dark:text-red-400 mb-2 uppercase border-b border-red-200 dark:border-red-900/30 pb-1">
                                คืนสินค้า/เงินทอน (Return)</h4>
                            <div class="space-y-2">
                                <div><label class="text-[10px] text-red-400 block mb-0.5">คืน/ทอน เงินสด</label><input
                                        type="number" id="inputReturnCash" class="modal-input-return" placeholder="0.00"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-red-400 block mb-0.5">คืน เครดิต</label><input
                                        type="number" id="inputReturnCredit" class="modal-input-return"
                                        placeholder="0.00" oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-red-400 block mb-0.5">ลดหนี้</label><input
                                        type="number" id="inputReturnAR" class="modal-input-return" placeholder="0.00"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-red-400 block mb-0.5">คืน LPM</label><input
                                        type="number" id="inputReturnLPM" class="modal-input-return" placeholder="0.00"
                                        oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-red-400 block mb-0.5">คืน Fiscal</label><input
                                        type="number" id="inputReturnFiscal" class="modal-input-return"
                                        placeholder="0.00" oninput="calculateNetTotal()"></div>
                                <div><label class="text-[10px] text-red-400 block mb-0.5">คืน SCB</label><input
                                        type="number" id="inputReturnSCB" class="modal-input-return" placeholder="0.00"
                                        oninput="calculateNetTotal()"></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex justify-between items-center bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-100 dark:border-slate-700 mb-6">
                        <span class="text-xs text-slate-500 dark:text-slate-400">สถานะการคำนวณ:</span><span
                            id="modalRemaining" class="font-bold text-sm text-green-500">Auto Calculated</span>
                    </div>
                    <button onclick="saveData()"
                        class="w-full bg-brand-600 hover:bg-brand-700 text-white font-medium py-3 rounded-xl shadow-lg shadow-brand-200 transition-all text-sm">บันทึกการเปลี่ยนแปลง</button>
                </div>
            </div>
        </div>
    </div>

    <div id="changeStaffModal" class="fixed inset-0 z-50 hidden flex items-center justify-center pointer-events-none">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm pointer-events-auto"
            onclick="closeChangeStaffModal()"></div>
        <div
            class="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl z-10 w-full max-w-sm p-6 pointer-events-auto relative animate-slide-up">
            <button onclick="closeChangeStaffModal()"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i
                    class="ph-bold ph-x text-lg"></i></button>
            <div class="text-center mb-6">
                <div
                    class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600 dark:text-indigo-400">
                    <i class="ph-bold ph-user-switch text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">เปลี่ยนพนักงานขาย</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">รายการที่เลือกจะถูกย้ายไปหาพนักงานท่านนี้</p>
            </div>
            <div class="space-y-4">
                <select id="bulkStaffSelect"
                    class="w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl text-sm outline-none focus:ring-2 focus:ring-brand-500 bg-slate-50 dark:bg-slate-900 dark:text-white"></select>
                <button onclick="executeChangeStaff()"
                    class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all">ยืนยันการเปลี่ยน</button>
            </div>
        </div>
    </div>

    <div id="transferModal" class="fixed inset-0 z-50 hidden fade-in">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeTransferModal()"></div>
        <div class="flex items-center justify-center min-h-screen px-4 pointer-events-none">
            <div
                class="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl z-10 w-full max-w-sm p-6 pointer-events-auto animate-slide-up relative">
                <button onclick="closeTransferModal()"
                    class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i
                        class="ph-bold ph-x text-lg"></i></button>
                <div class="text-center mb-6">
                    <div
                        class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600 dark:text-indigo-400">
                        <i class="ph-bold ph-arrows-left-right text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100" id="transferModalTitle">
                        ย้ายยอดเงินด่วน</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1" id="transferModalDesc">...</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="executeTransfer('cash')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-orange-500 dark:hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 flex flex-col items-center gap-2 transition-all group"><i
                            class="ph-fill ph-money text-2xl text-slate-400 dark:text-slate-500 group-hover:text-orange-500"></i>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-orange-600">เงินสด</span></button>
                    <button onclick="executeTransfer('credit')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-purple-500 dark:hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 flex flex-col items-center gap-2 transition-all group"><i
                            class="ph-fill ph-credit-card text-2xl text-slate-400 dark:text-slate-500 group-hover:text-purple-500"></i>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-purple-600">บัตรเครดิต</span></button>
                    <button onclick="executeTransfer('lpm')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-cyan-500 dark:hover:border-cyan-500 hover:bg-cyan-50 dark:hover:bg-cyan-900/20 flex flex-col items-center gap-2 transition-all group"><span
                            class="text-xl font-bold text-slate-400 dark:text-slate-500 group-hover:text-cyan-500">LPM</span>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-cyan-600">LPM</span></button>
                    <button onclick="executeTransfer('fiscal')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-blue-500 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 flex flex-col items-center gap-2 transition-all group"><span
                            class="text-xl font-bold text-slate-400 dark:text-slate-500 group-hover:text-blue-500">FIS</span>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-blue-600">Fiscal</span></button>
                    <button onclick="executeTransfer('scb')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 flex flex-col items-center gap-2 transition-all group"><span
                            class="text-xl font-bold text-slate-400 dark:text-slate-500 group-hover:text-indigo-500">SCB</span>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-indigo-600">SCB
                            415</span></button>
                    <button onclick="executeTransfer('ar')"
                        class="p-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:border-teal-500 dark:hover:border-teal-500 hover:bg-teal-50 dark:hover:bg-teal-900/20 flex flex-col items-center gap-2 transition-all group"><i
                            class="ph-fill ph-user-list text-2xl text-slate-400 dark:text-slate-500 group-hover:text-teal-500"></i>
                        <span
                            class="text-xs font-bold text-slate-600 dark:text-slate-300 group-hover:text-teal-600">ลูกหนี้</span></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let allData = [];
        let filteredData = [];
        let activeTab = 'all';
        let myChart = null;
        let retailChart = null; // New chart instance
        let wholesaleChart = null; // New chart instance
        let sortDirection = 'none';
        let selectedIds = new Set();
        let isPrivacyMode = false;
        let currentEditId = null;
        let isBulkTransfer = false;
        let currentTransferId = null;

        const staffMap = [
            { key: "Opalll", full: "Opalll ไอรินทร์ สุวรรณวงศ์พร" },
            { key: "รัตนา", full: "STAFF รัตนา ศิริโชคชัยมงคล" },
            { key: "Thipnaree", full: "Thipnaree J" },
            { key: "Trayaporn", full: "T. Trayaporn" },
            { key: "สุพิชญา", full: "สุพิชญา โกศลกิตติพงศ์" }
        ];

        // --- 2. HELPER FUNCTIONS ---
        function generateStaffOptions(c) {
            let o = staffMap.map(s => `<option value="${s.full}" ${s.full === c ? 'selected' : ''}>${s.full}</option>`).join('');
            if (c === '-') o = `<option value="-" selected class="text-red-500 font-bold">❌ ระบุ</option>` + o;
            return o;
        }

        function maskCustomerName(name) {
            if (!name || name.length < 3) return "***";
            if (name.length > 6) return "******" + name.substring(6);
            return "******" + name.substring(Math.max(0, name.length - 2));
        }

        function highlightText(t, q) {
            if (!q) return t;
            return String(t).replace(new RegExp(`(${q})`, 'gi'), '<mark>$1</mark>');
        }

        function checkShortcut(e) { if (e.ctrlKey && e.key === 'Enter') startProcessing(); }

        function showToast(m, t = 'success') {
            const c = document.getElementById('toastContainer');
            const e = document.createElement('div');
            e.className = `${t === 'success' ? 'bg-green-600' : 'bg-red-500'} text-white px-4 py-2.5 rounded-lg shadow-xl mb-2 animate-fade-in text-sm font-medium`;
            e.innerHTML = `<i class="ph-bold ${t === 'success' ? 'ph-check-circle' : 'ph-warning-circle'} text-lg"></i> ${m}`;
            c.appendChild(e);
            setTimeout(() => { e.remove() }, 3000);
        }

        function updateDateRange(data) {
            const activeData = data.filter(r => !r.isExcluded);
            const dates = activeData.map(r => r.date).filter(d => d && d !== '-');
            if (dates.length === 0) {
                document.getElementById('summaryDateRange').innerText = "-";
                return;
            }
            const uniqueDates = [...new Set(dates)].sort((a, b) => {
                const [d1, m1, y1] = a.split('/'); const [d2, m2, y2] = b.split('/');
                return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
            });
            let dateStr = "";
            if (uniqueDates.length === 1) dateStr = uniqueDates[0];
            else dateStr = `${uniqueDates[0]} - ${uniqueDates[uniqueDates.length - 1]}`;

            document.getElementById('summaryDateRange').innerText = dateStr;
            document.getElementById('staffRankingHeader').innerHTML = `<i class="ph-fill ph-trophy text-yellow-500"></i> อันดับพนักงานขาย <span class="text-xs font-normal text-slate-500 ml-1 dark:text-slate-400">ประจำวันที่ ${dateStr}</span>`;
        }

        // --- 3. UI STATE MANAGEMENT ---
        function togglePrivacyMode() {
            isPrivacyMode = !isPrivacyMode;
            const btn = document.getElementById('btnPrivacy');
            const icon = document.getElementById('iconPrivacy');
            const btnAna = document.getElementById('btnPrivacyAnalytics');
            if (isPrivacyMode) {
                if (btn) {
                    btn.classList.add('bg-red-500', 'hover:bg-red-600');
                    btn.classList.remove('bg-white/20', 'hover:bg-white/30');
                }
                if (icon) icon.classList.replace('ph-eye', 'ph-eye-slash');
                if (btnAna) btnAna.innerHTML = '<i class="ph-bold ph-eye-slash text-lg text-red-500"></i>';
            } else {
                if (btn) {
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-white/20', 'hover:bg-white/30');
                }
                if (icon) icon.classList.replace('ph-eye-slash', 'ph-eye');
                if (btnAna) btnAna.innerHTML = '<i class="ph-bold ph-eye text-lg"></i>';
            }
            renderAll(document.getElementById('searchInput').value.toLowerCase().trim());
        }

        function resetUI() {
            document.getElementById('searchInput').value = '';
            activeTab = 'all';
            selectedIds.clear();
            switchTab('all');
            switchMainTab('overview');
        }

        function updateBulkActionBar() {
            const bar = document.getElementById('bulkActionBar');
            const count = selectedIds.size;
            if (count > 0) {
                document.getElementById('selectedCountBadge').innerText = count;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
            document.getElementById('selectAllCheckbox').checked = (filteredData.length > 0 && filteredData.every(r => selectedIds.has(r.id)));
        }

        function switchMainTab(tab) {
            const overview = document.getElementById('view-overview');
            const analytics = document.getElementById('view-analytics');
            const customer = document.getElementById('view-customer');
            const btnOver = document.getElementById('btn-tab-overview');
            const btnAna = document.getElementById('btn-tab-analytics');
            const btnCust = document.getElementById('btn-tab-customer');

            // Reset Styles
            [btnOver, btnAna, btnCust].forEach(btn => {
                btn.className = "main-tab-btn border-transparent hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800";
            });
            [overview, analytics, customer].forEach(view => view.classList.add('hidden'));

            if (tab === 'overview') {
                overview.classList.remove('hidden');
                btnOver.className = "main-tab-btn main-tab-active";
            } else if (tab === 'analytics') {
                analytics.classList.remove('hidden');
                btnAna.className = "main-tab-btn main-tab-active";
                if (myChart) myChart.resize();
            } else if (tab === 'customer') {
                customer.classList.remove('hidden');
                btnCust.className = "main-tab-btn main-tab-active";
                filterCustomers(); // Auto-load customer data V136.24
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('themeIcon').className = isDark ? 'ph-bold ph-sun text-xl' : 'ph-bold ph-moon text-xl';
            refreshData();
        }

        function toggleSort() {
            const icon = document.getElementById('sortIcon');
            if (sortDirection === 'none') {
                sortDirection = 'asc';
                icon.className = 'ph-bold ph-sort-ascending ml-1 text-brand-500';
            } else if (sortDirection === 'asc') {
                sortDirection = 'desc';
                icon.className = 'ph-bold ph-sort-descending ml-1 text-brand-500';
            } else {
                sortDirection = 'none';
                icon.className = 'ph-bold ph-arrows-down-up ml-1 text-slate-400';
            }
            refreshData();
        }

        // --- 4. DATA PROCESSING ---
        function startProcessing() {
            const text = document.getElementById('inputData').value;
            if (!text.trim()) { showToast("ไม่พบข้อมูล", "error"); return; }
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            resetUI();

            setTimeout(() => {
                try {
                    processData(text);
                    showToast("เสร็จสิ้น");
                } catch (e) {
                    showToast("Error: " + e.message, "error");
                    console.error(e);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('loadingOverlay').classList.remove('flex');
                }
            }, 500);
        }

        function processData(text) {
            allData = [];
            const processedIds = new Set();
            const rawBlocks = text.split(/(?=OR[RW]-)/i);
            rawBlocks.forEach((block, index) => {
                if (block.trim().length < 10) return;
                let lines = block.replace(/\t/g, '\n').split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
                let amountIdx = -1, salesIdx = -1, orderId = "-", date = "-", invoiceId = "-", amountVal = 0, amountStr = "0.00";

                for (let i = 0; i < lines.length; i++) {
                    const l = lines[i];
                    if (l.match(/OR[RW]-[\d-]+/i)) orderId = l.match(/OR[RW]-[\d-]+/i)[0].toUpperCase();
                    if (l.match(/(IN[VS]-[\d-]+)/)) invoiceId = l.match(/(IN[VS]-[\d-]+)/)[0];
                    if (l.match(/(\d{1,2}\/\d{1,2}\/\d{4})/)) date = l.match(/(\d{1,2}\/\d{1,2}\/\d{4})/)[0];
                    if (l.match(/(?<!\d)([\d,]+\.\d{2})(?!\d)/)) {
                        const m = l.match(/(?<!\d)([\d,]+\.\d{2})(?!\d)/);
                        amountStr = m[0];
                        amountVal = parseFloat(amountStr.replace(/,/g, ''));
                        amountIdx = i;
                    }
                }

                let saleType = orderId.includes("ORW") ? "Wholesale" : (orderId.includes("ORR") ? "Retail" : "Unknown");
                let salesperson = "-";
                for (let i = lines.length - 1; i >= 0; i--) {
                    const matched = staffMap.find(s => lines[i].includes(s.key));
                    if (matched) { salesperson = matched.full; salesIdx = i; break; }
                }

                let customerName = amountIdx > 0 ? lines.slice(0, amountIdx).filter(l => !l.includes(orderId) && !l.includes(date) && !l.includes(invoiceId)).join(" ").trim() : "-";
                let memo = "-";
                if (amountIdx !== -1) {
                    let end = salesIdx !== -1 ? salesIdx : lines.length;
                    if (amountIdx + 1 < end) { memo = lines.slice(amountIdx + 1, end).filter(l => l !== "1/2" && l !== "1/1").join(" ").trim(); }
                }
                if (!memo) memo = "-";
                let breakdown = { cash: 0, credit: 0, credit_ar: 0, transfer_lpm: 0, transfer_fiscal: 0, transfer_scb: 0 };
                const ctx = (memo + " " + customerName).toLowerCase();
                const isCheewi = block.includes("ชีวี") || block.includes("Cheewi") || block.includes("ลูกหนี้");
                const isExplicitLPM = ctx.includes("lpm") || ctx.includes("lqm");
                const isFiscal = block.includes("1/2");

                if (isCheewi) breakdown.credit_ar = amountVal;
                else if (isExplicitLPM) breakdown.transfer_lpm = amountVal;
                else if (isFiscal) breakdown.transfer_fiscal = amountVal;
                else if (ctx.includes("scb415") || ctx.includes("415") || ctx.includes("scb")) breakdown.transfer_scb = amountVal;
                else if (ctx.includes("visa") || ctx.includes("credit") || ctx.includes("บัตรเครดิต") || ctx.includes("mc") || ctx.includes("vsa")) breakdown.credit = amountVal;
                else if (ctx.includes("โอน")) breakdown.transfer_lpm = amountVal;
                else breakdown.cash = amountVal;

                // Keep the initial check but ensure post-process integrity
                // if (orderId !== "-" && processedIds.has(orderId)) return;
                // if (orderId !== "-") processedIds.add(orderId);

                allData.push({ id: String(Date.now() + index + Math.random()), orderId, date, invoiceId, customerName, amountVal, amountStr, memo, salesperson, breakdown, saleType, isFlagged: false, isExcluded: false });
            });

            // Post-Process Deduplication (Final Safety Net)
            const uniqueMap = new Map();
            allData.forEach(item => {
                if (item.orderId === "-") {
                    uniqueMap.set(item.id, item); // Keep items without orderId
                } else {
                    if (!uniqueMap.has(item.orderId)) uniqueMap.set(item.orderId, item);
                }
            });
            allData = Array.from(uniqueMap.values());

            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            refreshData();
            filterCustomers(); // Auto update customer tab
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) { parseAndImportCSV(e.target.result); event.target.value = ''; };
            reader.readAsText(file);
        }

        function parseAndImportCSV(csvText) {
            try {
                resetUI();
                const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== "");
                if (lines.length < 2) { showToast("ไฟล์ CSV ไม่ถูกต้อง", "error"); return; }
                let importedCount = 0;
                // ... (rest is same, but let's just make sure we deduplicate here too)
                const parseLine = (str) => {
                    const arr = []; let q = false, col = '';
                    for (let c of str) { if (c === '"') { q = !q; continue; } if (c === ',' && !q) { arr.push(col); col = ''; continue; } col += c; } arr.push(col); return arr;
                };
                for (let i = 1; i < lines.length; i++) {
                    const cols = parseLine(lines[i]);
                    if (cols.length < 15) continue;
                    let breakdown = { cash: parseFloat(cols[7]) || 0, transfer_lpm: parseFloat(cols[8]) || 0, transfer_fiscal: parseFloat(cols[9]) || 0, transfer_scb: parseFloat(cols[10]) || 0, credit: parseFloat(cols[11]) || 0, credit_ar: parseFloat(cols[12]) || 0 };
                    allData.push({ id: (Date.now() + i + Math.random()).toString(), orderId: cols[1], saleType: cols[2], date: cols[3], invoiceId: cols[4], customerName: cols[5], amountStr: cols[6], amountVal: parseFloat(cols[6].replace(/,/g, '')), breakdown: breakdown, memo: cols[13], salesperson: cols[14], isFlagged: false, isExcluded: false });
                    importedCount++;
                }

                // Post-Process Deduplication for CSV
                const uniqueMap = new Map();
                allData.forEach(item => {
                    if (item.orderId === "-") uniqueMap.set(item.id, item);
                    else if (!uniqueMap.has(item.orderId)) uniqueMap.set(item.orderId, item);
                });
                allData = Array.from(uniqueMap.values());
                importedCount = allData.length;

                if (importedCount > 0) {
                    document.getElementById('resultSection').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                    refreshData();
                    filterCustomers(); // Auto update customer tab
                    showToast(`นำเข้าสำเร็จ ${importedCount} รายการ (Unique)`);
                } else { showToast("ไม่พบข้อมูล", "error"); }
            } catch (e) { showToast("Import Error", "error"); }
        }

        function saveProject() {
            if (allData.length === 0) { showToast("ไม่มีข้อมูลให้บันทึก", "error"); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
            const link = document.createElement("a"); link.href = dataStr; link.download = `sales_project_${new Date().toISOString().slice(0, 10)}.json`; link.click();
            showToast("บันทึกโปรเจกต์เรียบร้อย");
        }

        function handleJsonSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const rawData = JSON.parse(e.target.result);
                    resetUI();
                    allData = rawData.map((r, index) => {
                        let bd = r.breakdown || { cash: 0, credit: 0, credit_ar: 0, transfer_lpm: 0, transfer_fiscal: 0, transfer_scb: 0 };
                        bd.cash = parseFloat(bd.cash) || 0;
                        bd.credit = parseFloat(bd.credit) || 0;
                        bd.credit_ar = parseFloat(bd.credit_ar) || 0;
                        bd.transfer_lpm = parseFloat(bd.transfer_lpm) || 0;
                        bd.transfer_fiscal = parseFloat(bd.transfer_fiscal) || 0;
                        bd.transfer_scb = parseFloat(bd.transfer_scb) || 0;
                        return {
                            ...r,
                            amountVal: parseFloat(r.amountVal) || 0,
                            date: r.date || "-",
                            breakdown: bd,
                            id: String(r.id || (Date.now() + index + Math.random())),
                            isFlagged: !!r.isFlagged,
                            isExcluded: !!r.isExcluded
                        };
                    });
                    document.getElementById('resultSection').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                    refreshData();
                    filterCustomers(); // Auto update customer tab
                    showToast("โหลดโปรเจกต์สำเร็จ");
                } catch (error) {
                    showToast("ไฟล์ JSON ผิดพลาด", "error");
                    console.error(error);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- 5. RENDER & UPDATE ---
        function refreshData() {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            let res = allData;

            if (q) res = res.filter(r => r.orderId.toLowerCase().includes(q) || r.customerName.toLowerCase().includes(q) || r.salesperson.toLowerCase().includes(q) || r.amountStr.includes(q));

            // POCKET LOGIC V136.22
            if (activeTab === 'pocket') {
                res = res.filter(r => r.isExcluded); // Show ONLY hidden
                document.getElementById('pocketActionBar').classList.remove('hidden');
            } else {
                document.getElementById('pocketActionBar').classList.add('hidden');
                res = res.filter(r => !r.isExcluded); // Show active

                // Normal Filters
                if (activeTab !== 'all') {
                    if (['wholesale', 'retail'].includes(activeTab)) res = res.filter(r => r.saleType.toLowerCase() === activeTab);
                    else {
                        res = res.filter(r => {
                            let b = r.breakdown;
                            if (activeTab === 'cash') return b.cash > 0;
                            if (activeTab === 'lpm') return b.transfer_lpm > 0;
                            if (activeTab === 'fiscal') return b.transfer_fiscal > 0;
                            if (activeTab === 'scb') return b.transfer_scb > 0;
                            if (activeTab === 'credit') return b.credit > 0;
                            if (activeTab === 'ar') return b.credit_ar > 0;
                            return false;
                        });
                    }
                }
            }

            if (sortDirection === 'asc') res.sort((a, b) => a.orderId.localeCompare(b.orderId));
            if (sortDirection === 'desc') res.sort((a, b) => b.orderId.localeCompare(a.orderId));

            filteredData = res;
            renderAll(q);
            updateBulkActionBar();

            // Sync Customer Tab if visible (V136.24)
            if (!document.getElementById('view-customer').classList.contains('hidden')) {
                filterCustomers();
            }
        }
        function handleSearch(e) { refreshData(); }

        function switchTab(t) {
            activeTab = t;
            refreshData();
        }

        function renderAll(q = "") {
            try {
                // IMPORTANT: Use unique variable names to avoid shadowing
                let totalRevenue = 0, tw = 0, trt = 0, tc = 0, tlp = 0, tf = 0, ts = 0, tcr = 0, tar = 0;
                let cw = 0, cr = 0, c_cash = 0, c_credit = 0, c_trans = 0, c_lpm = 0, c_fiscal = 0, c_scb = 0, c_ar = 0;
                let staffStats = {};
                let g_w = 0, g_r = 0, g_c = 0, g_l = 0, g_f = 0, g_s = 0, g_cred = 0, g_ar = 0;
                let ga_w = 0, ga_r = 0, ga_c = 0, ga_l = 0, ga_f = 0, ga_s = 0, ga_cred = 0, ga_ar = 0;
                let actualGlobalTotal = 0;

                // Calculate POCKET and FLAG counts
                let pocketCount = 0;
                let pocketTotal = 0;
                let flagCount = 0;

                allData.forEach(r => {
                    if (r.isExcluded) {
                        pocketCount++;
                        pocketTotal += r.amountVal;
                    }
                    if (r.isFlagged) {
                        flagCount++;
                    }

                    if (!r.isExcluded) {
                        actualGlobalTotal += r.amountVal;
                        if (r.saleType === "Wholesale") { g_w++; ga_w += r.amountVal; }
                        if (r.saleType === "Retail") { g_r++; ga_r += r.amountVal; }
                        if (r.breakdown.cash > 0) { g_c++; ga_c += r.breakdown.cash; }
                        if (r.breakdown.transfer_lpm > 0) { g_l++; ga_l += r.breakdown.transfer_lpm; }
                        if (r.breakdown.transfer_fiscal > 0) { g_f++; ga_f += r.breakdown.transfer_fiscal; }
                        if (r.breakdown.transfer_scb > 0) { g_s++; ga_s += r.breakdown.transfer_scb; }
                        if (r.breakdown.credit > 0) { g_cred++; ga_cred += r.breakdown.credit; }
                        if (r.breakdown.credit_ar > 0) { g_ar++; ga_ar += r.breakdown.credit_ar; }
                    }
                });

                // Update Flag Counter UI
                const flagContainer = document.getElementById('flagCounterContainer');
                if (flagCount > 0) {
                    flagContainer.classList.remove('hidden');
                    flagContainer.classList.add('flex');
                    document.getElementById('flagCountValue').innerText = flagCount;
                } else {
                    flagContainer.classList.add('hidden');
                    flagContainer.classList.remove('flex');
                }

                // Update Pocket Tab UI (Auto Hide)
                const pocketTab = document.getElementById('tab-pocket');
                // Variable name 'btnPocket' used later for style
                const btnPocket = document.getElementById('tab-pocket');

                if (pocketCount > 0) {
                    pocketTab.classList.remove('hidden');
                    pocketTab.classList.add('flex');
                    document.getElementById('count-pocket').innerText = `(${pocketCount})`;
                    document.getElementById('amt-pocket').innerText = isPrivacyMode ? "Hidden" : pocketTotal.toLocaleString('en-US', { minimumFractionDigits: 2 });
                } else {
                    pocketTab.classList.add('hidden');
                    pocketTab.classList.remove('flex');
                    // Force switch if currently on empty pocket
                    if (activeTab === 'pocket') {
                        setTimeout(() => switchTab('all'), 0);
                        return; // Stop render to let switchTab re-render
                    }
                }

                let w_cash = 0, w_credit = 0, w_trans = 0, w_ar = 0;
                let r_cash = 0, r_credit = 0, r_trans = 0, r_ar = 0;

                filteredData.forEach(r => {
                    // Logic Loop
                    const v = r.amountVal;
                    totalRevenue += v; // Fixed variable name

                    const transSum = r.breakdown.transfer_lpm + r.breakdown.transfer_fiscal + r.breakdown.transfer_scb;
                    if (r.saleType === 'Wholesale') {
                        tw += v; cw++;
                        w_cash += r.breakdown.cash; w_credit += r.breakdown.credit; w_trans += transSum; w_ar += r.breakdown.credit_ar;
                    } else {
                        trt += v; cr++;
                        r_cash += r.breakdown.cash; r_credit += r.breakdown.credit; r_trans += transSum; r_ar += r.breakdown.credit_ar;
                    }

                    tc += r.breakdown.cash; tlp += r.breakdown.transfer_lpm; tf += r.breakdown.transfer_fiscal;
                    ts += r.breakdown.transfer_scb; tcr += r.breakdown.credit; tar += r.breakdown.credit_ar;

                    if (r.breakdown.cash > 0) c_cash++;
                    if (r.breakdown.transfer_lpm > 0) { c_lpm++; c_trans++; }
                    if (r.breakdown.transfer_fiscal > 0) { c_fiscal++; c_trans++; }
                    if (r.breakdown.transfer_scb > 0) { c_scb++; c_trans++; }
                    if (r.breakdown.credit > 0) c_credit++;
                    if (r.breakdown.credit_ar > 0) c_ar++;

                    if (r.salesperson !== "-") {
                        if (!staffStats[r.salesperson]) staffStats[r.salesperson] = {
                            total: 0,
                            retailCount: 0, retailTotal: 0,
                            wholesaleCount: 0, wholesaleTotal: 0,
                            // Restored Breakdown from V136.20
                            breakdown: { cash: 0, cashC: 0, lpm: 0, lpmC: 0, fiscal: 0, fiscalC: 0, scb: 0, scbC: 0, credit: 0, creditC: 0, ar: 0, arC: 0 }
                        };
                        let st = staffStats[r.salesperson];
                        st.total += v;

                        if (r.saleType === 'Retail') {
                            st.retailCount++;
                            st.retailTotal += v;
                        } else if (r.saleType === 'Wholesale') {
                            st.wholesaleCount++;
                            st.wholesaleTotal += v;
                        }

                        // Breakdown Accumulation
                        if (r.breakdown.cash > 0) { st.breakdown.cash += r.breakdown.cash; st.breakdown.cashC++; }
                        if (r.breakdown.transfer_lpm > 0) { st.breakdown.lpm += r.breakdown.transfer_lpm; st.breakdown.lpmC++; }
                        if (r.breakdown.transfer_fiscal > 0) { st.breakdown.fiscal += r.breakdown.transfer_fiscal; st.breakdown.fiscalC++; }
                        if (r.breakdown.transfer_scb > 0) { st.breakdown.scb += r.breakdown.transfer_scb; st.breakdown.scbC++; }
                        if (r.breakdown.credit > 0) { st.breakdown.credit += r.breakdown.credit; st.breakdown.creditC++; }
                        if (r.breakdown.credit_ar > 0) { st.breakdown.ar += r.breakdown.credit_ar; st.breakdown.arC++; }
                    }
                });

                updateDateRange(filteredData);
                const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; }
                const safeSetWidth = (id, w) => { const el = document.getElementById(id); if (el) el.style.width = w; }
                const fmt = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const pct = (val, total) => total > 0 ? (val / total * 100).toFixed(1) + '%' : '0.0%';

                // Update Cards (With Detailed Bars Logic)
                if (isPrivacyMode) {
                    safeSetText('cardTotalRevenue', "100%");
                    safeSetText('cardTotalWholesale', pct(tw, totalRevenue));
                    safeSetText('cardTotalRetail', pct(trt, totalRevenue));
                    safeSetText('miniTotalTransfer', pct((tlp + tf + ts), totalRevenue));

                    safeSetText('cardTotalCount', "-");
                    safeSetText('pct-wholesale-total', "-"); safeSetText('pct-retail-total', "-"); safeSetText('pct-transfer', "-");

                    // FIXED: Complete Privacy Mode Setters
                    safeSetText('pct-t-cash', pct(tc, totalRevenue));
                    safeSetText('pct-t-credit', pct(tcr, totalRevenue));
                    safeSetText('pct-t-trans', pct((tlp + tf + ts), totalRevenue));
                    safeSetText('pct-t-ar', pct(tar, totalRevenue));

                    safeSetText('det-t-lpm', "-"); safeSetText('det-t-fiscal', "-"); safeSetText('det-t-scb', "-");

                    // Details
                    safeSetText('det-t-cash', pct(tc, totalRevenue));
                    safeSetText('det-t-credit', pct(tcr, totalRevenue));
                    safeSetText('det-t-trans', pct((tlp + tf + ts), totalRevenue));
                    safeSetText('det-t-ar', pct(tar, totalRevenue));

                    safeSetText('det-w-cash', pct(w_cash, totalRevenue));
                    safeSetText('det-w-trans', pct(w_trans, totalRevenue));
                    safeSetText('det-w-credit', pct(w_credit, totalRevenue));

                    safeSetText('det-r-cash', pct(r_cash, totalRevenue));
                    safeSetText('det-r-trans', pct(r_trans, totalRevenue));
                    safeSetText('det-r-credit', pct(r_credit, totalRevenue));
                } else {
                    safeSetText('cardTotalRevenue', fmt(totalRevenue));
                    safeSetText('cardTotalWholesale', fmt(tw));
                    safeSetText('cardTotalRetail', fmt(trt));
                    safeSetText('miniTotalTransfer', fmt(tlp + tf + ts));

                    safeSetText('cardTotalCount', filteredData.filter(r => activeTab === 'pocket' ? r.isExcluded : !r.isExcluded).length + " บิล");
                    safeSetText('cardCountWholesale', cw + " บิล");
                    safeSetText('cardCountRetail', cr + " บิล");

                    safeSetText('pct-wholesale-total', pct(tw, totalRevenue));
                    safeSetText('pct-retail-total', pct(trt, totalRevenue));
                    safeSetText('pct-transfer', pct((tlp + tf + ts), totalRevenue));

                    safeSetText('pct-t-cash', pct(tc, totalRevenue));
                    safeSetText('pct-t-credit', pct(tcr, totalRevenue));
                    safeSetText('pct-t-trans', pct((tlp + tf + ts), totalRevenue));
                    safeSetText('pct-t-ar', pct(tar, totalRevenue));

                    safeSetText('det-t-cash', fmt(tc));
                    safeSetText('det-t-credit', fmt(tcr));
                    safeSetText('det-t-trans', fmt(tlp + tf + ts));
                    safeSetText('det-t-ar', fmt(tar));

                    safeSetText('det-w-cash', fmt(w_cash)); safeSetText('det-w-trans', fmt(w_trans)); safeSetText('det-w-credit', fmt(w_credit));
                    safeSetText('det-r-cash', fmt(r_cash)); safeSetText('det-r-trans', fmt(r_trans)); safeSetText('det-r-credit', fmt(r_credit));
                    safeSetText('det-t-lpm', fmt(tlp));
                    safeSetText('det-t-fiscal', fmt(tf)); safeSetText('det-t-scb', fmt(ts));
                }

                const updateStacked = (prefix, valCash, valCredit, valTrans, valAR, total) => {
                    safeSetWidth(`bar-${prefix}-cash`, pct(valCash, total));
                    safeSetWidth(`bar-${prefix}-credit`, pct(valCredit, total));
                    safeSetWidth(`bar-${prefix}-trans`, pct(valTrans, total));
                    safeSetWidth(`bar-${prefix}-ar`, pct(valAR, total));
                };

                updateStacked('t', tc, tcr, (tlp + tf + ts), tar, totalRevenue);
                updateStacked('w', w_cash, w_credit, w_trans, w_ar, tw);
                updateStacked('r', r_cash, r_credit, r_trans, r_ar, trt);

                safeSetWidth('prog-transfer', pct((tlp + tf + ts), totalRevenue));

                const tabList = [
                    { id: 'all', color: 'text-brand-600 dark:text-brand-400' },
                    { id: 'wholesale', color: 'text-slate-500 dark:text-slate-400' },
                    { id: 'retail', color: 'text-slate-500 dark:text-slate-400' },
                    { id: 'cash', color: 'text-orange-600 dark:text-orange-400' },
                    { id: 'lpm', color: 'text-cyan-600 dark:text-cyan-400' },
                    { id: 'fiscal', color: 'text-blue-600 dark:text-blue-400' },
                    { id: 'scb', color: 'text-indigo-600 dark:text-indigo-400' },
                    { id: 'credit', color: 'text-purple-600 dark:text-purple-400' },
                    { id: 'ar', color: 'text-teal-600 dark:text-teal-400' }
                ];
                tabList.forEach(t => {
                    let cnt = 0;
                    if (t.id === 'all') cnt = allData.filter(r => !r.isExcluded).length;
                    else if (t.id === 'wholesale') cnt = g_w;
                    else if (t.id === 'retail') cnt = g_r;
                    else if (t.id === 'cash') cnt = g_c;
                    else if (t.id === 'lpm') cnt = g_l;
                    else if (t.id === 'fiscal') cnt = g_f;
                    else if (t.id === 'scb') cnt = g_s;
                    else if (t.id === 'credit') cnt = g_cred;
                    else if (t.id === 'ar') cnt = g_ar;

                    const btn = document.getElementById(`tab-${t.id}`);
                    if (btn) {
                        if (t.id === activeTab) {
                            btn.className = "tab-btn tab-active";
                        } else {
                            btn.className = `tab-btn tab-inactive ${t.color}`;
                        }
                    }

                    const el = document.getElementById(`count-${t.id}`);
                    if (el) el.innerText = isPrivacyMode ? "" : `(${cnt})`;

                    const amtEl = document.getElementById(`amt-${t.id}`);
                    if (amtEl) {
                        let val = 0;
                        if (t.id === 'all') val = actualGlobalTotal;
                        else if (t.id === 'wholesale') val = ga_w;
                        else if (t.id === 'retail') val = ga_r;
                        else if (t.id === 'cash') val = ga_c;
                        else if (t.id === 'lpm') val = ga_l;
                        else if (t.id === 'fiscal') val = ga_f;
                        else if (t.id === 'scb') val = ga_s;
                        else if (t.id === 'credit') val = ga_cred;
                        else if (t.id === 'ar') val = ga_ar;

                        amtEl.innerText = isPrivacyMode ? pct(val, actualGlobalTotal) : fmt(val);
                    }
                });

                if (btnPocket) {
                    if (activeTab === 'pocket') {
                        btnPocket.className = "tab-btn tab-active ml-auto flex-none w-[100px]";
                    } else {
                        btnPocket.className = "tab-btn tab-inactive bg-slate-100 dark:bg-slate-900 ml-auto flex-none w-[100px]";
                    }
                }

                // **CRITICAL FIX V136.19: Renamed table row variable to rowEl to avoid conflict with tr**
                const tbody = document.getElementById('resultTableBody');
                tbody.innerHTML = '';
                filteredData.forEach((row, i) => {
                    const rowEl = document.createElement('tr');
                    rowEl.className = row.isExcluded ? 'row-excluded border-b border-slate-100 dark:border-slate-700' : 'hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors border-b border-slate-50 dark:border-slate-700';
                    if (row.isFlagged) rowEl.className += ' bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400';
                    if (selectedIds.has(row.id)) rowEl.className += ' bg-indigo-50 dark:bg-indigo-900/30';

                    let icons = "";
                    if (row.breakdown.cash > 0) icons += '<i class="ph-fill ph-money text-orange-500"></i>';
                    if (row.breakdown.transfer_lpm > 0) icons += '<span class="text-[10px] font-bold bg-cyan-100 text-cyan-700 dark:bg-cyan-900 dark:text-cyan-300 px-1 rounded">LPM</span>';
                    if (row.breakdown.transfer_fiscal > 0) icons += '<span class="text-[10px] font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-1 rounded">Fisc</span>';
                    if (row.breakdown.transfer_scb > 0) icons += '<span class="text-[10px] font-bold bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 px-1 rounded">SCB</span>';
                    if (row.breakdown.credit > 0) icons += '<i class="ph-fill ph-credit-card text-purple-500"></i>';
                    if (row.breakdown.credit_ar > 0) icons += '<i class="ph-fill ph-user-list text-teal-600"></i>';

                    let displayAmount = isPrivacyMode ? pct(row.amountVal, totalRevenue) : highlightText(row.amountStr, q);
                    let displayName = isPrivacyMode ? maskCustomerName(row.customerName) : highlightText(row.customerName, q);
                    const transferBtn = `<div class="opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 dark:bg-slate-800/90 shadow-sm rounded-full"><button onclick="openTransferModal('${row.id}')" class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900 rounded-full transition-colors no-strike" title="ย้ายยอดด่วน"><i class="ph-bold ph-arrows-left-right"></i></button></div>`;

                    let hideAction = "";
                    if (row.isExcluded) {
                        // In Pocket: Show Restore (No strike class applied to button itself)
                        hideAction = `<button onclick="toggleExclude('${row.id}')" class="text-emerald-500 hover:text-emerald-600 p-1 no-strike" title="คืนรายการ (Restore)"><i class="ph-bold ph-arrow-u-up-left"></i></button>`;
                    } else {
                        // Normal: Show Hide
                        hideAction = `<button onclick="toggleExclude('${row.id}')" class="text-slate-300 hover:text-blue-500 p-1" title="ซ่อน (Hide)"><i class="ph-bold ph-eye"></i></button>`;
                    }

                    rowEl.innerHTML = `
                        <td class="px-4 py-3 text-center w-[40px]"><input type="checkbox" class="custom-checkbox row-checkbox" value="${row.id}" onchange="toggleSelect('${row.id}')" ${selectedIds.has(row.id) ? 'checked' : ''}></td>
                        <td class="px-4 py-3 text-center text-slate-400 dark:text-slate-500 text-xs font-mono">${i + 1}</td>
                        <td class="px-4 py-3 text-xs font-mono font-bold text-brand-600 dark:text-brand-400">${highlightText(row.orderId, q)}</td>
                        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400">${row.date}</td>
                        <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${highlightText(row.invoiceId, q)}</td>
                        <td class="px-4 py-3 text-sm dark:text-slate-300">${displayName}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-700 dark:text-slate-200 text-sm">${displayAmount}</td>
                        <td class="px-4 py-3 text-center relative group">${icons} ${transferBtn}</td>
                        <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400 max-w-[200px] truncate cursor-pointer hover:text-brand-600 dark:hover:text-brand-400 transition-colors" onclick="openEditModal('${row.id}')">${highlightText(row.memo, q)}</td>
                        <td class="px-4 py-3"><select onchange="updateSalesperson('${row.id}', this.value)" class="border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300 text-xs rounded p-1 w-full outline-none">${generateStaffOptions(row.salesperson)}</select></td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-1">
                                ${hideAction}
                                <button onclick="toggleFlag('${row.id}')" class="${row.isFlagged ?
                            'text-yellow-500' : 'text-slate-300 hover:text-yellow-500'} p-1"><i class="ph-fill ph-flag"></i></button>
                                <button onclick="openEditModal('${row.id}')" class="text-slate-300 hover:text-brand-600 p-1"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button onclick="deleteRow('${row.id}')" class="text-slate-300 hover:text-red-500 p-1"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(rowEl);
                });

                renderChart(staffStats); // Original Chart
                renderRetailChart(filteredData); // New Retail Chart
                renderWholesaleChart(filteredData); // New Wholesale Chart
                renderStaffTable(staffStats, totalRevenue);
            } catch (error) {
                console.error("Render Error:", error);
                showToast("เกิดข้อผิดพลาดในการแสดงผล", "error");
            }
        }

        // --- 6. CHART RENDERING (FIXED) ---
        function renderChart(staffStats) {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            if (myChart) { myChart.destroy(); myChart = null; }

            const labels = Object.keys(staffStats);
            const data = labels.map(k => staffStats[k].total);

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขาย',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 6.1 NEW RETAIL CHART ---
        function renderRetailChart(data) {
            const ctx = document.getElementById('retailChart');
            if (!ctx) return;
            if (retailChart) { retailChart.destroy(); }

            const retailData = data.filter(d => d.saleType === 'Retail' && !d.isExcluded).sort((a, b) => a.orderId.localeCompare(b.orderId));
            const labels = retailData.map(d => d.orderId.split('-').pop()); // Just last part of ID for cleaner X-axis
            const values = retailData.map(d => d.amountVal);

            retailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขายปลีก',
                        data: values,
                        backgroundColor: '#10b981', // Emerald
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false } }, // Hide X labels if too many
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 6.2 NEW WHOLESALE CHART ---
        function renderWholesaleChart(data) {
            const ctx = document.getElementById('wholesaleChart');
            if (!ctx) return;
            if (wholesaleChart) { wholesaleChart.destroy(); }

            const wsData = data.filter(d => d.saleType === 'Wholesale' && !d.isExcluded).sort((a, b) => a.orderId.localeCompare(b.orderId));
            const labels = wsData.map(d => d.orderId.split('-').pop());
            const values = wsData.map(d => d.amountVal);

            wholesaleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขายส่ง',
                        data: values,
                        backgroundColor: '#6366f1', // Indigo
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 7. STAFF TABLE RENDER (Updated V136.22) ---
        function renderStaffTable(stats, totalRevenue) {
            // 7.1 Render Top Ranking (With Details)
            const tbodyRank = document.getElementById('staffTableBody');
            tbodyRank.innerHTML = '';
            const sorted = Object.keys(stats).map(k => ({ name: k, ...stats[k] })).sort((a, b) => b.total - a.total);

            sorted.forEach((item, i) => {
                let displayValue = isPrivacyMode ? (totalRevenue > 0 ? (item.total / totalRevenue * 100).toFixed(2) + '%' : '0.00%') : item.total.toLocaleString(undefined, { minimumFractionDigits: 2 });

                // Detail HTML Logic (Restored from V136.20)
                let detailHtml = "";
                if (!isPrivacyMode) {
                    const bd = item.breakdown;
                    const line = (lbl, v, c) => v > 0 ? `<div class="flex justify-between text-[11px] py-0.5"><span class="text-slate-500 dark:text-slate-400">${lbl}:</span> <span class="font-medium text-slate-700 dark:text-slate-300">${v.toLocaleString()} (${c} บิล)</span></div>` : "";
                    const sub = (lbl, v, c) => v > 0 ? `<div class="flex justify-between text-[10px] py-0.5 pl-3 border-l border-slate-200 dark:border-slate-600"><span class="text-slate-400 dark:text-slate-500">-> ${lbl}:</span> <span class="font-medium text-slate-600 dark:text-slate-400">${v.toLocaleString()} (${c} บิล)</span></div>` : "";
                    detailHtml = `<div class="p-3 bg-slate-50/50 dark:bg-slate-900/50 rounded-lg border border-slate-100 dark:border-slate-700 shadow-inner mt-2 space-y-0.5">${line("เงินสด", bd.cash, bd.cashC)}${line("บัตรเครดิต", bd.credit, bd.creditC)}${line("บัญชีธนาคาร", bd.lpm + bd.fiscal + bd.scb, bd.lpmC + bd.fiscalC + bd.scbC)}${sub("LPM", bd.lpm, bd.lpmC)}${sub("Fiscal", bd.fiscal, bd.fiscalC)}${sub("SCB", bd.scb, bd.scbC)}${line("ลูกหนี้", bd.ar, bd.arC)}</div>`;
                } else {
                    detailHtml = `<div class="p-3 bg-slate-50 dark:bg-slate-900/50 text-center text-xs text-slate-400 italic">ซ่อนรายละเอียด</div>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2.5 text-xs text-slate-700 dark:text-slate-300">
                         <div class="flex items-center gap-2 cursor-pointer group" onclick="toggleStaffDetail('staff-row-${i}')">
                            <span class="font-medium group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors">${i + 1}. ${item.name.replace("STAFF", "").trim()}</span>
                            <i class="ph-bold ph-caret-down text-slate-300 group-hover:text-brand-500 ml-auto transition-transform" id="icon-staff-row-${i}"></i>
                        </div>
                    </td>
                    <td class="px-4 py-2.5 text-right text-xs font-bold text-slate-700 dark:text-slate-200">${displayValue}</td>
                `;
                tbodyRank.appendChild(tr);

                // Hidden Detail Row
                const trDetail = document.createElement('tr');
                trDetail.id = `staff-row-${i}`;
                trDetail.className = "hidden bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700 animate-slide-up";
                trDetail.innerHTML = `<td colspan="2" class="px-4 pb-3 pt-0 border-none">${detailHtml}</td>`;
                tbodyRank.appendChild(trDetail);
            });

            // 7.2 Render Performance Stats (New Table)
            const tbodyStats = document.getElementById('staffStatsBody');
            tbodyStats.innerHTML = '';
            sorted.forEach(item => {
                const retailAvg = item.retailCount > 0 ? (item.retailTotal / item.retailCount) : 0;
                const wholesaleAvg = item.wholesaleCount > 0 ? (item.wholesaleTotal / item.wholesaleCount) : 0;

                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 dark:border-slate-700";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-xs font-bold text-slate-600 dark:text-slate-300">${item.name.replace("STAFF", "").trim()}</td>
                    <td class="px-4 py-2 text-right text-xs text-emerald-600">${item.retailCount}</td>
                    <td class="px-4 py-2 text-right text-xs text-slate-500">${isPrivacyMode ? '-' : retailAvg.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                    <td class="px-4 py-2 text-right text-xs text-indigo-600">${item.wholesaleCount}</td>
                    <td class="px-4 py-2 text-right text-xs text-slate-500">${isPrivacyMode ? '-' : wholesaleAvg.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                `;
                tbodyStats.appendChild(tr);
            });
        }

        function toggleStaffDetail(id) {
            const el = document.getElementById(id); const icon = document.getElementById(`icon-${id}`);
            if (el.classList.contains('hidden')) { el.classList.remove('hidden'); icon.style.transform = 'rotate(180deg)'; }
            else { el.classList.add('hidden'); icon.style.transform = 'rotate(0deg)'; }
        }

        // --- 8. ACTION FUNCTIONS ---
        function toggleExclude(id) {
            const row = allData.find(r => r.id === id);
            if (row) {
                row.isExcluded = !row.isExcluded;
                refreshData();
                showToast(row.isExcluded ? "ย้ายไป Pocket แล้ว" : "คืนรายการแล้ว");
            }
        }
        function toggleFlag(id) {
            const row = allData.find(r => r.id === id);
            if (row) {
                row.isFlagged = !row.isFlagged;
                refreshData();
            }
        }

        function clearAllFlags() {
            if (confirm('ต้องการล้าง Highlight ทั้งหมดใช่หรือไม่?')) {
                let count = 0;
                allData.forEach(r => {
                    if (r.isFlagged) {
                        r.isFlagged = false;
                        count++;
                    }
                });
                refreshData();
                showToast(`ล้าง Highlight ${count} รายการแล้ว`);
            }
        }

        function restoreAllPocket() {
            if (confirm('ยืนยันคืนบิลทั้งหมดจาก Pocket กลับสู่รายการหลัก?')) {
                let count = 0;
                allData.forEach(r => {
                    if (r.isExcluded) {
                        r.isExcluded = false;
                        count++;
                    }
                });
                refreshData();
                showToast(`คืนรายการ ${count} รายการเรียบร้อย`);
            }
        }

        function deleteRow(id) {
            if (confirm('ลบรายการนี้?')) {
                allData = allData.filter(r => r.id !== id);
                selectedIds.delete(id);
                refreshData();
                showToast('ลบรายการแล้ว');
            }
        }
        function toggleSelect(id) {
            if (selectedIds.has(id)) { selectedIds.delete(id); } else { selectedIds.add(id); }
            updateBulkActionBar();
            refreshData();
        }
        function toggleSelectAll(checkbox) {
            if (checkbox.checked) { filteredData.forEach(r => selectedIds.add(r.id)); } else { selectedIds.clear(); }
            updateBulkActionBar();
            refreshData();
        }
        function removeNoTaxItems() {
            const before = allData.length;
            allData = allData.filter(r => r.invoiceId && r.invoiceId !== '-');
            const removed = before - allData.length;
            if (removed > 0) {
                refreshData();
                showToast(`ลบรายการที่ไม่มีภาษี ${removed} รายการ`);
            } else {
                showToast('ไม่พบรายการที่ไม่มีภาษี', 'error');
            }
        }

        // --- 9. MODAL FUNCTIONS (EDIT & TRANSFER) ---
        function openEditModal(id) {
            currentEditId = id;
            const row = allData.find(r => r.id === id);
            if (!row) return;

            document.getElementById('modalRowId').value = id;
            document.getElementById('inputMemo').value = row.memo;
            document.getElementById('inputTotalAmount').value = row.amountVal;

            document.getElementById('inputCash').value = row.breakdown.cash;
            document.getElementById('inputCredit').value = row.breakdown.credit;
            document.getElementById('inputCreditAR').value = row.breakdown.credit_ar;
            document.getElementById('inputTransferLPM').value = row.breakdown.transfer_lpm;
            document.getElementById('inputTransferFiscal').value = row.breakdown.transfer_fiscal;
            document.getElementById('inputTransferSCB').value = row.breakdown.transfer_scb;

            const returnInputs = ['inputReturnCash', 'inputReturnCredit', 'inputReturnAR', 'inputReturnLPM', 'inputReturnFiscal', 'inputReturnSCB'];
            returnInputs.forEach(id => document.getElementById(id).value = '');

            document.getElementById('editModal').classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }

        function calculateNetTotal() {
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;

            const cash = getVal('inputCash') - getVal('inputReturnCash');
            const credit = getVal('inputCredit') - getVal('inputReturnCredit');
            const ar = getVal('inputCreditAR') - getVal('inputReturnAR');
            const lpm = getVal('inputTransferLPM') - getVal('inputReturnLPM');
            const fiscal = getVal('inputTransferFiscal') - getVal('inputReturnFiscal');
            const scb = getVal('inputTransferSCB') - getVal('inputReturnSCB');

            const total = cash + credit + ar + lpm + fiscal + scb;

            document.getElementById('inputTotalAmount').value = total.toFixed(2);
        }

        function saveData() {
            const id = document.getElementById('modalRowId').value;
            const row = allData.find(r => r.id === id);
            if (!row) return;

            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;

            const netCash = getVal('inputCash') - getVal('inputReturnCash');
            const netCredit = getVal('inputCredit') - getVal('inputReturnCredit');
            const netAR = getVal('inputCreditAR') - getVal('inputReturnAR');
            const netLPM = getVal('inputTransferLPM') - getVal('inputReturnLPM');
            const netFiscal = getVal('inputTransferFiscal') - getVal('inputReturnFiscal');
            const netSCB = getVal('inputTransferSCB') - getVal('inputReturnSCB');

            const totalNet = netCash + netCredit + netAR + netLPM + netFiscal + netSCB;

            row.memo = document.getElementById('inputMemo').value;
            row.amountVal = totalNet;
            row.amountStr = totalNet.toFixed(2);

            row.breakdown.cash = netCash;
            row.breakdown.credit = netCredit;
            row.breakdown.credit_ar = netAR;
            row.breakdown.transfer_lpm = netLPM;
            row.breakdown.transfer_fiscal = netFiscal;
            row.breakdown.transfer_scb = netSCB;

            closeModal();
            refreshData();
            showToast('บันทึกการเปลี่ยนแปลงแล้ว');
        }


        // --- 10. TRANSFER LOGIC ---
        function openTransferModal(id, isBulk = false) {
            currentTransferId = id;
            isBulkTransfer = isBulk;

            if (isBulk) {
                document.getElementById('transferModalTitle').innerText = 'ย้ายยอดเงินหลายรายการ';
                document.getElementById('transferModalDesc').innerText = `กำลังย้าย ${selectedIds.size} รายการ`;
            } else {
                const row = allData.find(r => r.id === id);
                document.getElementById('transferModalTitle').innerText = 'ย้ายยอดเงินด่วน';
                document.getElementById('transferModalDesc').innerText = `${row.orderId} - ${row.amountStr} บาท`;
            }
            document.getElementById('transferModal').classList.remove('hidden');
        }
        function closeTransferModal() {
            document.getElementById('transferModal').classList.add('hidden');
            currentTransferId = null;
            isBulkTransfer = false;
        }
        function executeTransfer(paymentType) {
            const targetRows = isBulkTransfer ? allData.filter(r => selectedIds.has(r.id)) : [allData.find(r => r.id === currentTransferId)];
            targetRows.forEach(row => {
                if (!row) return;
                row.breakdown = { cash: 0, credit: 0, credit_ar: 0, transfer_lpm: 0, transfer_fiscal: 0, transfer_scb: 0 };
                if (paymentType === 'cash') row.breakdown.cash = row.amountVal;
                else if (paymentType === 'credit') row.breakdown.credit = row.amountVal;
                else if (paymentType === 'lpm') row.breakdown.transfer_lpm = row.amountVal;
                else if (paymentType === 'fiscal') row.breakdown.transfer_fiscal = row.amountVal;
                else if (paymentType === 'scb') row.breakdown.transfer_scb = row.amountVal;
                else if (paymentType === 'ar') row.breakdown.credit_ar = row.amountVal;
            });
            closeTransferModal();
            refreshData();
            showToast(`ย้ายประเภทการชำระเงินแล้ว ${targetRows.length} รายการ`);
        }

        // --- 11. STAFF MANAGEMENT ---
        function updateSalesperson(id, newStaff) {
            const row = allData.find(r => r.id === id);
            if (row) { row.salesperson = newStaff; refreshData(); }
        }
        function openChangeStaffModal() {
            const select = document.getElementById('bulkStaffSelect');
            select.innerHTML = generateStaffOptions('-');
            document.getElementById('changeStaffModal').classList.remove('hidden');
        }
        function closeChangeStaffModal() {
            document.getElementById('changeStaffModal').classList.add('hidden');
        }
        function executeChangeStaff() {
            const newStaff = document.getElementById('bulkStaffSelect').value;
            selectedIds.forEach(id => {
                const row = allData.find(r => r.id === id);
                if (row) row.salesperson = newStaff;
            });
            closeChangeStaffModal();
            refreshData();
            showToast(`เปลี่ยนพนักงาน ${selectedIds.size} รายการแล้ว`);
        }

        // --- 12. CUSTOMER FILTER LOGIC (NEW V136.24: Auto-Load) ---
        function filterCustomers() {
            const minAmt = parseFloat(document.getElementById('cust-filter-min-amount').value) || 0;
            const chkRetail = document.getElementById('cust-filter-retail').checked;
            const chkWholesale = document.getElementById('cust-filter-wholesale').checked;

            const chkCash = document.getElementById('cust-filter-cash').checked;
            const chkCredit = document.getElementById('cust-filter-credit').checked;
            const chkTransfer = document.getElementById('cust-filter-transfer').checked;
            const chkAR = document.getElementById('cust-filter-ar').checked;

            const results = allData.filter(r => {
                if (r.isExcluded) return false;
                if (r.amountVal < minAmt) return false;

                let typeMatch = false;
                if (chkRetail && r.saleType === 'Retail') typeMatch = true;
                if (chkWholesale && r.saleType === 'Wholesale') typeMatch = true;
                if (!typeMatch) return false;

                let payMatch = false;
                const b = r.breakdown;
                if (!b) return false; // Safety

                if (chkCash && b.cash > 0) payMatch = true;
                if (chkCredit && b.credit > 0) payMatch = true;
                if (chkTransfer && (b.transfer_lpm > 0 || b.transfer_fiscal > 0 || b.transfer_scb > 0)) payMatch = true;
                if (chkAR && b.credit_ar > 0) payMatch = true;

                return payMatch;
            });

            renderCustomerResults(results);
        }

        function renderCustomerResults(data) {
            const tbody = document.getElementById('customerTableBody');
            const countBadge = document.getElementById('cust-result-count');

            countBadge.innerText = data.length;
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-slate-400">ไม่พบข้อมูลตามเงื่อนไข</td></tr>`;
                return;
            }

            const sortedData = [...data].sort((a, b) => b.amountVal - a.amountVal);

            sortedData.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700 border-b border-slate-50 dark:border-slate-700 transition-colors";
                if (row.isFlagged) tr.className += ' bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400';
                if (selectedIds.has(row.id)) tr.className += ' bg-indigo-50 dark:bg-indigo-900/30';

                let icons = "";
                if (row.breakdown.cash > 0) icons += '<i class="ph-fill ph-money text-orange-500"></i>';
                if (row.breakdown.transfer_lpm > 0) icons += '<span class="text-[10px] font-bold bg-cyan-100 text-cyan-700 dark:bg-cyan-900 dark:text-cyan-300 px-1 rounded">LPM</span>';
                if (row.breakdown.transfer_fiscal > 0) icons += '<span class="text-[10px] font-bold bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-1 rounded">Fisc</span>';
                if (row.breakdown.transfer_scb > 0) icons += '<span class="text-[10px] font-bold bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 px-1 rounded">SCB</span>';
                if (row.breakdown.credit > 0) icons += '<i class="ph-fill ph-credit-card text-purple-500"></i>';
                if (row.breakdown.credit_ar > 0) icons += '<i class="ph-fill ph-user-list text-teal-600"></i>';

                let displayAmount = isPrivacyMode ? "Hidden" : row.amountStr;
                let displayName = isPrivacyMode ? maskCustomerName(row.customerName) : row.customerName;

                const transferBtn = `<div class="opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 dark:bg-slate-800/90 shadow-sm rounded-full"><button onclick="openTransferModal('${row.id}')" class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900 rounded-full transition-colors no-strike" title="ย้ายยอดด่วน"><i class="ph-bold ph-arrows-left-right"></i></button></div>`;

                tr.innerHTML = `
                    <td class="px-4 py-3 text-center w-[40px]"><input type="checkbox" class="custom-checkbox row-checkbox" value="${row.id}" onchange="toggleSelect('${row.id}')" ${selectedIds.has(row.id) ? 'checked' : ''}></td>
                    <td class="px-4 py-3 text-center text-slate-400 dark:text-slate-500 text-xs font-mono">${i + 1}</td>
                    <td class="px-4 py-3 text-xs font-mono font-bold text-brand-600 dark:text-brand-400">${row.orderId}</td>
                    <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400">${row.date}</td>
                    <td class="px-4 py-3 text-xs font-mono text-slate-500 dark:text-slate-400">${row.invoiceId || '-'}</td>
                    <td class="px-4 py-3 text-sm dark:text-slate-300">${displayName}</td>
                    <td class="px-4 py-3 text-right font-bold text-slate-700 dark:text-slate-200 text-sm">${displayAmount}</td>
                    <td class="px-4 py-3 text-center relative group">${icons} ${transferBtn}</td>
                    <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400 max-w-[200px] truncate cursor-pointer hover:text-brand-600 dark:hover:text-brand-400 transition-colors" onclick="openEditModal('${row.id}')">${row.memo}</td>
                    <td class="px-4 py-3"><select onchange="updateSalesperson('${row.id}', this.value)" class="border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300 text-xs rounded p-1 w-full outline-none">${generateStaffOptions(row.salesperson)}</select></td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex justify-center gap-1">
                            <button onclick="toggleExclude('${row.id}')" class="text-slate-300 hover:text-blue-500 p-1"><i class="ph-bold ph-eye"></i></button>
                            <button onclick="toggleFlag('${row.id}')" class="${row.isFlagged ? 'text-yellow-500' : 'text-slate-300 hover:text-yellow-500'} p-1"><i class="ph-fill ph-flag"></i></button>
                            <button onclick="openEditModal('${row.id}')" class="text-slate-300 hover:text-brand-600 p-1"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deleteRow('${row.id}')" class="text-slate-300 hover:text-red-500 p-1"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 13. UTILS & EXPORT ---
        function copySummary() {
            const dateText = document.getElementById('summaryDateRange').innerText;

            // Recalculate from filteredData to ensure 100% accuracy with cards
            let total = 0, cash = 0, credit = 0, trans = 0, ar = 0;
            let c_total = 0, c_cash = 0, c_credit = 0, c_trans = 0, c_ar = 0;

            filteredData.forEach(r => {
                if (r.isExcluded) return;

                total += r.amountVal;
                c_total++;

                const b = r.breakdown;

                cash += b.cash;
                if (b.cash > 0) c_cash++;

                credit += b.credit;
                if (b.credit > 0) c_credit++;

                ar += b.credit_ar;
                if (b.credit_ar > 0) c_ar++;

                const t_val = b.transfer_lpm + b.transfer_fiscal + b.transfer_scb;
                trans += t_val;
                if (t_val > 0) c_trans++;
            });

            const fmt = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const pct = (val) => total > 0 ? (val / total * 100).toFixed(2) + ' %' : '0.00 %';

            let txt = `สรุปยอดขาย ${dateText}\n`;

            if (isPrivacyMode) {
                txt += `ยอดขายรวม 100.00%\n`;
                txt += `เงินสด ${pct(cash)}\n`;
                txt += `บัตรเครดิต ${pct(credit)}\n`;
                txt += `บัญชีธนาคาร ${pct(trans)}\n`;
                txt += `ลูกหนี้ ${pct(ar)}`;
            } else {
                txt += `ยอดขายรวม ${fmt(total)} (${c_total} บิล)\n`;
                txt += `เงินสด ${fmt(cash)} (${c_cash} บิล)\n`;
                txt += `บัตรเครดิต ${fmt(credit)} (${c_credit} บิล)\n`;
                txt += `บัญชีธนาคาร ${fmt(trans)} (${c_trans} บิล)\n`;
                txt += `ลูกหนี้ ${fmt(ar)} (${c_ar} บิล)`;
            }

            if (navigator.clipboard) {
                navigator.clipboard.writeText(txt).then(() => showToast("คัดลอกสรุปแล้ว")).catch(() => copyFallback(txt));
            } else {
                copyFallback(txt);
            }
        }

        function copyFallback(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast("คัดลอกสรุปแล้ว");
            } catch (err) {
                showToast("คัดลอกไม่สำเร็จ", "error");
            }
            document.body.removeChild(ta);
        }

        function clearAllData() {
            if (confirm('ล้างค่าทั้งหมด?')) {
                allData = [];
                filteredData = [];
                selectedIds = new Set();
                document.getElementById('inputData').value = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                if (myChart) { myChart.destroy(); myChart = null; }
                updateBulkActionBar();
                switchTab('all');
                switchMainTab('overview');
                showToast("ล้างข้อมูลเรียบร้อย");
            }
        }
    </script>
</body>

</html>